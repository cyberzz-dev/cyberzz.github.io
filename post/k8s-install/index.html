<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Kubernetes | cyberzz.dev</title>
<meta name="keywords" content="">
<meta name="description" content="install k8s">
<meta name="author" content="">
<link rel="canonical" href="https://cyberzz.dev/post/k8s-install/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.5c25c975546c048d1a5600aadb48425ae1bc921a9a18fe67d6955c9535260811.css" integrity="sha256-XCXJdVRsBI0aVgCq20hCWuG8khqaGP5n1pVclTUmCBE=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.acb54fd32bbc1982428b8850317e45d076b95012730a5936667e6bc21777692a.js" integrity="sha256-rLVP0yu8GYJCi4hQMX5F0Ha5UBJzClk2Zn5rwhd3aSo="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://cyberzz.dev/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://cyberzz.dev/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://cyberzz.dev/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://cyberzz.dev/apple-touch-icon.png">
<link rel="mask-icon" href="https://cyberzz.dev/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-8XMXD5ZSFE"></script>
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-8XMXD5ZSFE', { 'anonymize_ip': false });
}
</script>
<meta property="og:title" content="Kubernetes" />
<meta property="og:description" content="install k8s" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cyberzz.dev/post/k8s-install/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2023-09-09T00:00:00+00:00" />
<meta property="article:modified_time" content="2023-09-09T00:00:00+00:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Kubernetes"/>
<meta name="twitter:description" content="install k8s"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://cyberzz.dev/post/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Kubernetes",
      "item": "https://cyberzz.dev/post/k8s-install/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Kubernetes",
  "name": "Kubernetes",
  "description": "install k8s",
  "keywords": [
    
  ],
  "articleBody": "Kubernetes\n以下是Kubernetes的主要知识点，可以作为学习和使用Kubernetes的参考：\n容器技术基础：Docker，Pod Kubernetes的基本概念：Node，Pod，Deployment，Service，ConfigMap，Secret，Ingress，Namespace，Label Kubernetes的核心组件：API Server，etcd，kube-scheduler，kube-controller-manager，kubelet，kube-proxy Kubernetes的对象模型：Kubernetes API 对象，Kubernetes API 的版本 Kubernetes的部署方式：单节点，多节点，云平台 Kubernetes的资源管理：CPU，内存，存储，网络 Kubernetes的服务发现和负载均衡：Service，Endpoint，Ingress，LoadBalancer Kubernetes的存储管理：PersistentVolume，PersistentVolumeClaim，StorageClass Kubernetes的网络管理：CNI，网络策略 Kubernetes的自动化：自动伸缩，自动扩容，自动升级 Kubernetes的扩展：CRD，Operator Kubernetes的安全：TLS，RBAC，Pod Security Policy，Secrets Encryption Kubernetes的调试和故障排除：kubectl 命令，事件，日志，debug container Kubernetes的监控：Heapster，Prometheus，Grafana Kubernetes的CI/CD：Jenkins，GitLab，Spinnaker 以上是Kubernetes的主要知识点，Kubernetes是一个庞大而复杂的系统，需要不断的学习和实践才能掌握。建议按照学习步骤逐一深入学习。\n1. 准备 https://www.cnblogs.com/bamboo-green/p/17128474.html\nservice monitor 无法发现 https://www.kococ.cn/20211124/cid=721.html\nhttps://www.lvbibir.cn/posts/tech/kubernetes-prometheus-3-servicemonitor-podmonitor/\n1.1 系统配置 修改hosts 在安装之前，需要先做好如下准备。3台CentOS 7.9主机如下：\n[root@master ~]# cat /etc/hosts 127.0.0.1 localhost localhost.localdomain localhost4 localhost4.localdomain4 ::1 localhost localhost.localdomain localhost6 localhost6.localdomain6 192.168.10.20 master 192.168.10.21 node01 192.168.10.22 node02 192.168.10.23 node03 在各个主机上完成下面的系统配置。\n关闭防火墙 如果各个主机启用了防火墙策略，需要开放Kubernetes各个组件所需要的端口，可以查看Ports and Protocols中的内容, 开放相关端口或者关闭主机的防火墙。\nsystemctl disable firewalld --now iptables -F \u0026\u0026 iptables -t nat -F \u0026\u0026 iptables -t mangle -F \u0026\u0026 iptables -X 关闭 selinux setenforce 0 sed -i 's/SELINUX=enforcing/SELINUX=disabled/g' /etc/selinux/config 必须安装iptables 创建/etc/modules-load.d/containerd.conf配置文件: cat \u003c\u003c EOF \u003e /etc/modules-load.d/containerd.conf overlay br_netfilter EOF 使配置生效\nmodprobe overlay modprobe br_netfilter 创建/etc/sysctl.d/99-kubernetes-cri.conf配置文件：\ncat \u003c\u003c EOF \u003e /etc/sysctl.d/99-kubernetes-cri.conf net.bridge.bridge-nf-call-ip6tables = 1 net.bridge.bridge-nf-call-iptables = 1 net.ipv4.ip_forward = 1 user.max_user_namespaces=28633 EOF 执行以下命令使配置生效:\nsysctl -p /etc/sysctl.d/99-kubernetes-cri.conf 1.2 加载内核modules ipvs 可以参考https://github.com/kubernetes/kubernetes/blob/master/pkg/proxy/ipvs/README.md\n由于ipvs已经加入到了内核的主干，所以为kube-proxy开启ipvs的前提需要加载以下的内核模块：\n内核模块位置：\n/lib/modules/5.4.209-1.el7.elrepo.x86_64 在各个服务器节点上执行以下脚本:\nyum install ipvsadm ipset sysstat conntrack libseccomp -y # 配置ipvs模块，在内核4.19+版本nf_conntrack_ipv4已经改为nf_conntrack cat \u003e /etc/modules-load.d/ipvs.conf \u003c",
  "wordCount" : "8974",
  "inLanguage": "en",
  "datePublished": "2023-09-09T00:00:00Z",
  "dateModified": "2023-09-09T00:00:00Z",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://cyberzz.dev/post/k8s-install/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "cyberzz.dev",
    "logo": {
      "@type": "ImageObject",
      "url": "https://cyberzz.dev/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://cyberzz.dev/" accesskey="h" title="cyberzz.dev (Alt + H)">cyberzz.dev</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://cyberzz.dev/" title="Home">
                    <span>Home</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title">
      Kubernetes
    </h1>
    <div class="post-description">
      install k8s
    </div>
    <div class="post-meta"><span title='2023-09-09 00:00:00 +0000 UTC'>September 9, 2023</span>

</div>
  </header> 
  <div class="post-content"><p>Kubernetes</p>
<p>以下是Kubernetes的主要知识点，可以作为学习和使用Kubernetes的参考：</p>
<ol>
<li>容器技术基础：Docker，Pod</li>
<li>Kubernetes的基本概念：Node，Pod，Deployment，Service，ConfigMap，Secret，Ingress，Namespace，Label</li>
<li>Kubernetes的核心组件：API Server，etcd，kube-scheduler，kube-controller-manager，kubelet，kube-proxy</li>
<li>Kubernetes的对象模型：Kubernetes API 对象，Kubernetes API 的版本</li>
<li>Kubernetes的部署方式：单节点，多节点，云平台</li>
<li>Kubernetes的资源管理：CPU，内存，存储，网络</li>
<li>Kubernetes的服务发现和负载均衡：Service，Endpoint，Ingress，LoadBalancer</li>
<li>Kubernetes的存储管理：PersistentVolume，PersistentVolumeClaim，StorageClass</li>
<li>Kubernetes的网络管理：CNI，网络策略</li>
<li>Kubernetes的自动化：自动伸缩，自动扩容，自动升级</li>
<li>Kubernetes的扩展：CRD，Operator</li>
<li>Kubernetes的安全：TLS，RBAC，Pod Security Policy，Secrets Encryption</li>
<li>Kubernetes的调试和故障排除：kubectl 命令，事件，日志，debug container</li>
<li>Kubernetes的监控：Heapster，Prometheus，Grafana</li>
<li>Kubernetes的CI/CD：Jenkins，GitLab，Spinnaker</li>
</ol>
<p>以上是Kubernetes的主要知识点，Kubernetes是一个庞大而复杂的系统，需要不断的学习和实践才能掌握。建议按照学习步骤逐一深入学习。</p>
<h1 id="1-准备">1. 准备<a hidden class="anchor" aria-hidden="true" href="#1-准备">#</a></h1>
<p><a href="https://www.cnblogs.com/bamboo-green/p/17128474.html">https://www.cnblogs.com/bamboo-green/p/17128474.html</a></p>
<h2 id="service-monitor-无法发现">service monitor 无法发现<a hidden class="anchor" aria-hidden="true" href="#service-monitor-无法发现">#</a></h2>
<p><a href="https://www.kococ.cn/20211124/cid=721.html">https://www.kococ.cn/20211124/cid=721.html</a></p>
<p><a href="https://www.lvbibir.cn/posts/tech/kubernetes-prometheus-3-servicemonitor-podmonitor/">https://www.lvbibir.cn/posts/tech/kubernetes-prometheus-3-servicemonitor-podmonitor/</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"></code></pre></div><h2 id="11-系统配置">1.1 系统配置<a hidden class="anchor" aria-hidden="true" href="#11-系统配置">#</a></h2>
<ul>
<li>
<h3 id="修改hosts">修改hosts<a hidden class="anchor" aria-hidden="true" href="#修改hosts">#</a></h3>
</li>
</ul>
<p>在安装之前，需要先做好如下准备。3台CentOS 7.9主机如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@master ~<span style="color:#f92672">]</span><span style="color:#75715e"># cat /etc/hosts</span>
</span></span><span style="display:flex;"><span>127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4
</span></span><span style="display:flex;"><span>::1         localhost localhost.localdomain localhost6 localhost6.localdomain6
</span></span><span style="display:flex;"><span>192.168.10.20 master
</span></span><span style="display:flex;"><span>192.168.10.21 node01
</span></span><span style="display:flex;"><span>192.168.10.22 node02
</span></span><span style="display:flex;"><span>192.168.10.23 node03
</span></span></code></pre></div><p>在各个主机上完成下面的系统配置。</p>
<ul>
<li>
<h3 id="关闭防火墙">关闭防火墙<a hidden class="anchor" aria-hidden="true" href="#关闭防火墙">#</a></h3>
</li>
</ul>
<p>如果各个主机启用了防火墙策略，需要开放Kubernetes各个组件所需要的端口，可以查看<a href="https://kubernetes.io/docs/reference/ports-and-protocols/">Ports and Protocols</a>中的内容, 开放相关端口或者关闭主机的防火墙。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>systemctl disable firewalld --now
</span></span><span style="display:flex;"><span>iptables -F <span style="color:#f92672">&amp;&amp;</span> iptables -t nat -F <span style="color:#f92672">&amp;&amp;</span> iptables -t mangle -F <span style="color:#f92672">&amp;&amp;</span> iptables -X
</span></span></code></pre></div><ul>
<li>
<h3 id="关闭-selinux">关闭 selinux<a hidden class="anchor" aria-hidden="true" href="#关闭-selinux">#</a></h3>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>setenforce <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>sed -i <span style="color:#e6db74">&#39;s/SELINUX=enforcing/SELINUX=disabled/g&#39;</span>  /etc/selinux/config
</span></span></code></pre></div><ul>
<li>
<h3 id="必须安装iptables">必须安装iptables<a hidden class="anchor" aria-hidden="true" href="#必须安装iptables">#</a></h3>
</li>
<li>
<h3 id="创建etcmodules-loaddcontainerdconf配置文件">创建/etc/modules-load.d/containerd.conf配置文件:<a hidden class="anchor" aria-hidden="true" href="#创建etcmodules-loaddcontainerdconf配置文件">#</a></h3>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cat <span style="color:#e6db74">&lt;&lt; EOF &gt; /etc/modules-load.d/containerd.conf
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">overlay
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">br_netfilter
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div><p>使配置生效</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>modprobe overlay
</span></span><span style="display:flex;"><span>modprobe br_netfilter
</span></span></code></pre></div><p>创建/etc/sysctl.d/99-kubernetes-cri.conf配置文件：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cat <span style="color:#e6db74">&lt;&lt; EOF &gt; /etc/sysctl.d/99-kubernetes-cri.conf
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">net.bridge.bridge-nf-call-ip6tables = 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">net.bridge.bridge-nf-call-iptables = 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">net.ipv4.ip_forward = 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">user.max_user_namespaces=28633
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div><p>执行以下命令使配置生效:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sysctl -p /etc/sysctl.d/99-kubernetes-cri.conf
</span></span></code></pre></div><h2 id="12-加载内核modules-ipvs">1.2 加载内核modules ipvs<a hidden class="anchor" aria-hidden="true" href="#12-加载内核modules-ipvs">#</a></h2>
<p>可以参考https://github.com/kubernetes/kubernetes/blob/master/pkg/proxy/ipvs/README.md</p>
<p>由于ipvs已经加入到了内核的主干，所以为kube-proxy开启ipvs的前提需要加载以下的内核模块：</p>
<p>内核模块位置：</p>
<pre tabindex="0"><code>/lib/modules/5.4.209-1.el7.elrepo.x86_64
</code></pre><p>在各个服务器节点上执行以下脚本:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>yum install ipvsadm ipset sysstat conntrack libseccomp -y
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 配置ipvs模块，在内核4.19+版本nf_conntrack_ipv4已经改为nf_conntrack</span>
</span></span><span style="display:flex;"><span>cat &gt; /etc/modules-load.d/ipvs.conf <span style="color:#e6db74">&lt;&lt;EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ip_vs
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ip_vs_lc
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ip_vs_wlc
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ip_vs_rr
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ip_vs_wrr
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ip_vs_lblc
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ip_vs_lblcr
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ip_vs_dh
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ip_vs_sh
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ip_vs_fo
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ip_vs_nq
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ip_vs_sed
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ip_vs_ftp
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ip_vs_sh
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">nf_conntrack
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ip_tables
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ip_set
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">xt_set
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ipt_set
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ipt_rpfilter
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ipt_REJECT
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ipip
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>systemctl enable --now systemd-modules-load.service
</span></span></code></pre></div><p>使用<code>lsmod | grep -e ip_vs -e nf_conntrack</code>命令查看是否已经正确加载所需的内核模块。</p>
<p>接下来还需要确保各个节点上已经安装了ipset软件包，为了便于查看ipvs的代理规则，最好安装一下管理工具ipvsadm。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>yum install -y ipset ipvsadm
</span></span></code></pre></div><p>如果不满足以上前提条件，则即使kube-proxy的配置开启了ipvs模式，也会退回到iptables模式。</p>
<h2 id="13-docker">1.3 docker<a hidden class="anchor" aria-hidden="true" href="#13-docker">#</a></h2>
<h3 id="安装docker">安装Docker<a hidden class="anchor" aria-hidden="true" href="#安装docker">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>wget https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo -O /etc/yum.repos.d/docker-ce.repo
</span></span><span style="display:flex;"><span>yum -y install docker-ce
</span></span><span style="display:flex;"><span>systemctl enable docker <span style="color:#f92672">&amp;&amp;</span> systemctl start docker
</span></span></code></pre></div><p>配置镜像下载加速器：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#a6e22e">cat</span> <span style="color:#f92672">&gt;</span> <span style="color:#960050;background-color:#1e0010">/etc/docker/daemon.json &lt;&lt; EOF</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;registry-mirrors&#34;</span><span style="color:#f92672">:</span> [<span style="color:#e6db74">&#34;https://292nm6nu.mirror.aliyuncs.com&#34;</span>],
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;exec-opts&#34;</span><span style="color:#f92672">:</span> [<span style="color:#e6db74">&#34;native.cgroupdriver=systemd&#34;</span>]
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">EOF</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">systemctl</span> <span style="color:#a6e22e">restart</span> <span style="color:#a6e22e">docker</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">docker</span> <span style="color:#a6e22e">info</span>
</span></span></code></pre></div><h3 id="安装cri-dockerd">安装cri-dockerd<a hidden class="anchor" aria-hidden="true" href="#安装cri-dockerd">#</a></h3>
<p>Kubernetes v1.24移除docker-shim的支持，而Docker Engine默认又不支持CRI标准，因此二者默认无法再直接集成。为此，Mirantis和Docker联合创建了cri-dockerd项目，用于为Docker Engine提供一个能够支持到CRI规范的桥梁，从而能够让Docker作为Kubernetes容器引擎。</p>
<p>如图所示：</p>
<p>[https://img2023.cnblogs.com/blog/1772495/202302/1772495-20230216220036444-1454369319.png]:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>wget https://github.com/Mirantis/cri-dockerd/releases/download/v0.3.1/cri-dockerd-0.3.1-3.el7.x86_64.rpm
</span></span><span style="display:flex;"><span>rpm -ivh cri-dockerd-0.3.1-3.el7.x86_64.rpm
</span></span></code></pre></div><p>指定依赖镜像地址：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#a6e22e">vim</span> <span style="color:#f92672">/</span><span style="color:#a6e22e">usr</span><span style="color:#f92672">/</span><span style="color:#a6e22e">lib</span><span style="color:#f92672">/</span><span style="color:#a6e22e">systemd</span><span style="color:#f92672">/</span><span style="color:#a6e22e">system</span><span style="color:#f92672">/</span><span style="color:#a6e22e">cri</span><span style="color:#f92672">-</span><span style="color:#a6e22e">docker</span>.<span style="color:#a6e22e">service</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">把原来的注释一下添加如下</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span><span style="color:#a6e22e">ExecStart</span><span style="color:#f92672">=</span><span style="color:#960050;background-color:#1e0010">/usr/bin/cri-dockerd --container-runtime-endpoint fd://</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ExecStart</span><span style="color:#f92672">=</span><span style="color:#960050;background-color:#1e0010">/usr/bin/cri-dockerd --container-runtime-endpoint fd:// --pod-infra-container-image=registry.aliyuncs.com/google_containers/pause:3.7</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">systemctl</span> <span style="color:#a6e22e">daemon</span><span style="color:#f92672">-</span><span style="color:#a6e22e">reload</span> 
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">systemctl</span> <span style="color:#a6e22e">enable</span> <span style="color:#a6e22e">cri</span><span style="color:#f92672">-</span><span style="color:#a6e22e">docker</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">systemctl</span> <span style="color:#a6e22e">start</span> <span style="color:#a6e22e">cri</span><span style="color:#f92672">-</span><span style="color:#a6e22e">docker</span>
</span></span></code></pre></div><h3 id="添加阿里云yum软件源">添加阿里云YUM软件源<a hidden class="anchor" aria-hidden="true" href="#添加阿里云yum软件源">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-makefile" data-lang="makefile"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">cat</span> <span style="color:#960050;background-color:#1e0010">&gt;</span> <span style="color:#960050;background-color:#1e0010">/etc/yum.repos.d/kubernetes.repo</span> <span style="color:#960050;background-color:#1e0010">&lt;&lt;</span> <span style="color:#960050;background-color:#1e0010">EOF</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">[kubernetes]</span>
</span></span><span style="display:flex;"><span>name<span style="color:#f92672">=</span>Kubernetes
</span></span><span style="display:flex;"><span>baseurl<span style="color:#f92672">=</span>https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64
</span></span><span style="display:flex;"><span>enabled<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>gpgcheck<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>repo_gpgcheck<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>gpgkey<span style="color:#f92672">=</span>https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">EOF</span>
</span></span></code></pre></div><h3 id="安装kubeadmkubelet和kubectl">安装kubeadm，kubelet和kubectl<a hidden class="anchor" aria-hidden="true" href="#安装kubeadmkubelet和kubectl">#</a></h3>
<p>由于版本更新频繁，这里指定版本号部署：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>yum install -y kubelet kubeadm kubectl
</span></span><span style="display:flex;"><span>systemctl enable kubelet
</span></span></code></pre></div><h2 id="14--containerdrunc">1.4  Containerd、runc<a hidden class="anchor" aria-hidden="true" href="#14--containerdrunc">#</a></h2>
<p><strong>1、配置先决条件</strong></p>
<p>如果是由docker切containerd这步可省略。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cat <span style="color:#e6db74">&lt;&lt;EOF | sudo tee /etc/modules-load.d/containerd.conf
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">overlay
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">br_netfilter
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>sudo modprobe overlay
</span></span><span style="display:flex;"><span>sudo modprobe br_netfilter
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 设置必需的 sysctl 参数，这些参数在重新启动后仍然存在。</span>
</span></span><span style="display:flex;"><span>cat <span style="color:#e6db74">&lt;&lt;EOF | sudo tee /etc/sysctl.d/99-kubernetes-cri.conf
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">net.bridge.bridge-nf-call-iptables  = 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">net.bridge.bridge-nf-call-ip6tables = 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">net.ipv4.ip_forward                 = 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>sudo sysctl --system
</span></span></code></pre></div><p><strong>2、安装containerd</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span>yum install <span style="color:#f92672">-</span>y yum<span style="color:#f92672">-</span>utils device<span style="color:#f92672">-</span>mapper<span style="color:#f92672">-</span>persistent<span style="color:#f92672">-</span>data lvm2
</span></span><span style="display:flex;"><span>yum<span style="color:#f92672">-</span>config<span style="color:#f92672">-</span>manager <span style="color:#960050;background-color:#1e0010">\</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">--add-repo \</span>
</span></span><span style="display:flex;"><span>    https:<span style="color:#f92672">//</span>download.docker.com<span style="color:#f92672">/</span>linux<span style="color:#f92672">/</span>centos<span style="color:#f92672">/</span>docker<span style="color:#f92672">-</span>ce.repo
</span></span><span style="display:flex;"><span>yum install <span style="color:#f92672">-</span>y containerd.io
</span></span><span style="display:flex;"><span>mkdir <span style="color:#f92672">-</span>p <span style="color:#f92672">/</span>etc<span style="color:#f92672">/</span>containerd
</span></span><span style="display:flex;"><span>containerd config default <span style="color:#f92672">&gt;</span> <span style="color:#f92672">/</span>etc<span style="color:#f92672">/</span>containerd<span style="color:#f92672">/</span>config.toml
</span></span></code></pre></div><p><strong>3、修改配置文件</strong></p>
<ul>
<li>pause镜像设置过阿里云镜像仓库地址</li>
<li>拉取Docker Hub镜像配置加速地址设置为阿里云镜像仓库地址</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>vi /etc/containerd/config.toml
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">   [plugins.&#34;io.containerd.grpc.v1.cri&#34;]</span>
</span></span><span style="display:flex;"><span>      sandbox_image = <span style="color:#e6db74">&#34;registry.aliyuncs.com/google_containers/pause:3.2&#34;</span>  
</span></span><span style="display:flex;"><span>       ...
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">   [plugins.&#34;io.containerd.grpc.v1.cri&#34;.registry.mirrors]</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">          [plugins.&#34;io.containerd.grpc.v1.cri&#34;.registry.mirrors.&#34;docker.io&#34;]</span>
</span></span><span style="display:flex;"><span>            endpoint = [<span style="color:#e6db74">&#34;https://b9pmyelo.mirror.aliyuncs.com&#34;</span>]
</span></span><span style="display:flex;"><span>          
</span></span><span style="display:flex;"><span>systemctl restart containerd
</span></span></code></pre></div><p><strong>4、配置kubelet使用containerd</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>vi /var/lib/kubelet/kubeadm-flags.env
</span></span><span style="display:flex;"><span>KUBELET_KUBEADM_ARGS<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;--container-runtime=remote --container-runtime-endpoint=unix:///run/containerd/containerd.sock --pod-infra-container-image=registry.aliyuncs.com/google_containers/pause:3.8&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>systemctl restart kubelet
</span></span></code></pre></div><p><strong>5、验证</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>kubectl <span style="color:#66d9ef">get</span> node -o wide
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>k8s-node1  xxx  containerd:<span style="color:#75715e">//1.5.6</span>
</span></span></code></pre></div><p><img loading="lazy" src="https://img2023.cnblogs.com/blog/1772495/202302/1772495-20230216221027779-324412180.png" alt="get node"  />
</p>
<p><strong>6、管理容器工具</strong></p>
<p>containerd提供了ctr命令行工具管理容器，但功能比较简单，所以一般会用crictl工具检查和调试容器。</p>
<p>项目地址：https://github.com/kubernetes-sigs/cri-tools/</p>
<p>设置crictl连接containerd：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>vi /etc/crictl.yaml
</span></span><span style="display:flex;"><span>runtime-endpoint: unix:///run/containerd/containerd.sock
</span></span><span style="display:flex;"><span>image-endpoint: unix:///run/containerd/containerd.sock
</span></span><span style="display:flex;"><span>timeout: <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>debug: false
</span></span></code></pre></div><p>在各个服务器节点上安装容器运行时Containerd。</p>
<p>可以选择yum安装：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>yum install -y containerd.io runc
</span></span></code></pre></div><p>下载Containerd的二进制包:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>wget https://github.com/containerd/containerd/releases/download/v1.6.6/cri-containerd-cni-1.6.6-linux-amd64.tar.gz
</span></span></code></pre></div><p><code>cri-containerd-cni-1.6.4-linux-amd64.tar.gz</code>压缩包中已经按照官方二进制部署推荐的目录结构布局好。 里面包含了systemd配置文件，containerd以及cni的部署文件。 将解压缩到系统的根目录<code>/</code>中:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>tar -zxvf cri-containerd-cni-1.6.4-linux-amd64.tar.gz -C /
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>etc/
</span></span><span style="display:flex;"><span>etc/systemd/
</span></span><span style="display:flex;"><span>etc/systemd/system/
</span></span><span style="display:flex;"><span>etc/systemd/system/containerd.service
</span></span><span style="display:flex;"><span>etc/crictl.yaml
</span></span><span style="display:flex;"><span>etc/cni/
</span></span><span style="display:flex;"><span>etc/cni/net.d/
</span></span><span style="display:flex;"><span>etc/cni/net.d/10-containerd-net.conflist
</span></span><span style="display:flex;"><span>usr/
</span></span><span style="display:flex;"><span>usr/local/
</span></span><span style="display:flex;"><span>usr/local/sbin/
</span></span><span style="display:flex;"><span>usr/local/sbin/runc
</span></span><span style="display:flex;"><span>usr/local/bin/
</span></span><span style="display:flex;"><span>usr/local/bin/critest
</span></span><span style="display:flex;"><span>usr/local/bin/containerd-shim
</span></span><span style="display:flex;"><span>usr/local/bin/containerd-shim-runc-v1
</span></span><span style="display:flex;"><span>usr/local/bin/ctd-decoder
</span></span><span style="display:flex;"><span>usr/local/bin/containerd
</span></span><span style="display:flex;"><span>usr/local/bin/containerd-shim-runc-v2
</span></span><span style="display:flex;"><span>usr/local/bin/containerd-stress
</span></span><span style="display:flex;"><span>usr/local/bin/ctr
</span></span><span style="display:flex;"><span>usr/local/bin/crictl
</span></span><span style="display:flex;"><span>......
</span></span><span style="display:flex;"><span>opt/cni/
</span></span><span style="display:flex;"><span>opt/cni/bin/
</span></span><span style="display:flex;"><span>opt/cni/bin/bridge
</span></span><span style="display:flex;"><span>......
</span></span></code></pre></div><p>注意经测试cri-containerd-cni-1.6.4-linux-amd64.tar.gz包中包含的runc在CentOS 7下的动态链接有问题，这里从runc的github上单独下载runc，并替换上面安装的containerd中的runc:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>wget https://github.com/opencontainers/runc/releases/download/v1.1.2/runc.amd64
</span></span></code></pre></div><p>接下来生成containerd的配置文件:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>mkdir -p /etc/containerd
</span></span><span style="display:flex;"><span>containerd config default &gt; /etc/containerd/config.toml
</span></span></code></pre></div><p>根据文档<a href="https://kubernetes.io/docs/setup/production-environment/container-runtimes/">Container runtimes </a>中的内容，对于使用systemd作为init system的Linux的发行版，使用systemd作为容器的cgroup driver可以确保服务器节点在资源紧张的情况更加稳定，因此这里配置各个节点上containerd的cgroup driver为systemd。</p>
<p>修改前面生成的配置文件<code>/etc/containerd/config.toml</code>：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-toml" data-lang="toml"><span style="display:flex;"><span>[<span style="color:#a6e22e">plugins</span>.<span style="color:#e6db74">&#34;io.containerd.grpc.v1.cri&#34;</span>.<span style="color:#a6e22e">containerd</span>.<span style="color:#a6e22e">runtimes</span>.<span style="color:#a6e22e">runc</span>]
</span></span><span style="display:flex;"><span>  ...
</span></span><span style="display:flex;"><span>  [<span style="color:#a6e22e">plugins</span>.<span style="color:#e6db74">&#34;io.containerd.grpc.v1.cri&#34;</span>.<span style="color:#a6e22e">containerd</span>.<span style="color:#a6e22e">runtimes</span>.<span style="color:#a6e22e">runc</span>.<span style="color:#a6e22e">options</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">SystemdCgroup</span> = <span style="color:#66d9ef">true</span>
</span></span></code></pre></div><p>再修改<code>/etc/containerd/config.toml</code>中的</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-toml" data-lang="toml"><span style="display:flex;"><span>[<span style="color:#a6e22e">plugins</span>.<span style="color:#e6db74">&#34;io.containerd.grpc.v1.cri&#34;</span>]
</span></span><span style="display:flex;"><span>  ...
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># sandbox_image = &#34;k8s.gcr.io/pause:3.6&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">sandbox_image</span> = <span style="color:#e6db74">&#34;registry.aliyuncs.com/google_containers/pause:3.7&#34;</span>
</span></span></code></pre></div><p>配置containerd开机启动，并启动containerd</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>systemctl disable containerd --now
</span></span></code></pre></div><p>使用crictl测试一下，确保可以打印出版本信息并且没有错误信息输出:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>crictl version
</span></span><span style="display:flex;"><span>Version:  0.1.0
</span></span><span style="display:flex;"><span>RuntimeName:  containerd
</span></span><span style="display:flex;"><span>RuntimeVersion:  v1.6.4
</span></span><span style="display:flex;"><span>RuntimeApiVersion:  v1alpha2
</span></span></code></pre></div><h1 id="2-使用kubeadm部署kubernetes">2. 使用kubeadm部署Kubernetes<a hidden class="anchor" aria-hidden="true" href="#2-使用kubeadm部署kubernetes">#</a></h1>
<h2 id="21-安装kubeadm和kubelet">2.1 安装kubeadm和kubelet<a hidden class="anchor" aria-hidden="true" href="#21-安装kubeadm和kubelet">#</a></h2>
<p>下面在各节点安装kubeadm和kubelet：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cat <span style="color:#e6db74">&lt;&lt;EOF &gt; /etc/yum.repos.d/kubernetes.repo
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[kubernetes]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">name=Kubernetes
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">baseurl=http://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">enabled=1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">gpgcheck=1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">repo_gpgcheck=0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">gpgkey=http://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        http://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>yum makecache fast
</span></span><span style="display:flex;"><span>yum install kubelet kubeadm kubectl
</span></span></code></pre></div><p>运行<code>kubelet --help</code>可以看到原来kubelet的绝大多数命令行flag参数都被<code>DEPRECATED</code>了，官方推荐我们使用<code>--config</code>指定配置文件，并在配置文件中指定原来这些flag所配置的内容。具体内容可以查看这里<a href="https://kubernetes.io/docs/tasks/administer-cluster/kubelet-config-file/">Set Kubelet parameters via a config file</a>。<strong>最初Kubernetes这么做是为了支持动态Kubelet配置（Dynamic Kubelet Configuration），但动态Kubelet配置特性从k8s 1.22中已弃用，并在1.24中被移除。如果需要调整集群汇总所有节点kubelet的配置，还是推荐使用ansible等工具将配置分发到各个节点</strong>。</p>
<p>kubelet的配置文件必须是json或yaml格式，具体可查看<a href="https://github.com/kubernetes/kubelet/blob/release-1.24/config/v1beta1/types.go">这里</a>。</p>
<p>Kubernetes 1.8开始要求关闭系统的Swap，如果不关闭，默认配置下kubelet将无法启动。 关闭系统的Swap方法如下:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>swapoff -a
</span></span></code></pre></div><p>修改 /etc/fstab 文件，注释掉 SWAP 的自动挂载，使用<code>free -m</code>确认swap已经关闭。</p>
<p>swappiness参数调整，修改/etc/sysctl.d/99-kubernetes-cri.conf添加下面一行：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;vm.swappiness=0&#34;</span> &gt;&gt; /etc/sysctl.d/99-kubernetes-cri.conf
</span></span><span style="display:flex;"><span>sysctl -p /etc/sysctl.d/99-kubernetes-cri.conf
</span></span></code></pre></div><h2 id="22-kubeadm-init初始化">2.2 kubeadm init初始化<a hidden class="anchor" aria-hidden="true" href="#22-kubeadm-init初始化">#</a></h2>
<p>在各节点开机启动kubelet服务：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>systemctl enable kubelet.service --now
</span></span><span style="display:flex;"><span>systemctl enable containerd.service --now
</span></span></code></pre></div><p>使用</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubeadm config print init-defaults --component-configs KubeletConfiguration
</span></span></code></pre></div><p>可以打印集群初始化默认的使用的配置：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">kubeadm.k8s.io/v1beta3</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">bootstrapTokens</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">groups</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">system:bootstrappers:kubeadm:default-node-token</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">token</span>: <span style="color:#ae81ff">abcdef.0123456789abcdef</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ttl</span>: <span style="color:#ae81ff">24h0m0s</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">usages</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">signing</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">authentication</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">InitConfiguration</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">localAPIEndpoint</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">advertiseAddress</span>: <span style="color:#ae81ff">1.2.3.4</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">bindPort</span>: <span style="color:#ae81ff">6443</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">nodeRegistration</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">criSocket</span>: <span style="color:#ae81ff">unix:///var/run/containerd/containerd.sock</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">imagePullPolicy</span>: <span style="color:#ae81ff">IfNotPresent</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">node</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">taints</span>: <span style="color:#66d9ef">null</span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiServer</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">timeoutForControlPlane</span>: <span style="color:#ae81ff">4m0s</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">kubeadm.k8s.io/v1beta3</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">certificatesDir</span>: <span style="color:#ae81ff">/etc/kubernetes/pki</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">clusterName</span>: <span style="color:#ae81ff">kubernetes</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">controllerManager</span>: {}
</span></span><span style="display:flex;"><span><span style="color:#f92672">dns</span>: {}
</span></span><span style="display:flex;"><span><span style="color:#f92672">etcd</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">local</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">dataDir</span>: <span style="color:#ae81ff">/var/lib/etcd</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">imageRepository</span>: <span style="color:#ae81ff">k8s.gcr.io</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ClusterConfiguration</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kubernetesVersion</span>: <span style="color:#ae81ff">1.24.0</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">networking</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">dnsDomain</span>: <span style="color:#ae81ff">cluster.local</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">serviceSubnet</span>: <span style="color:#ae81ff">10.96.0.0</span><span style="color:#ae81ff">/12</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">scheduler</span>: {}
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">kubelet.config.k8s.io/v1beta1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">authentication</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">anonymous</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">webhook</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">cacheTTL</span>: <span style="color:#ae81ff">0s</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">x509</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">clientCAFile</span>: <span style="color:#ae81ff">/etc/kubernetes/pki/ca.crt</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">authorization</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">mode</span>: <span style="color:#ae81ff">Webhook</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">webhook</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">cacheAuthorizedTTL</span>: <span style="color:#ae81ff">0s</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">cacheUnauthorizedTTL</span>: <span style="color:#ae81ff">0s</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">cgroupDriver</span>: <span style="color:#ae81ff">systemd</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">clusterDNS</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#ae81ff">10.96.0.10</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">clusterDomain</span>: <span style="color:#ae81ff">cluster.local</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">cpuManagerReconcilePeriod</span>: <span style="color:#ae81ff">0s</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">evictionPressureTransitionPeriod</span>: <span style="color:#ae81ff">0s</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">fileCheckFrequency</span>: <span style="color:#ae81ff">0s</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">healthzBindAddress</span>: <span style="color:#ae81ff">127.0.0.1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">healthzPort</span>: <span style="color:#ae81ff">10248</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">httpCheckFrequency</span>: <span style="color:#ae81ff">0s</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">imageMinimumGCAge</span>: <span style="color:#ae81ff">0s</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">KubeletConfiguration</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">logging</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">flushFrequency</span>: <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">options</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">json</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">infoBufferSize</span>: <span style="color:#e6db74">&#34;0&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">verbosity</span>: <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">memorySwap</span>: {}
</span></span><span style="display:flex;"><span><span style="color:#f92672">nodeStatusReportFrequency</span>: <span style="color:#ae81ff">0s</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">nodeStatusUpdateFrequency</span>: <span style="color:#ae81ff">0s</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">rotateCertificates</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">runtimeRequestTimeout</span>: <span style="color:#ae81ff">0s</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">shutdownGracePeriod</span>: <span style="color:#ae81ff">0s</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">shutdownGracePeriodCriticalPods</span>: <span style="color:#ae81ff">0s</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">staticPodPath</span>: <span style="color:#ae81ff">/etc/kubernetes/manifests</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">streamingConnectionIdleTimeout</span>: <span style="color:#ae81ff">0s</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">syncFrequency</span>: <span style="color:#ae81ff">0s</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">volumeStatsAggPeriod</span>: <span style="color:#ae81ff">0s</span>
</span></span></code></pre></div><p>从默认的配置中可以看到，可以使用<code>imageRepository</code>定制在集群初始化时拉取k8s所需镜像的地址。基于默认配置定制出本次使用kubeadm初始化集群所需的配置文件kubeadm.yaml：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">kubeadm.k8s.io/v1beta3</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">InitConfiguration</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">localAPIEndpoint</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">advertiseAddress</span>: <span style="color:#ae81ff">192.168.96.151</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">bindPort</span>: <span style="color:#ae81ff">6443</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">nodeRegistration</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">criSocket</span>: <span style="color:#ae81ff">unix:///run/containerd/containerd.sock</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">taints</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">effect</span>: <span style="color:#ae81ff">PreferNoSchedule</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">key</span>: <span style="color:#ae81ff">node-role.kubernetes.io/master</span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">kubeadm.k8s.io/v1beta2</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ClusterConfiguration</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kubernetesVersion</span>: <span style="color:#ae81ff">v1.24.0</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">imageRepository</span>: <span style="color:#ae81ff">registry.aliyuncs.com/google_containers</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">networking</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">podSubnet</span>: <span style="color:#ae81ff">10.244.0.0</span><span style="color:#ae81ff">/16</span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">kubelet.config.k8s.io/v1beta1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">KubeletConfiguration</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">cgroupDriver</span>: <span style="color:#ae81ff">systemd</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">failSwapOn</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">kubeproxy.config.k8s.io/v1alpha1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">KubeProxyConfiguration</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">mode</span>: <span style="color:#ae81ff">ipvs</span>
</span></span></code></pre></div><p>这里定制了<code>imageRepository</code>为阿里云的registry，避免因gcr被墙，无法直接拉取镜像。<code>criSocket</code>设置了容器运行时为containerd。 同时设置kubelet的<code>cgroupDriver</code>为systemd，设置kube-proxy代理模式为ipvs。</p>
<p>在开始初始化集群之前可以使用<code>kubeadm config images pull --config kubeadm.yaml</code>预先在各个服务器节点上拉取所k8s需要的容器镜像。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubeadm config images pull --config kubeadm.yaml
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>config/images<span style="color:#f92672">]</span> Pulled registry.aliyuncs.com/google_containers/kube-apiserver:v1.24.0
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>config/images<span style="color:#f92672">]</span> Pulled registry.aliyuncs.com/google_containers/kube-controller-manager:v1.24.0
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>config/images<span style="color:#f92672">]</span> Pulled registry.aliyuncs.com/google_containers/kube-scheduler:v1.24.0
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>config/images<span style="color:#f92672">]</span> Pulled registry.aliyuncs.com/google_containers/kube-proxy:v1.24.0
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>config/images<span style="color:#f92672">]</span> Pulled registry.aliyuncs.com/google_containers/pause:3.7
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>config/images<span style="color:#f92672">]</span> Pulled registry.aliyuncs.com/google_containers/etcd:3.5.3-0
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>config/images<span style="color:#f92672">]</span> Pulled registry.aliyuncs.com/google_containers/coredns:v1.8.6
</span></span></code></pre></div><p>接下来使用kubeadm初始化集群，选择node1作为Master Node，在node1上执行下面的命令：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>  kubeadm init <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --apiserver-advertise-address<span style="color:#f92672">=</span>192.168.10.20 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --image-repository registry.aliyuncs.com/google_containers <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --kubernetes-version v1.26.3 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --service-cidr<span style="color:#f92672">=</span>10.96.0.0/12 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span><span style="color:#75715e"># --cri-socket=unix:///var/run/cri-dockerd.sock \</span>
</span></span><span style="display:flex;"><span>  --pod-network-cidr<span style="color:#f92672">=</span>10.244.0.0/16 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --ignore-preflight-errors<span style="color:#f92672">=</span>all
</span></span></code></pre></div><p>或者</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubeadm init --config kubeadm.yaml
</span></span><span style="display:flex;"><span>W0526 10:22:26.657615   <span style="color:#ae81ff">24076</span> common.go:83<span style="color:#f92672">]</span> your configuration file uses a deprecated API spec: <span style="color:#e6db74">&#34;kubeadm.k8s.io/v1beta2&#34;</span>. Please use <span style="color:#e6db74">&#39;kubeadm config migrate --old-config old.yaml --new-config new.yaml&#39;</span>, which will write the new, similar spec using a newer API version.
</span></span><span style="display:flex;"><span>W0526 10:22:26.660300   <span style="color:#ae81ff">24076</span> initconfiguration.go:120<span style="color:#f92672">]</span> Usage of CRI endpoints without URL scheme is deprecated and can cause kubelet errors in the future. Automatically prepending scheme <span style="color:#e6db74">&#34;unix&#34;</span> to the <span style="color:#e6db74">&#34;criSocket&#34;</span> with value <span style="color:#e6db74">&#34;/run/containerd/containerd.sock&#34;</span>. Please update your configuration!
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>init<span style="color:#f92672">]</span> Using Kubernetes version: v1.24.0
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>preflight<span style="color:#f92672">]</span> Running pre-flight checks
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">[</span>WARNING Swap<span style="color:#f92672">]</span>: swap is enabled; production deployments should disable swap unless testing the NodeSwap feature gate of the kubelet
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>preflight<span style="color:#f92672">]</span> Pulling images required <span style="color:#66d9ef">for</span> setting up a Kubernetes cluster
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>preflight<span style="color:#f92672">]</span> This might take a minute or two, depending on the speed of your internet connection
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>preflight<span style="color:#f92672">]</span> You can also perform this action in beforehand using <span style="color:#e6db74">&#39;kubeadm config images pull&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>certs<span style="color:#f92672">]</span> Using certificateDir folder <span style="color:#e6db74">&#34;/etc/kubernetes/pki&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>certs<span style="color:#f92672">]</span> Generating <span style="color:#e6db74">&#34;ca&#34;</span> certificate and key
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>certs<span style="color:#f92672">]</span> Generating <span style="color:#e6db74">&#34;apiserver&#34;</span> certificate and key
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>certs<span style="color:#f92672">]</span> apiserver serving cert is signed <span style="color:#66d9ef">for</span> DNS names <span style="color:#f92672">[</span>kubernetes kubernetes.default kubernetes.default.svc kubernetes.default.svc.cluster.local node1<span style="color:#f92672">]</span> and IPs <span style="color:#f92672">[</span>10.96.0.1 192.168.96.151<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>certs<span style="color:#f92672">]</span> Generating <span style="color:#e6db74">&#34;apiserver-kubelet-client&#34;</span> certificate and key
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>certs<span style="color:#f92672">]</span> Generating <span style="color:#e6db74">&#34;front-proxy-ca&#34;</span> certificate and key
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>certs<span style="color:#f92672">]</span> Generating <span style="color:#e6db74">&#34;front-proxy-client&#34;</span> certificate and key
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>certs<span style="color:#f92672">]</span> Generating <span style="color:#e6db74">&#34;etcd/ca&#34;</span> certificate and key
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>certs<span style="color:#f92672">]</span> Generating <span style="color:#e6db74">&#34;etcd/server&#34;</span> certificate and key
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>certs<span style="color:#f92672">]</span> etcd/server serving cert is signed <span style="color:#66d9ef">for</span> DNS names <span style="color:#f92672">[</span>localhost node1<span style="color:#f92672">]</span> and IPs <span style="color:#f92672">[</span>192.168.96.151 127.0.0.1 ::1<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>certs<span style="color:#f92672">]</span> Generating <span style="color:#e6db74">&#34;etcd/peer&#34;</span> certificate and key
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>certs<span style="color:#f92672">]</span> etcd/peer serving cert is signed <span style="color:#66d9ef">for</span> DNS names <span style="color:#f92672">[</span>localhost node1<span style="color:#f92672">]</span> and IPs <span style="color:#f92672">[</span>192.168.96.151 127.0.0.1 ::1<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>certs<span style="color:#f92672">]</span> Generating <span style="color:#e6db74">&#34;etcd/healthcheck-client&#34;</span> certificate and key
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>certs<span style="color:#f92672">]</span> Generating <span style="color:#e6db74">&#34;apiserver-etcd-client&#34;</span> certificate and key
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>certs<span style="color:#f92672">]</span> Generating <span style="color:#e6db74">&#34;sa&#34;</span> key and public key
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>kubeconfig<span style="color:#f92672">]</span> Using kubeconfig folder <span style="color:#e6db74">&#34;/etc/kubernetes&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>kubeconfig<span style="color:#f92672">]</span> Writing <span style="color:#e6db74">&#34;admin.conf&#34;</span> kubeconfig file
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>kubeconfig<span style="color:#f92672">]</span> Writing <span style="color:#e6db74">&#34;kubelet.conf&#34;</span> kubeconfig file
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>kubeconfig<span style="color:#f92672">]</span> Writing <span style="color:#e6db74">&#34;controller-manager.conf&#34;</span> kubeconfig file
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>kubeconfig<span style="color:#f92672">]</span> Writing <span style="color:#e6db74">&#34;scheduler.conf&#34;</span> kubeconfig file
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>kubelet-start<span style="color:#f92672">]</span> Writing kubelet environment file with flags to file <span style="color:#e6db74">&#34;/var/lib/kubelet/kubeadm-flags.env&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>kubelet-start<span style="color:#f92672">]</span> Writing kubelet configuration to file <span style="color:#e6db74">&#34;/var/lib/kubelet/config.yaml&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>kubelet-start<span style="color:#f92672">]</span> Starting the kubelet
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>control-plane<span style="color:#f92672">]</span> Using manifest folder <span style="color:#e6db74">&#34;/etc/kubernetes/manifests&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>control-plane<span style="color:#f92672">]</span> Creating static Pod manifest <span style="color:#66d9ef">for</span> <span style="color:#e6db74">&#34;kube-apiserver&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>control-plane<span style="color:#f92672">]</span> Creating static Pod manifest <span style="color:#66d9ef">for</span> <span style="color:#e6db74">&#34;kube-controller-manager&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>control-plane<span style="color:#f92672">]</span> Creating static Pod manifest <span style="color:#66d9ef">for</span> <span style="color:#e6db74">&#34;kube-scheduler&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>etcd<span style="color:#f92672">]</span> Creating static Pod manifest <span style="color:#66d9ef">for</span> local etcd in <span style="color:#e6db74">&#34;/etc/kubernetes/manifests&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>wait-control-plane<span style="color:#f92672">]</span> Waiting <span style="color:#66d9ef">for</span> the kubelet to boot up the control plane as static Pods from directory <span style="color:#e6db74">&#34;/etc/kubernetes/manifests&#34;</span>. This can take up to 4m0s
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>apiclient<span style="color:#f92672">]</span> All control plane components are healthy after 17.506804 seconds
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>upload-config<span style="color:#f92672">]</span> Storing the configuration used in ConfigMap <span style="color:#e6db74">&#34;kubeadm-config&#34;</span> in the <span style="color:#e6db74">&#34;kube-system&#34;</span> Namespace
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>kubelet<span style="color:#f92672">]</span> Creating a ConfigMap <span style="color:#e6db74">&#34;kubelet-config&#34;</span> in namespace kube-system with the configuration <span style="color:#66d9ef">for</span> the kubelets in the cluster
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>upload-certs<span style="color:#f92672">]</span> Skipping phase. Please see --upload-certs
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>mark-control-plane<span style="color:#f92672">]</span> Marking the node node1 as control-plane by adding the labels: <span style="color:#f92672">[</span>node-role.kubernetes.io/control-plane node.kubernetes.io/exclude-from-external-load-balancers<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>mark-control-plane<span style="color:#f92672">]</span> Marking the node node1 as control-plane by adding the taints <span style="color:#f92672">[</span>node-role.kubernetes.io/master:PreferNoSchedule<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>bootstrap-token<span style="color:#f92672">]</span> Using token: uufqmm.bvtfj4drwfvvbcev
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>bootstrap-token<span style="color:#f92672">]</span> Configuring bootstrap tokens, cluster-info ConfigMap, RBAC Roles
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>bootstrap-token<span style="color:#f92672">]</span> Configured RBAC rules to allow Node Bootstrap tokens to get nodes
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>bootstrap-token<span style="color:#f92672">]</span> Configured RBAC rules to allow Node Bootstrap tokens to post CSRs in order <span style="color:#66d9ef">for</span> nodes to get long term certificate credentials
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>bootstrap-token<span style="color:#f92672">]</span> Configured RBAC rules to allow the csrapprover controller automatically approve CSRs from a Node Bootstrap Token
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>bootstrap-token<span style="color:#f92672">]</span> Configured RBAC rules to allow certificate rotation <span style="color:#66d9ef">for</span> all node client certificates in the cluster
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>bootstrap-token<span style="color:#f92672">]</span> Creating the <span style="color:#e6db74">&#34;cluster-info&#34;</span> ConfigMap in the <span style="color:#e6db74">&#34;kube-public&#34;</span> namespace
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>kubelet-finalize<span style="color:#f92672">]</span> Updating <span style="color:#e6db74">&#34;/etc/kubernetes/kubelet.conf&#34;</span> to point to a rotatable kubelet client certificate and key
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>addons<span style="color:#f92672">]</span> Applied essential addon: CoreDNS
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>addons<span style="color:#f92672">]</span> Applied essential addon: kube-proxy
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Your Kubernetes control-plane has initialized successfully!
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>To start using your cluster, you need to run the following as a regular user:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  mkdir -p $HOME/.kube
</span></span><span style="display:flex;"><span>  sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
</span></span><span style="display:flex;"><span>  sudo chown <span style="color:#66d9ef">$(</span>id -u<span style="color:#66d9ef">)</span>:<span style="color:#66d9ef">$(</span>id -g<span style="color:#66d9ef">)</span> $HOME/.kube/config
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Alternatively, <span style="color:#66d9ef">if</span> you are the root user, you can run:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  export KUBECONFIG<span style="color:#f92672">=</span>/etc/kubernetes/admin.conf
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>You should now deploy a pod network to the cluster.
</span></span><span style="display:flex;"><span>Run <span style="color:#e6db74">&#34;kubectl apply -f [podnetwork].yaml&#34;</span> with one of the options listed at:
</span></span><span style="display:flex;"><span>  https://kubernetes.io/docs/concepts/cluster-administration/addons/
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Then you can join any number of worker nodes by running the following on each as root:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kubeadm join 192.168.10.20:6443 --token uufqmm.bvtfj4drwfvvbcev <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>	--discovery-token-ca-cert-hash sha256:5814415567d93f6d2d41fe4719be8221f45c29c482b5059aec2e27a832ac36e6
</span></span></code></pre></div><p>上面记录了完成的初始化输出的内容，根据输出的内容基本上可以看出手动初始化安装一个Kubernetes集群所需要的关键步骤。 其中有以下关键内容：</p>
<ul>
<li>
<p><code>[certs]</code>生成相关的各种证书</p>
</li>
<li>
<p><code>[kubeconfig]</code>生成相关的kubeconfig文件</p>
</li>
<li>
<p><code>[kubelet-start]</code> 生成kubelet的配置文件&quot;/var/lib/kubelet/config.yaml&quot;</p>
</li>
<li>
<p><code>[control-plane]</code>使用<code>/etc/kubernetes/manifests</code>目录中的yaml文件创建apiserver、controller-manager、scheduler的静态pod</p>
</li>
<li>
<p><code>[bootstraptoken]</code>生成token记录下来，后边使用<code>kubeadm join</code>往集群中添加节点时会用到</p>
</li>
<li>
<p>下面的命令是配置常规用户如何使用kubectl访问集群：master节点</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>mkdir -p $HOME/.kube
</span></span><span style="display:flex;"><span>sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
</span></span><span style="display:flex;"><span>sudo chown <span style="color:#66d9ef">$(</span>id -u<span style="color:#66d9ef">)</span>:<span style="color:#66d9ef">$(</span>id -g<span style="color:#66d9ef">)</span> $HOME/.kube/config
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>export KUBECONFIG<span style="color:#f92672">=</span>/etc/kubernetes/admin.conf
</span></span></code></pre></div></li>
<li>
<p>最后给出了将节点加入集群的命令</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubeadm join 192.168.10.20:6443 --token uufqmm.bvtfj4drwfvvbcev <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>	--discovery-token-ca-cert-hash sha256:5814415567d93f6d2d41fe4719be8221f45c29c482b5059aec2e27a832ac36e6
</span></span></code></pre></div></li>
</ul>
<p>查看一下集群状态，确认个组件都处于healthy状态，结果出现了错误:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl get cs
</span></span><span style="display:flex;"><span>Warning: v1 ComponentStatus is deprecated in v1.19+
</span></span><span style="display:flex;"><span>NAME                 STATUS    MESSAGE                         ERROR
</span></span><span style="display:flex;"><span>scheduler            Healthy   ok
</span></span><span style="display:flex;"><span>controller-manager   Healthy   ok
</span></span><span style="display:flex;"><span>etcd-0               Healthy   <span style="color:#f92672">{</span><span style="color:#e6db74">&#34;health&#34;</span>:<span style="color:#e6db74">&#34;true&#34;</span>,<span style="color:#e6db74">&#34;reason&#34;</span>:<span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">}</span>
</span></span></code></pre></div><h2 id="22-kubeadm-reset">2.2 kubeadm reset<a hidden class="anchor" aria-hidden="true" href="#22-kubeadm-reset">#</a></h2>
<p>集群初始化如果遇到问题，可以使用</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubeadm reset
</span></span><span style="display:flex;"><span>iptables -F <span style="color:#f92672">&amp;&amp;</span> iptables -t nat -F <span style="color:#f92672">&amp;&amp;</span> iptables -t mangle -F <span style="color:#f92672">&amp;&amp;</span> iptables -X
</span></span></code></pre></div><p>命令进行清理。</p>
<h2 id="23-安装helm-3">2.3 安装helm 3<a hidden class="anchor" aria-hidden="true" href="#23-安装helm-3">#</a></h2>
<p>Helm是Kubernetes的包管理器，后续流程也将使用Helm安装Kubernetes的常用组件。 这里先在master节点node1上安装helm。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>wget https://repo.huaweicloud.com/helm/v3.11.2/helm-v3.11.2-linux-amd64.tar.gz
</span></span><span style="display:flex;"><span>tar -zxvf helm-v3.9.0-linux-amd64.tar.gz
</span></span><span style="display:flex;"><span>mv linux-amd64/helm  /usr/local/bin/
</span></span></code></pre></div><h2 id="24-部署network组件calico">2.4 部署Network组件Calico<a hidden class="anchor" aria-hidden="true" href="#24-部署network组件calico">#</a></h2>
<p><a href="https://www.golinuxcloud.com/calico-kubernetes/">https://www.golinuxcloud.com/calico-kubernetes/</a></p>
<p><a href="https://blog.csdn.net/qq_34556414/article/details/114937418">https://blog.csdn.net/qq_34556414/article/details/114937418</a></p>
<p><a href="https://www.cnblogs.com/Cylon/p/14399682.html">https://www.cnblogs.com/Cylon/p/14399682.html</a></p>
<p><a href="https://blog.csdn.net/maomao5945/article/details/100773007">https://blog.csdn.net/maomao5945/article/details/100773007</a></p>
<h4 id="install-calico">Install Calico<a hidden class="anchor" aria-hidden="true" href="#install-calico">#</a></h4>
<ol>
<li>
<p>Download Calico CNI plugin</p>
<p>We will download the Calico networking manifest and use it to install the plugin for the Kubernetes API datastore.</p>
<pre tabindex="0"><code>[root@controller ~]# wget https://docs.projectcalico.org/v3.25/manifests/calico.yaml
</code></pre></li>
<li>
<p>Modify pod CIDR (Optional)</p>
<p>Next you must assign a pod CIDR subnet. CIDR stands for Classless Inter-Domain Routing, also known as <em>supernetting</em>. By default Calico assumes that you wish to assign <code>192.168.0.0/16</code> subnet for the pod network but if you wish to choose any other subnet then you can add the same in <code>calico.yaml</code> file.</p>
<p>I am already using <code>192.168.0.0/24</code> for my Kubernetes Cluster and I don&rsquo;t want to use the same range for my Pods. So I will assign a random subnet <code>10.142.0.0/24</code> as my CIDR for pods.</p>
<p>We will open the <code>calico.yaml</code> using vim editor and modify <code>CALICO_IPV4POOL_CIDR</code> variable in the manifest and set it to <code>10.142.0.0/24</code> as shown below:</p>
<pre tabindex="0"><code>            - name: CALICO_IPV4POOL_CIDR
              value: &#34;10.142.0.0/24&#34;
</code></pre></li>
<li>
<p>Install Calico Plugin</p>
<p>Next we can go ahead and install the Calico network using <code>kubectl</code> command with calico manifest file:</p>
<pre tabindex="0"><code>[root@controller ~]# kubectl apply -f calico.yaml
</code></pre></li>
<li>
<p>Confirm that all of the pods are running with the following command.</p>
<pre tabindex="0"><code>watch kubectl get pods -n kube-system
</code></pre><p>Wait until each pod has the <code>STATUS</code> of <code>Running</code>.</p>
<blockquote>
<p><strong>Note</strong>: The Tigera operator installs resources in the <code>calico-system</code> namespace. Other install methods may use the <code>kube-system</code> namespace instead.</p>
</blockquote>
</li>
</ol>
<p><a href="https://www.tigera.io/blog/advertising-kubernetes-service-ips-with-calico-and-bgp/">https://www.tigera.io/blog/advertising-kubernetes-service-ips-with-calico-and-bgp/</a></p>
<p>host network</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>calicoctl apply -f - <span style="color:#e6db74">&lt;&lt; EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: projectcalico.org/v3
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: BGPPeer
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  name: bgppeer-global-64512
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">spec:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  peerIP: 192.168.10.6
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  asNumber: 64512
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div><p>pod network  service network</p>
<pre tabindex="0"><code>calicoctl create -f - &lt;&lt;EOF
apiVersion: projectcalico.org/v3
kind: BGPConfiguration
metadata:
  name: default
spec:
  serviceClusterIPs:
  - cidr: 10.96.0.0/12
  - cidr: 10.16.0.0/12
EOF
</code></pre><p>选择calico作为k8s的Pod网络组件，下面使用helm在k8s集群中安装calico。</p>
<p>下载<code>tigera-operator</code>的<code>helm chart</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>wget https://github.com/projectcalico/calico/releases/download/v3.23.1/tigera-operator-v3.23.1.tgz
</span></span></code></pre></div><p>查看这个chart的中可定制的配置:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#ae81ff">helm show values tigera-operator-v3.23.1.tgz</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">imagePullSecrets</span>: {}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">installation</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">kubernetesProvider</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiServer</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">certs</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">node</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">key</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">cert</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">commonName</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">typha</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">key</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">cert</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">commonName</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">caBundle</span>:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">resources</span>: {}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Configuration for the tigera operator</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">tigeraOperator</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">image</span>: <span style="color:#ae81ff">tigera/operator</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">version</span>: <span style="color:#ae81ff">v1.27.1</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">registry</span>: <span style="color:#ae81ff">quay.io</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">calicoctl</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">image</span>: <span style="color:#ae81ff">docker.io/calico/ctl</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">tag</span>: <span style="color:#ae81ff">v3.23.1</span>
</span></span></code></pre></div><p>定制的<code>values.yaml</code>如下:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 可针对上面的配置进行定制,例如calico的镜像改成从私有库拉取。</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 这里只是个人本地环境测试k8s新版本，因此保留value.yaml为空即可</span>
</span></span></code></pre></div><p>使用helm安装calico：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>helm install calico tigera-operator-v3.23.1.tgz -n kube-system  --create-namespace -f values.yaml
</span></span></code></pre></div><p>等待并确认所有pod处于Running状态:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl get pod -n kube-system | grep tigera-operator
</span></span><span style="display:flex;"><span>tigera-operator-5fb55776df-wxbph   1/1     Running   <span style="color:#ae81ff">0</span>             5m10s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kubectl get pods -n calico-system
</span></span><span style="display:flex;"><span>NAME                                       READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>calico-kube-controllers-68884f975d-5d7p9   1/1     Running   <span style="color:#ae81ff">0</span>          5m24s
</span></span><span style="display:flex;"><span>calico-node-twbdh                          1/1     Running   <span style="color:#ae81ff">0</span>          5m24s
</span></span><span style="display:flex;"><span>calico-typha-7b4bdd99c5-ssdn2              1/1     Running   <span style="color:#ae81ff">0</span>          5m24s
</span></span></code></pre></div><p>查看一下calico向k8s中添加的api资源:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl api-resources | grep calico
</span></span><span style="display:flex;"><span>bgpconfigurations                                                                 crd.projectcalico.org/v1               false        BGPConfiguration
</span></span><span style="display:flex;"><span>bgppeers                                                                          crd.projectcalico.org/v1               false        BGPPeer
</span></span><span style="display:flex;"><span>blockaffinities                                                                   crd.projectcalico.org/v1               false        BlockAffinity
</span></span><span style="display:flex;"><span>caliconodestatuses                                                                crd.projectcalico.org/v1               false        CalicoNodeStatus
</span></span><span style="display:flex;"><span>clusterinformations                                                               crd.projectcalico.org/v1               false        ClusterInformation
</span></span><span style="display:flex;"><span>felixconfigurations                                                               crd.projectcalico.org/v1               false        FelixConfiguration
</span></span><span style="display:flex;"><span>globalnetworkpolicies                                                             crd.projectcalico.org/v1               false        GlobalNetworkPolicy
</span></span><span style="display:flex;"><span>globalnetworksets                                                                 crd.projectcalico.org/v1               false        GlobalNetworkSet
</span></span><span style="display:flex;"><span>hostendpoints                                                                     crd.projectcalico.org/v1               false        HostEndpoint
</span></span><span style="display:flex;"><span>ipamblocks                                                                        crd.projectcalico.org/v1               false        IPAMBlock
</span></span><span style="display:flex;"><span>ipamconfigs                                                                       crd.projectcalico.org/v1               false        IPAMConfig
</span></span><span style="display:flex;"><span>ipamhandles                                                                       crd.projectcalico.org/v1               false        IPAMHandle
</span></span><span style="display:flex;"><span>ippools                                                                           crd.projectcalico.org/v1               false        IPPool
</span></span><span style="display:flex;"><span>ipreservations                                                                    crd.projectcalico.org/v1               false        IPReservation
</span></span><span style="display:flex;"><span>kubecontrollersconfigurations                                                     crd.projectcalico.org/v1               false        KubeControllersConfiguration
</span></span><span style="display:flex;"><span>networkpolicies                                                                   crd.projectcalico.org/v1               true         NetworkPolicy
</span></span><span style="display:flex;"><span>networksets                                                                       crd.projectcalico.org/v1               true         NetworkSet
</span></span><span style="display:flex;"><span>bgpconfigurations                 bgpconfig,bgpconfigs                            projectcalico.org/v3                   false        BGPConfiguration
</span></span><span style="display:flex;"><span>bgppeers                                                                          projectcalico.org/v3                   false        BGPPeer
</span></span><span style="display:flex;"><span>caliconodestatuses                caliconodestatus                                projectcalico.org/v3                   false        CalicoNodeStatus
</span></span><span style="display:flex;"><span>clusterinformations               clusterinfo                                     projectcalico.org/v3                   false        ClusterInformation
</span></span><span style="display:flex;"><span>felixconfigurations               felixconfig,felixconfigs                        projectcalico.org/v3                   false        FelixConfiguration
</span></span><span style="display:flex;"><span>globalnetworkpolicies             gnp,cgnp,calicoglobalnetworkpolicies            projectcalico.org/v3                   false        GlobalNetworkPolicy
</span></span><span style="display:flex;"><span>globalnetworksets                                                                 projectcalico.org/v3                   false        GlobalNetworkSet
</span></span><span style="display:flex;"><span>hostendpoints                     hep,heps                                        projectcalico.org/v3                   false        HostEndpoint
</span></span><span style="display:flex;"><span>ippools                                                                           projectcalico.org/v3                   false        IPPool
</span></span><span style="display:flex;"><span>ipreservations                                                                    projectcalico.org/v3                   false        IPReservation
</span></span><span style="display:flex;"><span>kubecontrollersconfigurations                                                     projectcalico.org/v3                   false        KubeControllersConfiguration
</span></span><span style="display:flex;"><span>networkpolicies                   cnp,caliconetworkpolicy,caliconetworkpolicies   projectcalico.org/v3                   true         NetworkPolicy
</span></span><span style="display:flex;"><span>networksets                       netsets                                         projectcalico.org/v3                   true         NetworkSet
</span></span><span style="display:flex;"><span>profiles                                                                          projectcalico.org/v3                   false        Profile
</span></span></code></pre></div><p>这些api资源是属于calico的，因此不建议使用kubectl来管理，推荐按照calicoctl来管理这些api资源。 将calicoctl安装为kubectl的插件:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cd /usr/local/bin
</span></span><span style="display:flex;"><span>curl -o kubectl-calico -O -L  <span style="color:#e6db74">&#34;https://github.com/projectcalico/calicoctl/releases/download/v3.21.5/calicoctl-linux-amd64&#34;</span> 
</span></span><span style="display:flex;"><span>chmod +x kubectl-calico
</span></span></code></pre></div><p>验证插件正常工作:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl calico -h
</span></span></code></pre></div><h2 id="24-部署network组件kube-ovn">2.4 部署Network组件kube-ovn<a hidden class="anchor" aria-hidden="true" href="#24-部署network组件kube-ovn">#</a></h2>
<p>安装install.sh之前确认</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>--pod-network-cidr<span style="color:#f92672">=</span>10.16.0.0/16 
</span></span><span style="display:flex;"><span>--service-cidr<span style="color:#f92672">=</span>10.96.0.0/12
</span></span></code></pre></div><p>要和install.sh里面的POD_CIDR、SVC_CIDR一致</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>POD_CIDR<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;10.16.0.0/16&#34;</span>                <span style="color:#75715e"># Do NOT overlap with NODE/SVC/JOIN CIDR</span>
</span></span><span style="display:flex;"><span>POD_GATEWAY<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;10.16.0.1&#34;</span>
</span></span><span style="display:flex;"><span>SVC_CIDR<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;10.96.0.0/12&#34;</span>                <span style="color:#75715e"># Do NOT overlap with NODE/POD/JOIN CIDR</span>
</span></span><span style="display:flex;"><span>JOIN_CIDR<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;100.64.0.0/16&#34;</span>              <span style="color:#75715e"># Do NOT overlap with NODE/POD/SVC CIDR</span>
</span></span><span style="display:flex;"><span>PINGER_EXTERNAL_ADDRESS<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;114.114.114.114&#34;</span>  <span style="color:#75715e"># Pinger check external ip probe</span>
</span></span><span style="display:flex;"><span>PINGER_EXTERNAL_DOMAIN<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;alauda.cn&#34;</span>         <span style="color:#75715e"># Pinger check external domain probe</span>
</span></span><span style="display:flex;"><span>SVC_YAML_IPFAMILYPOLICY<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;&#34;</span>
</span></span></code></pre></div><p>执行安装脚本</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>wget https://raw.githubusercontent.com/kubeovn/kube-ovn/master/dist/images/install.sh -o install.sh
</span></span><span style="display:flex;"><span>sh install.sh
</span></span></code></pre></div><h2 id="25-验证k8s-dns是否可用">2.5 验证k8s DNS是否可用<a hidden class="anchor" aria-hidden="true" href="#25-验证k8s-dns是否可用">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl run curl --image<span style="color:#f92672">=</span>radial/busyboxplus:curl -it
</span></span><span style="display:flex;"><span>If you don<span style="color:#960050;background-color:#1e0010">&#39;</span>t see a command prompt, try pressing enter.
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span> root@curl:/ <span style="color:#f92672">]</span>$
</span></span></code></pre></div><p>进入后执行<code>nslookup kubernetes.default</code>确认解析正常:</p>
<pre tabindex="0"><code class="language-fallback" data-lang="fallback">nslookup kubernetes.default
Server:    10.96.0.10
Address 1: 10.96.0.10 kube-dns.kube-system.svc.cluster.local

Name:      kubernetes.default
Address 1: 10.96.0.1 kubernetes.default.svc.cluster.local
</code></pre><h2 id="26-添加node节点">2.6 添加Node节点<a hidden class="anchor" aria-hidden="true" href="#26-添加node节点">#</a></h2>
<p>下面将node2, node3添加到Kubernetes集群中，分别在node01, node02, node03上执行:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubeadm join 192.168.10.20:6443 --token uufqmm.bvtfj4drwfvvbcev <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>	--discovery-token-ca-cert-hash sha256:5814415567d93f6d2d41fe4719be8221f45c29c482b5059aec2e27a832ac36e6
</span></span></code></pre></div><p>node01, node02, node03加入集群很是顺利，在master节点上执行命令查看集群中的节点：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@master ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get nodes</span>
</span></span><span style="display:flex;"><span>NAME     STATUS   ROLES           AGE    VERSION
</span></span><span style="display:flex;"><span>master   Ready    control-plane   7h3m   v1.24.3
</span></span><span style="display:flex;"><span>node01   Ready    &lt;none&gt;          7h2m   v1.24.3
</span></span><span style="display:flex;"><span>node02   Ready    &lt;none&gt;          7h2m   v1.24.3
</span></span><span style="display:flex;"><span>node03   Ready    &lt;none&gt;          7h2m   v1.24.3
</span></span></code></pre></div><h1 id="multus-networking">Multus Networking<a hidden class="anchor" aria-hidden="true" href="#multus-networking">#</a></h1>
<h1 id="redis-operrator">redis operrator<a hidden class="anchor" aria-hidden="true" href="#redis-operrator">#</a></h1>
<pre tabindex="0"><code>kubectl  create ns operator-redis-ibm
kubectl  apply -f ../redis-rbac.yaml

helm install op charts/operator-for-redis --wait --set image.repository=ibmcom/operator-for-redis --set image.tag=latest  -n operator-redis-ibm
helm install --wait mycluster charts/node-for-redis --set image.repository=ibmcom/node-for-redis --set image.tag=latest -n operator-redis-ibm
</code></pre><h1 id="3-ipvs支持">3. ipvs支持<a hidden class="anchor" aria-hidden="true" href="#3-ipvs支持">#</a></h1>
<p>1.启用netfilter模块</p>
<pre tabindex="0"><code>modprobe br_netfilter
</code></pre><p>2.修改内核参数</p>
<pre tabindex="0"><code>cat &gt;&gt; /etc/sysctl.conf &lt;&lt; EOF
net.bridge.bridge-nf-call-ip6tables = 1
net.bridge.bridge-nf-call-iptables = 1
net.ipv4.ip_forward = 1
vm.swappiness = 0
EOF
 
sysctl -p
</code></pre><p>3.安装ipvs支持</p>
<pre tabindex="0"><code>yum -y install ipvsadm ipset
</code></pre><p>4.启用ipvs模块</p>
<pre tabindex="0"><code>cat &gt; /etc/sysconfig/modules/ipvs.modules &lt;&lt; EOF
#!/bin/bash
modprobe -- ip_vs
modprobe -- ip_vs_rr
modprobe -- ip_vs_wrr
modprobe -- ip_vs_sh
modprobe -- nf_conntrack_ipv4
EOF
 
chmod 755 /etc/sysconfig/modules/ipvs.modules
source /etc/sysconfig/modules/ipvs.modules
</code></pre><p>5.修改configmap并重启kube-proxy</p>
<pre tabindex="0"><code>kubectl edit cm kube-proxy -n kube-system  # mode: &#34;ipvs&#34;
kubectl get pod -n kube-system | grep kube-proxy | awk &#39;{print $1}&#39; | xargs kubectl -n kube-system delete pod
</code></pre><p>6.验证</p>
<pre tabindex="0"><code>ipvsadm -Ln
</code></pre><h1 id="4-kubernetes常用组件部署">4. Kubernetes常用组件部署<a hidden class="anchor" aria-hidden="true" href="#4-kubernetes常用组件部署">#</a></h1>
<h2 id="remotewrite使能">remoteWrite使能<a hidden class="anchor" aria-hidden="true" href="#remotewrite使能">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">remoteWrite</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">url</span>: <span style="color:#ae81ff">http://192.168.10.200:8428/api/v1/write</span>
</span></span></code></pre></div><h2 id="41-安装prometheus-grafana">4.1 安装Prometheus Grafana<a hidden class="anchor" aria-hidden="true" href="#41-安装prometheus-grafana">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>git clone https://github.com/prometheus-operator/kube-prometheus
</span></span><span style="display:flex;"><span>kubectl apply --server-side -f kube-prometheus/manifests/setup
</span></span><span style="display:flex;"><span>kubectl apply --server-side -f kube-prometheus/manifests
</span></span></code></pre></div><p>注意版本对应：</p>
<table>
<thead>
<tr>
<th>kube-prometheus stack</th>
<th>Kubernetes 1.21</th>
<th>Kubernetes 1.22</th>
<th>Kubernetes 1.23</th>
<th>Kubernetes 1.24</th>
<th>Kubernetes 1.25</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://github.com/prometheus-operator/kube-prometheus/tree/release-0.11"><code>release-0.11</code></a></td>
<td>✗</td>
<td>✗</td>
<td>✔</td>
<td>✔</td>
<td>✗</td>
</tr>
<tr>
<td><a href="https://github.com/prometheus-operator/kube-prometheus/tree/release-0.12"><code>release-0.12</code></a></td>
<td>✗</td>
<td>✗</td>
<td>✗</td>
<td>✔</td>
<td>✔</td>
</tr>
<tr>
<td><a href="https://github.com/prometheus-operator/kube-prometheus/tree/main"><code>main</code></a></td>
<td>✗</td>
<td>✗</td>
<td>✗</td>
<td>✗</td>
<td>✔</td>
</tr>
</tbody>
</table>
<p>Network Policies会导致节点访问限制：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>[root<span style="color:#a6e22e">@master</span> manifests]<span style="color:#75715e"># ls -alrth *networkPolicy*</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">-</span>rw<span style="color:#f92672">-</span>r<span style="color:#f92672">--</span>r<span style="color:#f92672">--</span> <span style="color:#ae81ff">1</span> root root  <span style="color:#ae81ff">694</span> <span style="color:#ae81ff">7</span>月  <span style="color:#ae81ff">22</span> <span style="color:#ae81ff">23</span>:<span style="color:#ae81ff">04</span> prometheusOperator<span style="color:#f92672">-</span>networkPolicy<span style="color:#f92672">.</span>yaml
</span></span><span style="display:flex;"><span><span style="color:#f92672">-</span>rw<span style="color:#f92672">-</span>r<span style="color:#f92672">--</span>r<span style="color:#f92672">--</span> <span style="color:#ae81ff">1</span> root root  <span style="color:#ae81ff">564</span> <span style="color:#ae81ff">7</span>月  <span style="color:#ae81ff">22</span> <span style="color:#ae81ff">23</span>:<span style="color:#ae81ff">04</span> prometheusAdapter<span style="color:#f92672">-</span>networkPolicy<span style="color:#f92672">.</span>yaml
</span></span><span style="display:flex;"><span><span style="color:#f92672">-</span>rw<span style="color:#f92672">-</span>r<span style="color:#f92672">--</span>r<span style="color:#f92672">--</span> <span style="color:#ae81ff">1</span> root root  <span style="color:#ae81ff">671</span> <span style="color:#ae81ff">7</span>月  <span style="color:#ae81ff">22</span> <span style="color:#ae81ff">23</span>:<span style="color:#ae81ff">04</span> nodeExporter<span style="color:#f92672">-</span>networkPolicy<span style="color:#f92672">.</span>yaml
</span></span><span style="display:flex;"><span><span style="color:#f92672">-</span>rw<span style="color:#f92672">-</span>r<span style="color:#f92672">--</span>r<span style="color:#f92672">--</span> <span style="color:#ae81ff">1</span> root root  <span style="color:#ae81ff">723</span> <span style="color:#ae81ff">7</span>月  <span style="color:#ae81ff">22</span> <span style="color:#ae81ff">23</span>:<span style="color:#ae81ff">04</span> kubeStateMetrics<span style="color:#f92672">-</span>networkPolicy<span style="color:#f92672">.</span>yaml
</span></span><span style="display:flex;"><span><span style="color:#f92672">-</span>rw<span style="color:#f92672">-</span>r<span style="color:#f92672">--</span>r<span style="color:#f92672">--</span> <span style="color:#ae81ff">1</span> root root  <span style="color:#ae81ff">722</span> <span style="color:#ae81ff">7</span>月  <span style="color:#ae81ff">22</span> <span style="color:#ae81ff">23</span>:<span style="color:#ae81ff">04</span> blackboxExporter<span style="color:#f92672">-</span>networkPolicy<span style="color:#f92672">.</span>yaml
</span></span><span style="display:flex;"><span><span style="color:#f92672">-</span>rw<span style="color:#f92672">-</span>r<span style="color:#f92672">--</span>r<span style="color:#f92672">--</span> <span style="color:#ae81ff">1</span> root root  <span style="color:#ae81ff">977</span> <span style="color:#ae81ff">7</span>月  <span style="color:#ae81ff">22</span> <span style="color:#ae81ff">23</span>:<span style="color:#ae81ff">04</span> alertmanager<span style="color:#f92672">-</span>networkPolicy<span style="color:#f92672">.</span>yaml
</span></span><span style="display:flex;"><span><span style="color:#f92672">-</span>rw<span style="color:#f92672">-</span>r<span style="color:#f92672">--</span>r<span style="color:#f92672">--</span> <span style="color:#ae81ff">1</span> root root  <span style="color:#ae81ff">651</span> <span style="color:#ae81ff">7</span>月  <span style="color:#ae81ff">24</span> <span style="color:#ae81ff">10</span>:<span style="color:#ae81ff">16</span> grafana<span style="color:#f92672">-</span>networkPolicy<span style="color:#f92672">.</span>yaml
</span></span><span style="display:flex;"><span><span style="color:#f92672">-</span>rw<span style="color:#f92672">-</span>r<span style="color:#f92672">--</span>r<span style="color:#f92672">--</span> <span style="color:#ae81ff">1</span> root root <span style="color:#ae81ff">1.1</span>K <span style="color:#ae81ff">7</span>月  <span style="color:#ae81ff">24</span> <span style="color:#ae81ff">14</span>:<span style="color:#ae81ff">40</span> prometheus<span style="color:#f92672">-</span>networkPolicy<span style="color:#f92672">.</span>yaml
</span></span></code></pre></div><h2 id="42-安装ingress-nginx">4.2 安装ingress-nginx<a hidden class="anchor" aria-hidden="true" href="#42-安装ingress-nginx">#</a></h2>
<p><a href="https://github.com/kubernetes/ingress-nginx">https://github.com/kubernetes/ingress-nginx</a></p>
<p>默认是，daemonset安装前需要给node打标签edgenode，安装在edgenode上：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl label nodes node02 edgenode<span style="color:#f92672">=</span>true
</span></span><span style="display:flex;"><span>kubectl label nodes node03 edgenode<span style="color:#f92672">=</span>true
</span></span><span style="display:flex;"><span>kubectl get node --show-labels
</span></span></code></pre></div><p>执行脚本：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>wget https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.7.1/deploy/static/provider/cloud/deploy.yaml -O ingress/ingress-nginx-deploy-daemonset.yaml
</span></span><span style="display:flex;"><span>kubectl apply -f ingress/ingress-nginx-deploy-daemonset.yaml
</span></span></code></pre></div><p>此次采用daemonset安装，需要修改下面两处</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">DaemonSet</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">hostNetwork</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">nodeSelector</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">edgenode</span>: <span style="color:#e6db74">&#39;true&#39;</span>
</span></span></code></pre></div><p>完整配置：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apps/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">DaemonSet</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app.kubernetes.io/component</span>: <span style="color:#ae81ff">controller</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app.kubernetes.io/instance</span>: <span style="color:#ae81ff">ingress-nginx</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app.kubernetes.io/name</span>: <span style="color:#ae81ff">ingress-nginx</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app.kubernetes.io/part-of</span>: <span style="color:#ae81ff">ingress-nginx</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app.kubernetes.io/version</span>: <span style="color:#ae81ff">1.3.0</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">ingress-nginx-controller</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">ingress-nginx</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">minReadySeconds</span>: <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">revisionHistoryLimit</span>: <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">matchLabels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">app.kubernetes.io/component</span>: <span style="color:#ae81ff">controller</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">app.kubernetes.io/instance</span>: <span style="color:#ae81ff">ingress-nginx</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">app.kubernetes.io/name</span>: <span style="color:#ae81ff">ingress-nginx</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">template</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">app.kubernetes.io/component</span>: <span style="color:#ae81ff">controller</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">app.kubernetes.io/instance</span>: <span style="color:#ae81ff">ingress-nginx</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">app.kubernetes.io/name</span>: <span style="color:#ae81ff">ingress-nginx</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">annotations</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">prometheus.io/port</span>: <span style="color:#e6db74">&#39;10254&#39;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">prometheus.io/scrape</span>: <span style="color:#e6db74">&#39;true&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">args</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#ae81ff">/nginx-ingress-controller</span>
</span></span><span style="display:flex;"><span>        - --<span style="color:#ae81ff">publish-service=$(POD_NAMESPACE)/ingress-nginx-controller</span>
</span></span><span style="display:flex;"><span>        - --<span style="color:#ae81ff">election-id=ingress-controller-leader</span>
</span></span><span style="display:flex;"><span>        - --<span style="color:#ae81ff">controller-class=k8s.io/ingress-nginx</span>
</span></span><span style="display:flex;"><span>        - --<span style="color:#ae81ff">ingress-class=nginx</span>
</span></span><span style="display:flex;"><span>        - --<span style="color:#ae81ff">configmap=$(POD_NAMESPACE)/ingress-nginx-controller</span>
</span></span><span style="display:flex;"><span>        - --<span style="color:#ae81ff">validating-webhook=:8443</span>
</span></span><span style="display:flex;"><span>        - --<span style="color:#ae81ff">validating-webhook-certificate=/usr/local/certificates/cert</span>
</span></span><span style="display:flex;"><span>        - --<span style="color:#ae81ff">validating-webhook-key=/usr/local/certificates/key</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">env</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">POD_NAME</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">valueFrom</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">fieldRef</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">fieldPath</span>: <span style="color:#ae81ff">metadata.name</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">POD_NAMESPACE</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">valueFrom</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">fieldRef</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">fieldPath</span>: <span style="color:#ae81ff">metadata.namespace</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">LD_PRELOAD</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">value</span>: <span style="color:#ae81ff">/usr/local/lib/libmimalloc.so</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">image</span>: <span style="color:#ae81ff">anjia0532/google-containers.ingress-nginx.controller:v1.3.0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">imagePullPolicy</span>: <span style="color:#ae81ff">IfNotPresent</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">lifecycle</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">preStop</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">exec</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">command</span>:
</span></span><span style="display:flex;"><span>              - <span style="color:#ae81ff">/wait-shutdown</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">livenessProbe</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">failureThreshold</span>: <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">httpGet</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/healthz</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">port</span>: <span style="color:#ae81ff">10254</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">scheme</span>: <span style="color:#ae81ff">HTTP</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">initialDelaySeconds</span>: <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">periodSeconds</span>: <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">successThreshold</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">timeoutSeconds</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">name</span>: <span style="color:#ae81ff">controller</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">name</span>: <span style="color:#ae81ff">http</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">protocol</span>: <span style="color:#ae81ff">TCP</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">443</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">name</span>: <span style="color:#ae81ff">https</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">protocol</span>: <span style="color:#ae81ff">TCP</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">8443</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">name</span>: <span style="color:#ae81ff">webhook</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">protocol</span>: <span style="color:#ae81ff">TCP</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">readinessProbe</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">failureThreshold</span>: <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">httpGet</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/healthz</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">port</span>: <span style="color:#ae81ff">10254</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">scheme</span>: <span style="color:#ae81ff">HTTP</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">initialDelaySeconds</span>: <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">periodSeconds</span>: <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">successThreshold</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">timeoutSeconds</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">resources</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">requests</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">cpu</span>: <span style="color:#ae81ff">100m</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">memory</span>: <span style="color:#ae81ff">90Mi</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">securityContext</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">allowPrivilegeEscalation</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">capabilities</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">add</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#ae81ff">NET_BIND_SERVICE</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">drop</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#ae81ff">ALL</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">runAsUser</span>: <span style="color:#ae81ff">101</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">volumeMounts</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/usr/local/certificates/</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">name</span>: <span style="color:#ae81ff">webhook-cert</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">readOnly</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">hostNetwork</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">dnsPolicy</span>: <span style="color:#ae81ff">ClusterFirst</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">nodeSelector</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">edgenode</span>: <span style="color:#e6db74">&#39;true&#39;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">serviceAccountName</span>: <span style="color:#ae81ff">ingress-nginx</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">terminationGracePeriodSeconds</span>: <span style="color:#ae81ff">300</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">volumes</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">webhook-cert</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">secret</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">secretName</span>: <span style="color:#ae81ff">ingress-nginx-admission</span>
</span></span></code></pre></div><p>注意版本对应关系：</p>
<table>
<thead>
<tr>
<th>Ingress-NGINX version</th>
<th>k8s supported version</th>
<th>Alpine Version</th>
<th>Nginx Version</th>
<th>Helm Chart Version</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>v1.7.1</strong></td>
<td>1.27,1.26, 1.25, 1.24</td>
<td>3.17.2</td>
<td>1.21.6</td>
<td>4.6.*</td>
</tr>
<tr>
<td><strong>v1.7.0</strong></td>
<td>1.26, 1.25, 1.24</td>
<td>3.17.2</td>
<td>1.21.6</td>
<td>4.6.*</td>
</tr>
<tr>
<td><strong>v1.6.4</strong></td>
<td>1.26, 1.25, 1.24, 1.23</td>
<td>3.17.0</td>
<td>1.21.6</td>
<td>4.5.*</td>
</tr>
</tbody>
</table>
<h2 id="43-生成域名证书">4.3 生成域名证书<a hidden class="anchor" aria-hidden="true" href="#43-生成域名证书">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>./gen.cert.sh test.dev minio.test.dev
</span></span></code></pre></div><h2 id="44-导入证书">4.4 导入证书<a hidden class="anchor" aria-hidden="true" href="#44-导入证书">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>kubectl create secret  tls test.dev  --key test.dev.key --cert test.dev.crt -n ns-test
</span></span><span style="display:flex;"><span>kubectl create secret  tls test.dev  --key test.dev.key --cert test.dev.crt -n monitoring
</span></span></code></pre></div><h2 id="45-ingress转发prometheus-grafana">4.5 ingress转发prometheus grafana<a hidden class="anchor" aria-hidden="true" href="#45-ingress转发prometheus-grafana">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>kubectl apply -f ingress/ingress-grafana-prometheus-service.yaml
</span></span></code></pre></div><h2 id="46-ingress转发nginx测试服务">4.6 ingress转发nginx测试服务<a hidden class="anchor" aria-hidden="true" href="#46-ingress转发nginx测试服务">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>kubectl create namespace ns-test
</span></span><span style="display:flex;"><span>kubectl apply -f nginx/nginx-deployment.yaml
</span></span><span style="display:flex;"><span>kubectl apply -f nginx/nginx-service.yaml
</span></span><span style="display:flex;"><span>kubectl apply -f ingress/ingress-nginx-service.yaml
</span></span></code></pre></div><h1 id="5-安装bashbord">5. 安装bashbord<a hidden class="anchor" aria-hidden="true" href="#5-安装bashbord">#</a></h1>
<p><a href="https://github.com/kubernetes/dashboard/tree/v2.6.0/aio/deploy">https://github.com/kubernetes/dashboard/tree/v2.6.0/aio/deploy</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>wget  https://raw.githubusercontent.com/kubernetes/dashboard/v2.7.0/aio/deploy/recommended.yaml
</span></span><span style="display:flex;"><span>kubectl apply -f recommended.yaml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>wget https:*//raw.githubusercontent.com/cby-chen/Kubernetes/main/yaml/dashboard-user.yaml*
</span></span><span style="display:flex;"><span>kubectl apply -f dashboard-user.yaml
</span></span></code></pre></div><h2 id="修改为nodeport">修改为nodePort<a hidden class="anchor" aria-hidden="true" href="#修改为nodeport">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>root@k8s-master01:~# kubectl edit svc kubernetes-dashboard -n kubernetes-dashboard
</span></span><span style="display:flex;"><span>service/kubernetes-dashboard edited
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>root@k8s-master01:~# kubectl get svc kubernetes-dashboard -n kubernetes-dashboard
</span></span><span style="display:flex;"><span>NAME                   TYPE       CLUSTER-IP    EXTERNAL-IP   PORT<span style="color:#f92672">(</span>S<span style="color:#f92672">)</span>         AGE
</span></span><span style="display:flex;"><span>kubernetes-dashboard   NodePort   10.96.221.8   &lt;none&gt;        443:32721/TCP   74s
</span></span><span style="display:flex;"><span>root@k8s-master01:~#
</span></span></code></pre></div><h2 id="导入证书">导入证书<a hidden class="anchor" aria-hidden="true" href="#导入证书">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>kubectl create secret  tls test.dev  --key test.dev.key --cert test.dev.crt -n kubernetes-dashboard
</span></span></code></pre></div><h2 id="创建token">创建token<a hidden class="anchor" aria-hidden="true" href="#创建token">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>kubectl -n kubernetes-dashboard create token admin-user
</span></span></code></pre></div><h2 id="dashboard-rbacyaml">dashboard-rbac.yaml<a hidden class="anchor" aria-hidden="true" href="#dashboard-rbacyaml">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ServiceAccount</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">admin-user</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">kubernetes-dashboard</span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">rbac.authorization.k8s.io/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ClusterRoleBinding</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">admin-user</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">roleRef</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">apiGroup</span>: <span style="color:#ae81ff">rbac.authorization.k8s.io</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ClusterRole</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">cluster-admin</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">subjects</span>:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> - <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ServiceAccount</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">name</span>: <span style="color:#ae81ff">admin-user</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">kubernetes-dashboard</span>
</span></span></code></pre></div><h2 id="ingress-bashbordyaml">ingress-bashbord.yaml<a hidden class="anchor" aria-hidden="true" href="#ingress-bashbordyaml">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">networking.k8s.io/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Ingress</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">ingress-kubernetes-dashboard</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">kubernetes-dashboard</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">annotations</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">kubernetes.io/ingress.class</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">nginx.ingress.kubernetes.io/auth-tls-verify-client</span>: <span style="color:#e6db74">&#34;on&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">nginx.ingress.kubernetes.io/auth-tls-pass-certificate-to-upstream</span>: <span style="color:#e6db74">&#34;true&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">nginx.ingress.kubernetes.io/backend-protocol</span>: <span style="color:#e6db74">&#34;HTTPS&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">tls</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">hosts</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">dashboard.test.dev</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">secretName</span>: <span style="color:#ae81ff">test.dev</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">rules</span>:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">host</span>: <span style="color:#ae81ff">dashboard.test.dev</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">http</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">paths</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">pathType</span>: <span style="color:#ae81ff">Prefix</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">backend</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">service</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">name</span>: <span style="color:#ae81ff">kubernetes-dashboard</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">port</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">number</span>: <span style="color:#ae81ff">443</span>
</span></span></code></pre></div><h1 id="6-静态pv">6 静态PV<a hidden class="anchor" aria-hidden="true" href="#6-静态pv">#</a></h1>
<ol>
<li>准备一台机器，搭建NFS服务</li>
</ol>
<pre tabindex="0"><code>yum install nfs-utils
</code></pre><pre tabindex="0"><code>echo &#34;/data/k8s/ 192.168.10.0/24(sync,rw,no_root_squash)&#34; &gt; /etc/exports
cat /etc/exports
 
systemctl start nfs; systemctl start rpcbind 
systemctl enable nfs
</code></pre><ol>
<li>在node节点上测试</li>
</ol>
<pre tabindex="0"><code>yum install nfs-utils
showmount -e 192.168.10.128
</code></pre><ol>
<li>创建pv（master上）</li>
</ol>
<p>vim pv.yaml //内容如下</p>
<pre tabindex="0"><code>kubectl create -f pv.yaml
</code></pre><pre tabindex="0"><code>apiVersion: v1
kind: PersistentVolume
metadata:
  name: pv001
spec:
  capacity:
    storage: 500Gi
  accessModes:
    - ReadWriteMany
  nfs:
    path: /data/k8s/
    server: 192.168.10.12
</code></pre><pre tabindex="0"><code>kubectl get pv
[root@master pv]# kubectl get pv
NAME    CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS      CLAIM   STORAGECLASS   REASON   AGE
pv001   500Gi      RWX            Retain           Available                                   6m48s
</code></pre><p>创建pvc, pvc.yaml</p>
<pre tabindex="0"><code>kubectl create -f pvc.yaml
</code></pre><pre tabindex="0"><code>kind: PersistentVolumeClaim
apiVersion: v1
metadata:
  name: myclaim
spec:
  accessModes:
    - ReadWriteMany
  resources:
    requests:
      storage: 500Gi
</code></pre><pre tabindex="0"><code>[root@master pv]# kubectl get pvc
NAME                      STATUS    VOLUME   CAPACITY   ACCESS MODES   STORAGECLASS   AGE
datadir-redis-cluster-0   Pending                                                     63m
myclaim                   Bound     pv001    500Gi      RWX                           94s
</code></pre><h1 id="7-动态pv创建">7 动态pv创建<a hidden class="anchor" aria-hidden="true" href="#7-动态pv创建">#</a></h1>
<p><a href="https://blog.csdn.net/a13568hki/article/details/124351017">https://blog.csdn.net/a13568hki/article/details/124351017</a></p>
<p><a href="https://artifacthub.io/packages/helm/nfs-subdir-external-provisioner/nfs-subdir-external-provisioner">https://artifacthub.io/packages/helm/nfs-subdir-external-provisioner/nfs-subdir-external-provisioner</a></p>
<p><a href="https://fabianlee.org/2022/01/12/kubernetes-nfs-mount-using-dynamic-volume-and-storage-class/">https://fabianlee.org/2022/01/12/kubernetes-nfs-mount-using-dynamic-volume-and-storage-class/</a></p>
<p>官网：</p>
<p><a href="https://github.com/kubernetes-sigs/nfs-subdir-external-provisioner">https://github.com/kubernetes-sigs/nfs-subdir-external-provisioner</a></p>
<h2 id="nfs-client-provisioneryaml">nfs-client-provisioner.yaml<a hidden class="anchor" aria-hidden="true" href="#nfs-client-provisioneryaml">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Deployment</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apps/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nfs-provisioner-01</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">kube-system</span> <span style="color:#75715e">#与RBAC文件中的namespace保持一致</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">replicas</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">strategy</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">type</span>: <span style="color:#ae81ff">Recreate</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">matchLabels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">app</span>: <span style="color:#ae81ff">nfs-provisioner-01</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">template</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">app</span>: <span style="color:#ae81ff">nfs-provisioner-01</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">serviceAccountName</span>: <span style="color:#ae81ff">nfs-client-provisioner</span> <span style="color:#75715e"># 指定serviceAccount!</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nfs-client-provisioner</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">image</span>: <span style="color:#ae81ff">easzlab/nfs-subdir-external-provisioner:v4.0.2</span> <span style="color:#75715e">#镜像地址</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">imagePullPolicy</span>: <span style="color:#ae81ff">IfNotPresent</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">volumeMounts</span>:  <span style="color:#75715e"># 挂载数据卷到容器指定目录</span>
</span></span><span style="display:flex;"><span>            - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nfs-client-root</span>
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/persistentvolumes  </span> <span style="color:#75715e">#不需要修改</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">env</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">PROVISIONER_NAME</span>
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">value</span>: <span style="color:#ae81ff">nfs-provisioner-01 </span> <span style="color:#75715e"># 此处供应者名字供storageclass调用</span>
</span></span><span style="display:flex;"><span>            - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">NFS_SERVER</span>
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">value</span>: <span style="color:#ae81ff">192.168.10.128</span>   <span style="color:#75715e"># 填入NFS的地址</span>
</span></span><span style="display:flex;"><span>            - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">NFS_PATH</span>
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">value</span>: <span style="color:#ae81ff">/data/k8s  </span> <span style="color:#75715e"># 填入NFS挂载的目录</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">volumes</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nfs-client-root</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">nfs</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">server</span>: <span style="color:#ae81ff">192.168.10.128</span>   <span style="color:#75715e"># 填入NFS的地址</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/data/k8s  </span> <span style="color:#75715e"># 填入NFS挂载的目录</span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">storage.k8s.io/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">StorageClass </span> <span style="color:#75715e"># 创建StorageClass</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nfs-boge</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">annotations</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">storageclass.kubernetes.io/is-default-class</span>: <span style="color:#e6db74">&#34;true&#34;</span>  
</span></span><span style="display:flex;"><span><span style="color:#f92672">provisioner</span>: <span style="color:#ae81ff">nfs-provisioner-01 </span> <span style="color:#75715e">#这里的名称要和provisioner配置文件中的环境变量PROVISIONER_NAME保持一致</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Supported policies: Delete、 Retain ,default is Delete</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">reclaimPolicy</span>: <span style="color:#ae81ff">Retain  </span> <span style="color:#75715e">#清除策略</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#75715e"># nfs-rbac.yaml</span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ServiceAccount</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nfs-client-provisioner</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># replace with namespace where provisioner is deployed</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">default       </span> <span style="color:#75715e">#根据实际环境设定namespace,下面类同</span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ClusterRole</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">rbac.authorization.k8s.io/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nfs-client-provisioner-runner</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">rules</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">apiGroups</span>: [<span style="color:#e6db74">&#34;&#34;</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">resources</span>: [<span style="color:#e6db74">&#34;persistentvolumes&#34;</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">verbs</span>: [<span style="color:#e6db74">&#34;get&#34;</span>, <span style="color:#e6db74">&#34;list&#34;</span>, <span style="color:#e6db74">&#34;watch&#34;</span>, <span style="color:#e6db74">&#34;create&#34;</span>, <span style="color:#e6db74">&#34;delete&#34;</span>]
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">apiGroups</span>: [<span style="color:#e6db74">&#34;&#34;</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">resources</span>: [<span style="color:#e6db74">&#34;persistentvolumeclaims&#34;</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">verbs</span>: [<span style="color:#e6db74">&#34;get&#34;</span>, <span style="color:#e6db74">&#34;list&#34;</span>, <span style="color:#e6db74">&#34;watch&#34;</span>, <span style="color:#e6db74">&#34;update&#34;</span>]
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">apiGroups</span>: [<span style="color:#e6db74">&#34;storage.k8s.io&#34;</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">resources</span>: [<span style="color:#e6db74">&#34;storageclasses&#34;</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">verbs</span>: [<span style="color:#e6db74">&#34;get&#34;</span>, <span style="color:#e6db74">&#34;list&#34;</span>, <span style="color:#e6db74">&#34;watch&#34;</span>]
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">apiGroups</span>: [<span style="color:#e6db74">&#34;&#34;</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">resources</span>: [<span style="color:#e6db74">&#34;events&#34;</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">verbs</span>: [<span style="color:#e6db74">&#34;create&#34;</span>, <span style="color:#e6db74">&#34;update&#34;</span>, <span style="color:#e6db74">&#34;patch&#34;</span>]
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ClusterRoleBinding</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">rbac.authorization.k8s.io/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">run-nfs-client-provisioner</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">subjects</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ServiceAccount</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nfs-client-provisioner</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># replace with namespace where provisioner is deployed</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">default</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">roleRef</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ClusterRole</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nfs-client-provisioner-runner</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">apiGroup</span>: <span style="color:#ae81ff">rbac.authorization.k8s.io</span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Role</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">rbac.authorization.k8s.io/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">leader-locking-nfs-client-provisioner</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># replace with namespace where provisioner is deployed</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">default</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">rules</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">apiGroups</span>: [<span style="color:#e6db74">&#34;&#34;</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">resources</span>: [<span style="color:#e6db74">&#34;endpoints&#34;</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">verbs</span>: [<span style="color:#e6db74">&#34;get&#34;</span>, <span style="color:#e6db74">&#34;list&#34;</span>, <span style="color:#e6db74">&#34;watch&#34;</span>, <span style="color:#e6db74">&#34;create&#34;</span>, <span style="color:#e6db74">&#34;update&#34;</span>, <span style="color:#e6db74">&#34;patch&#34;</span>]
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">RoleBinding</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">rbac.authorization.k8s.io/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">leader-locking-nfs-client-provisioner</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">subjects</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ServiceAccount</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nfs-client-provisioner</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># replace with namespace where provisioner is deployed</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">default</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">roleRef</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Role</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">leader-locking-nfs-client-provisioner</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">apiGroup</span>: <span style="color:#ae81ff">rbac.authorization.k8s.io</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># nfs-StorageClass.yaml</span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">storage.k8s.io/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">StorageClass</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">managed-nfs-storage</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">annotations</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">storageclass.kubernetes.io/is-default-class</span>: <span style="color:#e6db74">&#34;true&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">provisioner</span>: <span style="color:#ae81ff">nfs-storage</span> <span style="color:#75715e">#这里的名称要和provisioner配置文件中的环境变量PROVISIONER_NAME保持一致</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">parameters</span>:
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  archiveOnDelete: &#34;false&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">archiveOnDelete</span>: <span style="color:#e6db74">&#34;true&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">reclaimPolicy</span>: <span style="color:#ae81ff">Retain</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># nfs-provisioner.yaml</span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apps/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Deployment</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nfs-client-provisioner</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app</span>: <span style="color:#ae81ff">nfs-client-provisioner</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># replace with namespace where provisioner is deployed</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">default </span> <span style="color:#75715e">#与RBAC文件中的namespace保持一致</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">replicas</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">matchLabels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">app</span>: <span style="color:#ae81ff">nfs-client-provisioner</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">strategy</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">type</span>: <span style="color:#ae81ff">Recreate</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">matchLabels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">app</span>: <span style="color:#ae81ff">nfs-client-provisioner</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">template</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">app</span>: <span style="color:#ae81ff">nfs-client-provisioner</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">serviceAccountName</span>: <span style="color:#ae81ff">nfs-client-provisioner</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nfs-client-provisioner</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">image</span>: <span style="color:#ae81ff">docker.io/easzlab/nfs-subdir-external-provisioner:v4.0.2</span>
</span></span><span style="display:flex;"><span>          <span style="color:#75715e">#image: quay.io/external_storage/nfs-client-provisioner:latest</span>
</span></span><span style="display:flex;"><span>          <span style="color:#75715e">#这里特别注意，在k8s-1.20以后版本中使用上面提供的包，并不好用，这里我折腾了好久，才解决，后来在官方的github上，别人提的问题中建议使用下面这个包才解决的，我这里是下载后，传到我自已的仓库里</span>
</span></span><span style="display:flex;"><span>          <span style="color:#75715e">#easzlab/nfs-subdir-external-provisioner:v4.0.1 </span>
</span></span><span style="display:flex;"><span>          <span style="color:#75715e">#image: registry-op.test.cn/nfs-subdir-external-provisioner:v4.0.1</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">volumeMounts</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nfs-client-root</span>
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/persistentvolumes</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">env</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">PROVISIONER_NAME</span>
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">value</span>: <span style="color:#ae81ff">nfs-storage </span> <span style="color:#75715e">#provisioner名称,请确保该名称与 nfs-StorageClass.yaml文件中的provisioner名称保持一致</span>
</span></span><span style="display:flex;"><span>            - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">NFS_SERVER</span>
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">value</span>: <span style="color:#ae81ff">192.168.10.220</span>   <span style="color:#75715e">#NFS Server IP地址</span>
</span></span><span style="display:flex;"><span>            - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">NFS_PATH</span>
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">value</span>: <span style="color:#e6db74">&#34;/home/nfs&#34;</span>    <span style="color:#75715e">#NFS挂载卷</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">volumes</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nfs-client-root</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">nfs</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">server</span>: <span style="color:#ae81ff">192.168.10.220</span>  <span style="color:#75715e">#NFS Server IP地址</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">path</span>: <span style="color:#e6db74">&#34;/home/nfs&#34;</span>     <span style="color:#75715e">#NFS 挂载卷</span>
</span></span></code></pre></div><h1 id="8-minio安装">8 Minio安装<a hidden class="anchor" aria-hidden="true" href="#8-minio安装">#</a></h1>
<h2 id="安装minio--operator">安装minio  operator<a hidden class="anchor" aria-hidden="true" href="#安装minio--operator">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>wget https://github.com/minio/operator/releases/download/v4.4.28/kubectl-minio_4.4.28_linux_amd64 -O kubectl-minio
</span></span><span style="display:flex;"><span>chmod +x kubectl-minio
</span></span><span style="display:flex;"><span>mv kubectl-minio /usr/local/bin/
</span></span><span style="display:flex;"><span>kubectl minio init
</span></span></code></pre></div><h2 id="控制界面">控制界面<a hidden class="anchor" aria-hidden="true" href="#控制界面">#</a></h2>
<pre tabindex="0"><code>kubectl minio proxy -n minio-operator
</code></pre><h2 id="创建minio集群">创建minio集群<a hidden class="anchor" aria-hidden="true" href="#创建minio集群">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>kubectl minio tenant create tenant1 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--servers <span style="color:#ae81ff">1</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--volumes <span style="color:#ae81ff">4</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--capacity 1Gi <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--namespace tenant1
</span></span><span style="display:flex;"><span>--storage-class local-path
</span></span></code></pre></div><h2 id="生成3级域名证书">生成3级域名证书<a hidden class="anchor" aria-hidden="true" href="#生成3级域名证书">#</a></h2>
<pre tabindex="0"><code>gen.cert.sh minio.test.dev
</code></pre><h2 id="导入证书-1">导入证书<a hidden class="anchor" aria-hidden="true" href="#导入证书-1">#</a></h2>
<pre tabindex="0"><code>kubectl create secret  tls test.dev  --key test.dev.key --cert test.dev.crt -n tenant1
</code></pre><h2 id="ingress-minioyaml">ingress-minio.yaml<a hidden class="anchor" aria-hidden="true" href="#ingress-minioyaml">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">networking.k8s.io/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Ingress</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">ingress-minio</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">tenant1</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">annotations</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">kubernetes.io/ingress.class</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">nginx.ingress.kubernetes.io/auth-tls-verify-client</span>: <span style="color:#e6db74">&#34;on&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">nginx.ingress.kubernetes.io/auth-tls-pass-certificate-to-upstream</span>: <span style="color:#e6db74">&#34;true&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">nginx.ingress.kubernetes.io/backend-protocol</span>: <span style="color:#e6db74">&#34;HTTPS&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">tls</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">hosts</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">minio.test.dev</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">apiminio.test.dev</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">secretName</span>: <span style="color:#ae81ff">test.dev</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">hosts</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">web.minio.test.dev</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">api.minio.test.dev</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">secretName</span>: <span style="color:#ae81ff">minio.test.dev</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">rules</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">host</span>: <span style="color:#ae81ff">minio.test.dev</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">http</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">paths</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">pathType</span>: <span style="color:#ae81ff">Prefix</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">backend</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">service</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">name</span>: <span style="color:#ae81ff">tenant1-console</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">port</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">number</span>: <span style="color:#ae81ff">9443</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">host</span>: <span style="color:#ae81ff">web.minio.test.dev</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">http</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">paths</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">pathType</span>: <span style="color:#ae81ff">Prefix</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">backend</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">service</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">name</span>: <span style="color:#ae81ff">tenant1-console</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">port</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">number</span>: <span style="color:#ae81ff">9443</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">host</span>: <span style="color:#ae81ff">apiminio.test.dev</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">http</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">paths</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">pathType</span>: <span style="color:#ae81ff">Prefix</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">backend</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">service</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">name</span>: <span style="color:#ae81ff">minio</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">port</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">number</span>: <span style="color:#ae81ff">443</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">host</span>: <span style="color:#ae81ff">api.minio.test.dev</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">http</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">paths</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">pathType</span>: <span style="color:#ae81ff">Prefix</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">backend</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">service</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">name</span>: <span style="color:#ae81ff">minio</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">port</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">number</span>: <span style="color:#ae81ff">443</span>
</span></span></code></pre></div><h2 id="配置域名解析">配置域名解析<a hidden class="anchor" aria-hidden="true" href="#配置域名解析">#</a></h2>
<pre tabindex="0"><code>192.168.10.22 test.dev
192.168.10.23 web.minio.test.dev
192.168.10.22 minio.test.dev
192.168.10.23 api.minio.test.dev
192.168.10.22 apiminio.test.dev
192.168.10.22 www.test.dev
192.168.10.22 grafana.test.dev
192.168.10.23 prometheus.test.dev
192.168.10.23 dashboard.test.dev
</code></pre><h2 id="413-request-entity-too-large">413 Request Entity Too Large<a hidden class="anchor" aria-hidden="true" href="#413-request-entity-too-large">#</a></h2>
<h3 id="方案1-修改自己的ingress">方案1 修改自己的ingress<a hidden class="anchor" aria-hidden="true" href="#方案1-修改自己的ingress">#</a></h3>
<p>nginx.ingress.kubernetes.io/proxy-body-size: 10m</p>
<p>有些后端自带TLS证书这里忽略了后端的证书</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">ingress-minio</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">tenant1</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">annotations</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">kubernetes.io/ingress.class</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">nginx.ingress.kubernetes.io/auth-tls-verify-client</span>: <span style="color:#e6db74">&#34;on&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">nginx.ingress.kubernetes.io/auth-tls-pass-certificate-to-upstream</span>: <span style="color:#e6db74">&#34;true&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">nginx.ingress.kubernetes.io/backend-protocol</span>: <span style="color:#e6db74">&#34;HTTPS&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">nginx.ingress.kubernetes.io/proxy-body-size</span>: <span style="color:#ae81ff">10m</span>
</span></span></code></pre></div><h3 id="方案2-全局-ingress-configmap">方案2 全局 ingress configmap<a hidden class="anchor" aria-hidden="true" href="#方案2-全局-ingress-configmap">#</a></h3>
<p>proxy-body-size: 50000M</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">data</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">allow-snippet-annotations</span>: <span style="color:#e6db74">&#34;true&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">proxy-body-size</span>: <span style="color:#ae81ff">50000M</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ConfigMap</span>
</span></span></code></pre></div><h1 id="6-kube_proxy-service和iptables的关系">6 kube_proxy service和iptables的关系<a hidden class="anchor" aria-hidden="true" href="#6-kube_proxy-service和iptables的关系">#</a></h1>
<p>service 的代理是 kube-proxy</p>
<p>kube-proxy 运行在所有节点上，它监听 apiserver 中 service 和 endpoint 的变化情况，创建路由规则以提供服务 IP 和负载均衡功能。简单理解此进程是Service的透明代理兼负载均衡器，其核心功能是将到某个Service的访问请求转发到后端的多个Pod实例上，而kube-proxy底层又是通过iptables和ipvs实现的</p>
<h3 id="iptables-模式">iptables 模式<a hidden class="anchor" aria-hidden="true" href="#iptables-模式">#</a></h3>
<p>iptables 是一个 Linux 内核功能，是一个高效的防火墙，并提供了大量的数据包处理和过滤方面的能力。它可以在核心数据包处理管线上用 Hook 挂接一系列的规则。iptables 模式中 kube-proxy 在 <code>NAT pre-routing</code> Hook 中实现它的 NAT 和负载均衡功能。这种方法简单有效，依赖于成熟的内核功能，并且能够和其它跟 iptables 协作的应用（例如 Calico）融洽相处。</p>
<p>然而 kube-proxy 的用法是一种 O(n) 算法，其中的 n 随集群规模同步增长，这里的集群规模，更明确的说就是服务和后端 Pod 的数量。</p>
<h3 id="ipvs-模式">ipvs 模式<a hidden class="anchor" aria-hidden="true" href="#ipvs-模式">#</a></h3>
<p>IPVS 是一个用于负载均衡的 Linux 内核功能。IPVS 模式下，kube-proxy 使用 IPVS 负载均衡代替了 iptable。这种模式同样有效，IPVS 的设计就是用来为大量服务进行负载均衡的，它有一套优化过的 API，使用优化的查找算法，而不是简单的从列表中查找规则。</p>
<p>这样一来，kube-proxy 在 IPVS 模式下，其连接过程的复杂度为 O(1)。换句话说，多数情况下，他的连接处理效率是和集群规模无关的。</p>
<p>另外作为一个独立的<a href="https://cloud.tencent.com/product/clb?from=10680">负载均衡器</a>，IPVS 包含了多种不同的负载均衡算法，例如轮询、最短期望延迟、最少连接以及各种哈希方法等。而 iptables 就只有一种随机平等的选择算法。</p>
<p>IPVS 的一个潜在缺点就是，IPVS 处理数据包的路径和通常情况下 iptables 过滤器的路径是不同的。如果计划在有其他程序使用 iptables 的环境中使用 IPVS，需要进行一些研究，看看他们是否能够协调工作。（Calico 已经和 IPVS kube-proxy 兼容）</p>
<h3 id="kube-proxy-ipvs和iptables的异同">kube-proxy ipvs和iptables的异同<a hidden class="anchor" aria-hidden="true" href="#kube-proxy-ipvs和iptables的异同">#</a></h3>
<p>iptables与IPVS都是基于Netfilter实现的，但因为定位不同，二者有着本质的差别：iptables是为防火墙而设计的；IPVS则专门用于高性能负载均衡，并使用更高效的数据结构（Hash表），允许几乎无限的规模扩张。</p>
<p>与iptables相比，IPVS拥有以下明显优势：</p>
<ul>
<li>为大型集群提供了更好的可扩展性和性能；</li>
<li>支持比iptables更复杂的复制均衡算法（最小负载、最少连接、加权等）；</li>
<li>支持服务器健康检查和连接重试等功能；</li>
<li>可以动态修改ipset的集合，即使iptables的规则正在使用这个集合。</li>
</ul>
<h1 id="service">Service<a hidden class="anchor" aria-hidden="true" href="#service">#</a></h1>
<p>NodePort</p>
<p>LoadBalancer</p>
<h1 id="7-calico-bgp-vrf">7 Calico BGP VRF<a hidden class="anchor" aria-hidden="true" href="#7-calico-bgp-vrf">#</a></h1>
<p><a href="https://www.cnblogs.com/linwenye/p/13269871.html">https://www.cnblogs.com/linwenye/p/13269871.html</a></p>
<p><a href="https://larioy.gst.monster/2021/09/05/k8s-ji-chong-cni-fang-an-jie-xi/calico/ensp-mo-ni-calico-kua-wang-duan-bgp-wang-luo/">https://larioy.gst.monster/2021/09/05/k8s-ji-chong-cni-fang-an-jie-xi/calico/ensp-mo-ni-calico-kua-wang-duan-bgp-wang-luo/</a></p>
<p><a href="https://www.cnblogs.com/Cylon/p/14399682.html">https://www.cnblogs.com/Cylon/p/14399682.html</a></p>
<p><strong>Full-mesh</strong></p>
<p>全互联模式，启用了 BGP 之后，Calico 的默认行为是在每个节点彼此对等的情况下创建完整的内部 BGP（iBGP）连接，这使 Calico 可以在任何 L2 网络（无论是公有云还是私有云）上运行，或者说（如果配了 IPIP）可以在任何不禁止 IPIP 流量的网络上作为 overlay 运行。对于 vxlan overlay，Calico 不使用 BGP。</p>
<p>Full-mesh 模式对于 100 个以内的工作节点或更少节点的中小规模部署非常有用，但是在较大的规模上，Full-mesh 模式效率会降低，较大规模情况下，Calico 官方建议使用 Route reflectors</p>
<p><strong>Route reflectors</strong></p>
<p>如果想构建内部 BGP（iBGP）大规模集群，可以使用 BGP 路由反射器来减少每个节点上使用 BGP 对等体的数量。在此模型中，某些节点充当路由反射器，并配置为在它们之间建立完整的网格。然后，将其他节点配置为与这些路由反射器的子集（通常为冗余，通常为 2 个）进行对等，从而与全网格相比减少了 BGP 对等连接的总数。</p>
<p><strong>Top of Rack (ToR)</strong></p>
<p>在本地部署中，可以将 Calico 配置为直接与物理网络基础结构对等。通常，这需要涉及到禁用 Calico 的默认 Full-mesh 行为，将所有 Calico 节点与 L3 ToR 路由器对等。</p>
<h2 id="spine--leaf--rr">spine  Leaf  RR<a hidden class="anchor" aria-hidden="true" href="#spine--leaf--rr">#</a></h2>
<p>最近我司业务扩展在机房新开了一个区域，折腾了一段时间的 Calico BGP，为了能将整个过程梳理得更简单明了，我还是决定将这个过程记录下来。不管是对当下的总结还是未来重新审视方案都是值得的。大家都知道，云原生下的网络架构在 Kubernetes 里可以算是百花齐放，各有所长，这无形中也导致网络始终是横在广大 K8S 爱好者面前迈向高阶管理的几座大山之一。通常大家在公有云上使用厂家提供的 CNI 组件可能还感受不到其复杂，但一旦要在 IDC 自建集群时，就会面临 Kubernetes 网络架构选型的问题。 Calico 作为目前 Kubernetes 上用途最广的 Kubernetes CNI 之一，自然也有很多追随者。而本篇便是在自建机房内 BGP 组网下的一次总结。</p>
<h2 id="关于-cni-选型">关于 CNI 选型<a hidden class="anchor" aria-hidden="true" href="#关于-cni-选型">#</a></h2>
<p>云原生 CNI 组件这么多，诸如老牌的 Flannel、Calico、WeaveNet、Kube-Router 以及近两年兴起的 Antrea、 Kube-OVN 和 Cilium。它们都在各自的场景下各有所长，在选择前我们可以先对其做一个简单的功能性的比较:</p>
<table>
<thead>
<tr>
<th></th>
<th>Flannel</th>
<th>Calico</th>
<th>Cilium</th>
<th>WeaveNet</th>
<th>Antrea</th>
<th>Kube-OVN</th>
</tr>
</thead>
<tbody>
<tr>
<td>部署模式</td>
<td>DaemonSet</td>
<td>DaemonSet</td>
<td>DaemonSet</td>
<td>DaemonSet</td>
<td>DaemonSet</td>
<td>DaemonSet</td>
</tr>
<tr>
<td>包封装与路由</td>
<td>VxLAN</td>
<td>IPinIP,BGP,eBPF</td>
<td>VxLAN,eBPF</td>
<td>VxLAN</td>
<td>Vxlan</td>
<td>Vlan/Geneve/BGP</td>
</tr>
<tr>
<td>网络策略</td>
<td>No</td>
<td>Yes</td>
<td>Yes</td>
<td>Yes</td>
<td>Yes</td>
<td>Yes</td>
</tr>
<tr>
<td>存储引擎</td>
<td>Etcd</td>
<td>Etcd</td>
<td>Etcd</td>
<td>No</td>
<td>Etcd</td>
<td>Etcd</td>
</tr>
<tr>
<td>传输加密</td>
<td>Yes</td>
<td>Yes</td>
<td>Yes</td>
<td>Yes</td>
<td>Yes</td>
<td>No</td>
</tr>
<tr>
<td>运营模式</td>
<td>社区</td>
<td>Tigera</td>
<td>社区</td>
<td>WeaveWorks</td>
<td>VMware</td>
<td>灵雀云</td>
</tr>
</tbody>
</table>
<h2 id="为什么选择-calico">为什么选择 Calico<a hidden class="anchor" aria-hidden="true" href="#为什么选择-calico">#</a></h2>
<p>在对我司机房新区域的网络选型上，我们最终选择了 Calico 作为云端网络解决方案，在这里我们简单阐述下为什么选择 Calico 的几点原因：</p>
<ul>
<li>支持 BGP 广播，Calico 通过 BGP 协议广播路由信息，且架构非常简单。在 kubernetes 可以很容易的实现 mesh to mesh 或者 RR 模式，在后期如果要实现容器跨集群网络通信时，实现也很容易。</li>
<li>Calico配置简单，且配置都是通过 Kubernetes 中的 CRD 来进行集中式的管理，通过操作 CR 资源，我们可以直接对集群内的容器进行组网和配置的实时变更</li>
<li>丰富的功能及其兼容性，考虑到集群内需要与三方应用兼容，例如配置多租户网络、固定容器 IP 、网络策略等功能又或者与 Istio、MetalLB、Cilium 等组件的兼容，Calico 的的表现都非常不错</li>
<li>高性能， Calico 的数据面采用 HostGW 的方式，由于是一个纯三方的数据通信，所以在实际使用下性能和主机资源占用方面不会太差，至少也能排在第一梯队</li>
</ul>
<p>结合我司机房新区域采购的是 H3C S9 系列的交换机，支持直接在接入层的交换机侧开启路由反射器。所以最终我们选择Calico 并以 BGP RR 的模式作为 Kubernetes 的 CNI 组件便水到渠成。</p>
<h2 id="关于-metallb">关于 MetalLB<a hidden class="anchor" aria-hidden="true" href="#关于-metallb">#</a></h2>
<p>在讲 MetalLB 之前，先回顾下应用部署在 Kubernetes 中，它的下游服务是如何访问的吧。通常有如下几种情况</p>
<ul>
<li>集群内请求:</li>
</ul>
<p>直接通过 Kubernetes 的 Service 访问应用。</p>
<ul>
<li>集群外请求：</li>
</ul>
<ol>
<li>通过 NodePort 在主机上以 nat 方式将流量转发给容器，优点配置简单且能提供简单的负载均衡功能， 缺点也很明显下游应用只能通过主机地址+端口来做寻址</li>
<li>通过 Ingress-nginx 做应用层的 7 层转发，优点是路由规则灵活，且流量只经过一层代理便直达容器，效率较高。缺点是 ingress-nginx 本身的服务还是需要通过 NodePort 或者 HostNetwork 来支持</li>
</ol>
<p>可以看到在没有外部负载均衡器的引入之前，应用部署在 kubernetes 集群内，它对南北向流量的地址寻址仍然不太友好。也许有的同学就说了，我在公有云上使用 Kubernetes 时，将 Service 类型设置成 LoadBalancer，集群就能自动为我的应用创建一条带负载均衡器地址的 IP供外部服务调用，那我们自己部署的 Kubernetes 集群有没有类似的东西来实现呢？</p>
<p>当然有！MetalLB 就是在裸金属服务器下为 Kubernetes 集群诞生的一个负载均衡器项目。</p>
<pre tabindex="0"><code>事实上当然不止 MetalLB，开源界里面还有其他诸如PureLB、OpenELB等负载均衡产品。不过本文旨在采用 BGP 协议来实现负载均衡，所以重点会偏向 MetelLB
</code></pre><p>简单来说，MetalLB包含了两个组件，Controler用于操作 Service 资源的变更以及IPAM。Speaker用于外广播地址以及 BGP 的连接。它支持两种流模式模式即：layer2 和 BGP。</p>
<ul>
<li>Layer2 模式</li>
</ul>
<p>又叫ARP/NDP模式，在此模式下，Kubenretes集群中运行 Speaker 的一台机器通过 leader 选举，获取 Service 的 LoadBalancer IP 的所有权，并使用 ARP 协议将其 IP 和 MAC 广播出去，以使这些 IP 能够在本地网络上可访问。由此可见，使用 Layer2 的模式对现有网络并没有太多的要求，甚至不需要路由器的支持。不过缺点也显而易见，LoadBalancer IP 所在的 Node 节点承载了所有的流量，会产生一定的网络瓶颈。</p>
<pre tabindex="0"><code>此外，我们可以简单的将 Layer2 模式理解为与 Keepalived 原理相似，区别仅为 Layer2 的lead 选举并不是使用 VRRP 组播来通信的
</code></pre><ul>
<li>BGP 模式</li>
</ul>
<p>MabelLB 在 BGP 模式下，集群中的所有运行 Speaker 的主机都将与上层交换机建立一条BGP 连接，并广播其 LoadBalancer 的IP 地址。优点是真正的实现了网络负载均衡，缺点就是配置相对而言要复杂许多，且需上层路由器支持BGP。</p>
<p>本文主要讲述在传统的自建数据中心，利用 Calico 和 MetalLB 来组件内部的 BGP 网络。并以此来为 Kubernetes 提供 <code>Pod - Pod</code> 、<code>Node - Pod</code> 和 <code>Node - Loadbalancer</code>网络互访的能力。</p>
<h1 id="8-metallblayer2-bgp-vrf">8 Metallb(Layer2 BGP) VRF<a hidden class="anchor" aria-hidden="true" href="#8-metallblayer2-bgp-vrf">#</a></h1>
<p><a href="https://blog.csdn.net/wanger5354/article/details/124964489">https://blog.csdn.net/wanger5354/article/details/124964489</a></p>
<p><a href="https://metallb.universe.tf/configuration/">https://metallb.universe.tf/configuration/</a></p>
<h2 id="installation">INSTALLATION<a hidden class="anchor" aria-hidden="true" href="#installation">#</a></h2>
<p>Before starting with installation, make sure you meet all the <a href="https://metallb.universe.tf/#requirements">requirements</a>. In particular, you should pay attention to <a href="https://metallb.universe.tf/installation/network-addons/">network addon compatibility</a>.</p>
<p>If you’re trying to run MetalLB on a cloud platform, you should also look at the <a href="https://metallb.universe.tf/installation/clouds/">cloud compatibility</a> page and make sure your cloud platform can work with MetalLB (most cannot).</p>
<p>There are three supported ways to install MetalLB: using plain Kubernetes manifests, using Kustomize, or using Helm.</p>
<h3 id="preparation">Preparation<a hidden class="anchor" aria-hidden="true" href="#preparation">#</a></h3>
<p>If you’re using kube-proxy in IPVS mode, since Kubernetes v1.14.2 you have to enable strict ARP mode.</p>
<p><em>Note, you don’t need this if you’re using kube-router as service-proxy because it is enabling strict ARP by default.</em></p>
<p>You can achieve this by editing kube-proxy config in current cluster:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl edit configmap -n kube-system kube-proxy
</span></span></code></pre></div><p>and set:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">kubeproxy.config.k8s.io/v1alpha1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">KubeProxyConfiguration</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">mode</span>: <span style="color:#e6db74">&#34;ipvs&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">ipvs</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">strictARP</span>: <span style="color:#66d9ef">true</span>
</span></span></code></pre></div><p>You can also add this configuration snippet to your kubeadm-config, just append it with <code>---</code> after the main configuration.</p>
<p>If you are trying to automate this change, these shell snippets may help you:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># see what changes would be made, returns nonzero returncode if different</span>
</span></span><span style="display:flex;"><span>kubectl get configmap kube-proxy -n kube-system -o yaml | <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>sed -e <span style="color:#e6db74">&#34;s/strictARP: false/strictARP: true/&#34;</span> | <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>kubectl diff -f - -n kube-system
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># actually apply the changes, returns nonzero returncode on errors only</span>
</span></span><span style="display:flex;"><span>kubectl get configmap kube-proxy -n kube-system -o yaml | <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>sed -e <span style="color:#e6db74">&#34;s/strictARP: false/strictARP: true/&#34;</span> | <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>kubectl apply -f - -n kube-system
</span></span></code></pre></div><h3 id="installation-by-manifest">Installation By Manifest<a hidden class="anchor" aria-hidden="true" href="#installation-by-manifest">#</a></h3>
<p>To install MetalLB, apply the manifest:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl apply -f https://raw.githubusercontent.com/metallb/metallb/v0.13.4/config/manifests/metallb-native.yaml
</span></span></code></pre></div><p>If you want to deploy MetalLB using the <a href="https://metallb.universe.tf/configuration/#enabling-bfd-support-for-bgp-sessions">experimental FRR mode</a>, apply the manifests:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl apply -f https://raw.githubusercontent.com/metallb/metallb/v0.13.4/config/manifests/metallb-frr.yaml
</span></span></code></pre></div><p>Please do note that these manifests deploy MetalLB from the main development branch. We highly encourage cloud operators to deploy a stable released version of MetalLB on production environments!</p>
<p>This will deploy MetalLB to your cluster, under the <code>metallb-system</code> namespace. The components in the manifest are:</p>
<ul>
<li>The <code>metallb-system/controller</code> deployment. This is the cluster-wide controller that handles IP address assignments.</li>
<li>The <code>metallb-system/speaker</code> daemonset. This is the component that speaks the protocol(s) of your choice to make the services reachable.</li>
<li>Service accounts for the controller and speaker, along with the RBAC permissions that the components need to function.</li>
</ul>
<p>The installation manifest does not include a configuration file. MetalLB’s components will still start, but will remain idle until you <a href="https://metallb.universe.tf/configuration/">start deploying resources</a>.</p>
<h3 id="installation-with-kustomize">Installation With Kustomize<a hidden class="anchor" aria-hidden="true" href="#installation-with-kustomize">#</a></h3>
<p>You can install MetalLB with <a href="https://github.com/kubernetes-sigs/kustomize">Kustomize</a> by pointing at the remote kustomization file.</p>
<p>In the following example, we are deploying MetalLB with the native bgp implementation :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#75715e"># kustomization.yml</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">metallb-system</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">resources</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">github.com/metallb/metallb/config/native?ref=v0.13.4</span>
</span></span></code></pre></div><p>In order to deploy the <a href="https://metallb.universe.tf/configuration/#enabling-bfd-support-for-bgp-sessions">experimental FRR mode</a>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#75715e"># kustomization.yml</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">metallb-system</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">resources</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">github.com/metallb/metallb/config/frr?ref=v0.13.4</span>
</span></span></code></pre></div><h3 id="installation-with-helm">Installation With Helm<a hidden class="anchor" aria-hidden="true" href="#installation-with-helm">#</a></h3>
<p>You can install MetallLB with <a href="https://helm.sh/">Helm</a> by using the Helm chart repository: <code>https://metallb.github.io/metallb</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>helm repo add metallb https://metallb.github.io/metallb
</span></span><span style="display:flex;"><span>helm install metallb metallb/metallb
</span></span></code></pre></div><p>A values file may be specified on installation. This is recommended for providing configs in Helm values:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>helm install metallb metallb/metallb -f values.yaml
</span></span></code></pre></div><p>The speaker pod requires elevated permission in order to perform its network functionalities.</p>
<p>If you are using MetalLB with a kubernetes version that enforces <a href="https://kubernetes.io/docs/concepts/security/pod-security-admission/">pod security admission</a> (which is beta in k8s 1.23), the namespace MetalLB is deployed to must be labelled with:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">pod-security.kubernetes.io/enforce</span>: <span style="color:#ae81ff">privileged</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">pod-security.kubernetes.io/audit</span>: <span style="color:#ae81ff">privileged</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">pod-security.kubernetes.io/warn</span>: <span style="color:#ae81ff">privileged</span>
</span></span></code></pre></div><p>If you want to deploy MetalLB using the <a href="https://metallb.universe.tf/configuration/#enabling-bfd-support-for-bgp-sessions">experimental FRR mode</a>, the following value must be set:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">speaker</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">frr</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">true</span>
</span></span></code></pre></div><h3 id="using-the-metallb-operator">Using The MetalLB Operator<a hidden class="anchor" aria-hidden="true" href="#using-the-metallb-operator">#</a></h3>
<p>The MetalLB Operator is available on OperatorHub at <a href="https://operatorhub.io/operator/metallb-operator">operatorhub.io/operator/metallb-operator</a>. It eases the deployment and life-cycle of MetalLB in a cluster and allows configuring MetalLB via CRDs.</p>
<p>If you want to deploy MetalLB using the <a href="https://metallb.universe.tf/configuration/#enabling-bfd-support-for-bgp-sessions">experimental FRR mode</a>, you must edit the ClusterServiceVersion resource named <code>metallb-operator</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl edit csv metallb-operator
</span></span></code></pre></div><p>and change the <code>BGP_TYPE</code> environment variable of the <code>manager</code> container to <code>frr</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">METALLB_BGP_TYPE</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">value</span>: <span style="color:#ae81ff">frr</span>
</span></span></code></pre></div><h3 id="frr-daemons-logging-level">FRR Daemons Logging Level<a hidden class="anchor" aria-hidden="true" href="#frr-daemons-logging-level">#</a></h3>
<p>The FRR daemons logging level are configured using the speaker <code>--log-level</code> argument following the below mapping:</p>
<table>
<thead>
<tr>
<th style="text-align:left">Speaker log level</th>
<th style="text-align:left">FRR log level</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">all, debug</td>
<td style="text-align:left">debugging</td>
</tr>
<tr>
<td style="text-align:left">info</td>
<td style="text-align:left">informational</td>
</tr>
<tr>
<td style="text-align:left">warn</td>
<td style="text-align:left">warnings</td>
</tr>
<tr>
<td style="text-align:left">error</td>
<td style="text-align:left">error</td>
</tr>
<tr>
<td style="text-align:left">none</td>
<td style="text-align:left">emergencies</td>
</tr>
</tbody>
</table>
<p>To override this behavior, you can set the <code>FRR_LOGGING_LEVEL</code> speaker’s environment to any <a href="https://docs.frrouting.org/en/latest/basic.html#clicmd-log-stdout-LEVEL">FRR supported value</a>.</p>
<h3 id="upgrade">Upgrade<a hidden class="anchor" aria-hidden="true" href="#upgrade">#</a></h3>
<p>When upgrading MetalLB, always check the <a href="https://metallb.universe.tf/release-notes/">release notes</a> to see the changes and required actions, if any. Pay special attention to the release notes when upgrading to newer major/minor releases.</p>
<p>Unless specified otherwise in the release notes, upgrade MetalLB either using <a href="https://metallb.universe.tf/installation/#installation-by-manifest">plain manifests</a> or using <a href="https://metallb.universe.tf/installation/#installation-with-kustomize">Kustomize</a> as described above.</p>
<p>Please take the known limitations for <a href="https://metallb.universe.tf/concepts/layer2/#limitations">layer2</a> and <a href="https://metallb.universe.tf/concepts/bgp/#limitations">bgp</a> into account when performing an upgrade.</p>
<h3 id="setting-the-loadbalancer-class">Setting The LoadBalancer Class<a hidden class="anchor" aria-hidden="true" href="#setting-the-loadbalancer-class">#</a></h3>
<p>MetalLB supports <a href="https://kubernetes.io/docs/concepts/services-networking/service/#load-balancer-class">LoadBalancerClass</a>, which allows multiple load balancer implementations to co-exist. In order to set the loadbalancer class MetalLB should be listening for, the <code>--lb-class=&lt;CLASS_NAME&gt;</code> parameter must be provided to both the speaker and the controller.</p>
<p>The helm charts support it via the <code>loadBalancerClass</code> parameter.</p>
<h2 id="configuration">CONFIGURATION<a hidden class="anchor" aria-hidden="true" href="#configuration">#</a></h2>
<p>MetalLB remains idle until configured. This is accomplished by creating and deploying various resources into <strong>the same namespace</strong> (metallb-system) MetalLB is deployed into.</p>
<p>There are various examples of the configuration CRs in <a href="https://raw.githubusercontent.com/metallb/metallb/v0.13.4/configsamples"><code>configsamples</code></a>.</p>
<p>Also, the API is <a href="https://metallb.universe.tf/apis/_index.md">fully documented here</a>.</p>
<pre tabindex="0"><code>If you installed MetalLB with Helm, you will need to change the namespace of the CRs to match the namespace in which MetalLB was deployed.
</code></pre><h3 id="defining-the-ips-to-assign-to-the-load-balancer-services">Defining The IPs To Assign To The Load Balancer Services<a hidden class="anchor" aria-hidden="true" href="#defining-the-ips-to-assign-to-the-load-balancer-services">#</a></h3>
<p>In order to assign an IP to the services, MetalLB must be instructed to do so via the <code>IPAddressPool</code> CR.</p>
<p>All the IPs allocated via <code>IPAddressPool</code>s contribute to the pool of IPs that MetalLB uses to assign IPs to services.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">metallb.io/v1beta1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">IPAddressPool</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">first-pool</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">metallb-system</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">addresses</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">192.168.10.0</span><span style="color:#ae81ff">/24</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">192.168.9.1-192.168.9.5</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">fc00:f853:0ccd:e799::/124</span>
</span></span></code></pre></div><p>Multiple instances of <code>IPAddressPool</code>s can co-exist and addresses can be defined by CIDR, by range, and both IPV4 and IPV6 addresses can be assigned.</p>
<h3 id="announce-the-service-ips">Announce The Service IPs<a hidden class="anchor" aria-hidden="true" href="#announce-the-service-ips">#</a></h3>
<p>Once the IPs are assigned to a service, they must be announced.</p>
<p>The specific configuration depends on the protocol(s) you want to use to announce service IPs. Jump to:</p>
<ul>
<li><a href="https://metallb.universe.tf/configuration/#layer-2-configuration">Layer 2 configuration</a></li>
<li><a href="https://metallb.universe.tf/configuration/#bgp-configuration">BGP configuration</a></li>
<li><a href="https://metallb.universe.tf/configuration/_advanced_bgp_configuration">Advanced BGP configuration</a></li>
<li><a href="https://metallb.universe.tf/configuration/_advanced_l2_configuration">Advanced L2 configuration</a></li>
<li><a href="https://metallb.universe.tf/configuration/_advanced_ipaddresspool_config/">Advanced IPAddressPool configuration</a></li>
</ul>
<p>Note: it is possible to announce the same service both via L2 and via BGP (see the relative <a href="https://metallb.universe.tf/faq/_index.md">FAQ</a>).</p>
<h3 id="layer-2-configuration">Layer 2 Configuration<a hidden class="anchor" aria-hidden="true" href="#layer-2-configuration">#</a></h3>
<p>Layer 2 mode is the simplest to configure: in many cases, you don’t need any protocol-specific configuration, only IP addresses.</p>
<p>Layer 2 mode does not require the IPs to be bound to the network interfaces of your worker nodes. It works by responding to ARP requests on your local network directly, to give the machine’s MAC address to clients.</p>
<p>In order to advertise the IP coming from an <code>IPAddressPool</code>, an <code>L2Advertisement</code> instance must be associated to the <code>IPAddressPool</code>.</p>
<p>For example, the following configuration gives MetalLB control over IPs from <code>192.168.1.240</code> to <code>192.168.1.250</code>, and configures Layer 2 mode:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">metallb.io/v1beta1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">IPAddressPool</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">first-pool</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">metallb-system</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">addresses</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">192.168.1.240-192.168.1.250</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">metallb.io/v1beta1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">L2Advertisement</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">example</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">metallb-system</span>
</span></span></code></pre></div><p>Setting no <code>IPAddressPool</code> selector in an <code>L2Advertisement</code> instance is interpreted as that instance being associated to all the <code>IPAddressPool</code>s available.</p>
<p>So in case there are specialized <code>IPAddressPool</code>s, and only some of them must be advertised via L2, the list of <code>IPAddressPool</code>s we want to advertise the IPs from must be declared (alternative, a label selector can be used).</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">metallb.io/v1beta1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">L2Advertisement</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">example</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">metallb-system</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ipAddressPools</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">first-pool</span>
</span></span></code></pre></div><h3 id="bgp-configuration">BGP Configuration<a hidden class="anchor" aria-hidden="true" href="#bgp-configuration">#</a></h3>
<p>MetalLB needs to be instructed on how to establish a session with one or more external BGP routers.</p>
<p>In order to do so, an instance of <code>BGPPeer</code> must be created for each router we want metallb to connect to.</p>
<p>For a basic configuration featuring one BGP router and one IP address range, you need 4 pieces of information:</p>
<ul>
<li>The router IP address that MetalLB should connect to,</li>
<li>The router’s AS number,</li>
<li>The AS number MetalLB should use,</li>
<li>An IP address range expressed as a CIDR prefix.</li>
</ul>
<p>As an example if you want to give MetalLB AS number 64500, and connect it to a router at 10.0.0.1 with AS number 64501, your configuration will look like:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">metallb.io/v1beta2</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">BGPPeer</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">sample</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">metallb-system</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">myASN</span>: <span style="color:#ae81ff">64500</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">peerASN</span>: <span style="color:#ae81ff">64501</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">peerAddress</span>: <span style="color:#ae81ff">10.0.0.1</span>
</span></span></code></pre></div><p>Given an <code>IPAddressPool</code> like:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">metallb.io/v1beta1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">IPAddressPool</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">first-pool</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">metallb-system</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">addresses</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">192.168.1.240-192.168.1.250</span>
</span></span></code></pre></div><p>MetalLB must be configured to advertise the IPs coming from it via BGP.</p>
<p>This is done via the <code>BGPAdvertisement</code> CR.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">metallb.io/v1beta1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">BGPAdvertisement</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">example</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">metallb-system</span>
</span></span></code></pre></div><p>Setting no <code>IPAddressPool</code> selector in a <code>BGPAdvertisement</code> instance is interpreted as that instance being associated to all the <code>IPAddressPool</code>s available.</p>
<p>So in case there are specialized <code>AddressPool</code>s, and only some of them must be advertised via BGP, the list of <code>ipAddressPool</code>s we want to advertise the IPs from must be declared (alternative, a label selector can be used).</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">metallb.io/v1beta1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">BGPAdvertisement</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">example</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">metallb-system</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ipAddressPools</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">first-pool</span>
</span></span></code></pre></div><h4 id="enabling-bfd-support-for-bgp-sessions">Enabling BFD support for BGP sessions<a hidden class="anchor" aria-hidden="true" href="#enabling-bfd-support-for-bgp-sessions">#</a></h4>
<p>With the experimental FRR mode, BGP sessions can be backed up by BFD sessions in order to provide a quicker path failure detection than BGP alone provides.</p>
<p>In order to enable BFD, a BFD profile must be added and referenced by a given peer:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">metallb.io/v1beta1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">BFDProfile</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">testbfdprofile</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">metallb-system</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">receiveInterval</span>: <span style="color:#ae81ff">380</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">transmitInterval</span>: <span style="color:#ae81ff">270</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">metallb.io/v1beta2</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">BGPPeer</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">peersample</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">metallb-system</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">myASN</span>: <span style="color:#ae81ff">64512</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">peerASN</span>: <span style="color:#ae81ff">64512</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">peerAddress</span>: <span style="color:#ae81ff">172.30.0.3</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">bfdProfile</span>: <span style="color:#ae81ff">testbfdprofile</span>
</span></span></code></pre></div><h3 id="configuration-validation">Configuration Validation<a hidden class="anchor" aria-hidden="true" href="#configuration-validation">#</a></h3>
<p>MetalLB ships validation webhooks that check the validity of the CRs applied.</p>
<p>However, due to the fact that the global MetalLB configuration is composed by different pieces, not all of the invalid configurations are blocked by those webhooks. Because of that, if a non valid MetalLB configuration is applied, MetalLB discards it and keeps using the last valid configuration.</p>
<p>In future releases MetalLB will expose misconfigurations as part of Kubernetes resources, but currently the only way to understand why the configuration was not loaded is by checking the controller’s logs.</p>
<h1 id="6-cri-o容器查看">6. cri-o容器查看<a hidden class="anchor" aria-hidden="true" href="#6-cri-o容器查看">#</a></h1>
<ul>
<li>告警消除：</li>
</ul>
<pre tabindex="0"><code>crictl config runtime-endpoint unix:///run/containerd/containerd.sock
crictl config image-endpoint unix:///run/containerd/containerd.sock
</code></pre><ul>
<li>容器查看：</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#a6e22e">[root@master ~]# crictl ps -a</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">CONTAINER           IMAGE               CREATED             STATE               NAME                      ATTEMPT             POD ID</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">05bf0b07de6d2       85c4a186478c5       27 minutes ago      Running             cni-server                1                   4e02c14191216</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">dc44549c2fb1c       85c4a186478c5       27 minutes ago      Running             kube-ovn-monitor          1                   af7f061cc99da</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">baecb15218ce4       7ecf17eb27602       27 minutes ago      Running             kube-rbac-proxy           1                   5b4a069503baa</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ba5e1dfb820d2       1dbe0e9319764       27 minutes ago      Running             node-exporter             1                   5b4a069503baa</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">076ee4abc2236       2ae1ba6417cbc       27 minutes ago      Running             kube-proxy                1                   fcdec13137e9c</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">e9694c055e958       85c4a186478c5       27 minutes ago      Running             ovn-central               1                   6e97a806daa56</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">87f8bf7b461ee       85c4a186478c5       27 minutes ago      Running             openvswitch               1                   090c5b465fdfd</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">3947ea767ae98       85c4a186478c5       27 minutes ago      Exited              install-cni               1                   4e02c14191216</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">dedd5885b4364       d521dd763e2e3       27 minutes ago      Running             kube-apiserver            3                   52fe731b64d15</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">93ecf96257381       aebe758cef4cd       27 minutes ago      Running             etcd                      3                   f8fb9d0fddf59</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">189c8028b1b5f       586c112956dfc       27 minutes ago      Running             kube-controller-manager   3                   0cead8b71f125</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">da982f9d8504e       3a5aa3a515f5d       27 minutes ago      Running             kube-scheduler            4                   697f03b8343df</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">7795018ed9846       7ecf17eb27602       7 hours ago         Exited              kube-rbac-proxy           0                   eb7bbd6b1a3ae</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">52c6309afc865       1dbe0e9319764       7 hours ago         Exited              node-exporter             0                   eb7bbd6b1a3ae</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">a159a4a2cd630       85c4a186478c5       8 hours ago         Exited              cni-server                0                   ec18d4951aa24</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">311fb8d9d0915       85c4a186478c5       8 hours ago         Exited              kube-ovn-monitor          0                   29e23e19475f7</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">4994420dd49cd       85c4a186478c5       8 hours ago         Exited              openvswitch               0                   6aaa39b688767</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">316775dc2b0d5       85c4a186478c5       8 hours ago         Exited              ovn-central               0                   c557b57114e97</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">4d0c8a21aa3e2       2ae1ba6417cbc       8 hours ago         Exited              kube-proxy                0                   c2c23e8e506c4</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">32a274d36691e       3a5aa3a515f5d       8 hours ago         Exited              kube-scheduler            3                   35d60f66a07aa</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">018b4015ebb34       aebe758cef4cd       8 hours ago         Exited              etcd                      2                   21485439d6399</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">c4d4d3a7e0f99       d521dd763e2e3       8 hours ago         Exited              kube-apiserver            2                   6eb81ac0c0503</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">a9eeb491d46f9       586c112956dfc       8 hours ago         Exited              kube-controller-manager   2                   5802cc6895738</span>
</span></span></code></pre></div><h1 id="7-k8s删除名称空间报错">7. <strong>k8s删除名称空间报错</strong><a hidden class="anchor" aria-hidden="true" href="#7-k8s删除名称空间报错">#</a></h1>
<p><strong>一直处于Terminating状态中</strong></p>
<ul>
<li>问题</li>
</ul>
<p>删除ns，一直处于Terminating状态中
强制删除也是出现报错</p>
<p>原因：因为ingress controller的镜像 pull 失败，一直在 retry ，所以我就把 ingress-controller delete 掉，但是一直卡住在删除 namespace 阶段 Ctrl + c</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#a6e22e">[root@master1 ingress]# kubectl create -f mandatory.yaml</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">clusterrole.rbac.authorization.k8s.io/nginx-ingress-clusterrole created</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">clusterrolebinding.rbac.authorization.k8s.io/nginx-ingress-clusterrole-nisa-binding created</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Error from server (AlreadyExists): error when creating &#34;mandatory.yaml&#34;: object is being deleted: namespaces &#34;ingress-ngin                                                               x&#34; already exists</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Error from server (Forbidden): error when creating &#34;mandatory.yaml&#34;: configmaps &#34;nginx-configuration&#34; is forbidden: unable                                                                to create new content in namespace ingress-nginx because it is being terminated</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Error from server (Forbidden): error when creating &#34;mandatory.yaml&#34;: configmaps &#34;tcp-services&#34; is forbidden: unable to cre                                                               ate new content in namespace ingress-nginx because it is being terminated</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Error from server (Forbidden): error when creating &#34;mandatory.yaml&#34;: configmaps &#34;udp-services&#34; is forbidden: unable to cre                                                               ate new content in namespace ingress-nginx because it is being terminated</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Error from server (Forbidden): error when creating &#34;mandatory.yaml&#34;: serviceaccounts &#34;nginx-ingress-serviceaccount&#34; is for                                                               bidden: unable to create new content in namespace ingress-nginx because it is being terminated</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Error from server (Forbidden): error when creating &#34;mandatory.yaml&#34;: roles.rbac.authorization.k8s.io &#34;nginx-ingress-role&#34;                                                                is forbidden: unable to create new content in namespace ingress-nginx because it is being terminated</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Error from server (Forbidden): error when creating &#34;mandatory.yaml&#34;: rolebindings.rbac.authorization.k8s.io &#34;nginx-ingress                                                               -role-nisa-binding&#34; is forbidden: unable to create new content in namespace ingress-nginx because it is being terminated</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Error from server (Forbidden): error when creating &#34;mandatory.yaml&#34;: daemonsets.apps &#34;nginx-ingress-controller&#34; is forbidd                                                               en: unable to create new content in namespace ingress-nginx because it is being terminated</span>
</span></span></code></pre></div><ul>
<li>解决方案：</li>
</ul>
<pre tabindex="0"><code>kubectl get ns ingress-nginx -o json &gt; tmp.json
</code></pre><p>导出运行的名称空间至json文件，删掉其中的spec字段<code>内容</code>，因为k8s集群是携带认证的</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@master1 ingress<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl proxy --port=8081</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 新开一个shell终端执行curl命令</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@master1 ~<span style="color:#f92672">]</span><span style="color:#75715e"># curl -k -H &#34;Content-Type: application/json&#34; -X PUT --data-binary @tmp.json http://127.0.0.1:8081/api/v1/namespaces/ingress-nginx/finalize</span>
</span></span></code></pre></div><ul>
<li>ok</li>
</ul>
<pre tabindex="0"><code>[root@master1 ingress]# kubectl get ns
NAME                   STATUS        AGE
default                Active        7d20h
kube-node-lease        Active        7d20h
kube-public            Active        7d20h
kube-system            Active        7d20h
kubernetes-dashboard   Terminating   7d14h
</code></pre><h1 id="8-k8s常用命令">8. k8s常用命令<a hidden class="anchor" aria-hidden="true" href="#8-k8s常用命令">#</a></h1>
<h2 id="查看所有-pod-列表---n-后跟-namespace-查看指定的命名空间"><strong>查看所有</strong> <strong>pod</strong> <strong>列表,  -n</strong> <strong>后跟</strong> <strong>namespace,</strong> <strong>查看指定的命名空间</strong><a hidden class="anchor" aria-hidden="true" href="#查看所有-pod-列表---n-后跟-namespace-查看指定的命名空间">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#a6e22e">kubectl</span> <span style="color:#a6e22e">get</span> <span style="color:#a6e22e">pod</span> 
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">kubectl</span> <span style="color:#a6e22e">get</span> <span style="color:#a6e22e">pod</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">n</span> <span style="color:#a6e22e">kube</span><span style="color:#f92672">-</span><span style="color:#a6e22e">system</span>    <span style="color:#960050;background-color:#1e0010">#</span><span style="color:#a6e22e">查看指定命名空间的pod</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">kubectl</span> <span style="color:#a6e22e">get</span> <span style="color:#a6e22e">pod</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">o</span> <span style="color:#a6e22e">wide</span>    <span style="color:#960050;background-color:#1e0010">#</span><span style="color:#a6e22e">查看更详细的信息</span><span style="color:#960050;background-color:#1e0010">，</span><span style="color:#a6e22e">比如pod所在节点</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">kubectl</span> <span style="color:#a6e22e">get</span> <span style="color:#a6e22e">pod</span> <span style="color:#f92672">--</span><span style="color:#a6e22e">show</span><span style="color:#f92672">-</span><span style="color:#a6e22e">labels</span>    <span style="color:#960050;background-color:#1e0010">#</span><span style="color:#a6e22e">获取pod并查看pod的标签</span>
</span></span></code></pre></div><h2 id="查看-rc-和-service-列表--o-wide-查看详细信息"><strong>查看</strong> <strong>RC</strong> <strong>和</strong> <strong>service</strong> <strong>列表，</strong> <strong>-o wide</strong> <strong>查看详细信息</strong><a hidden class="anchor" aria-hidden="true" href="#查看-rc-和-service-列表--o-wide-查看详细信息">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#a6e22e">kubectl</span> <span style="color:#a6e22e">get</span> <span style="color:#a6e22e">rc</span>,<span style="color:#a6e22e">svc</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">kubectl</span> <span style="color:#a6e22e">get</span> <span style="color:#a6e22e">pod</span>,<span style="color:#a6e22e">svc</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">o</span> <span style="color:#a6e22e">wide</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">kubectl</span> <span style="color:#a6e22e">get</span> <span style="color:#a6e22e">pod</span> <span style="color:#f92672">&lt;</span><span style="color:#a6e22e">pod</span> <span style="color:#a6e22e">name</span><span style="color:#f92672">&gt;</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">o</span> <span style="color:#a6e22e">yaml</span>
</span></span></code></pre></div><h2 id="显示-node-的详细信息"><strong>显示</strong> <strong>Node</strong> <strong>的详细信息</strong><a hidden class="anchor" aria-hidden="true" href="#显示-node-的详细信息">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#a6e22e">kubectl</span> <span style="color:#a6e22e">describe</span> <span style="color:#a6e22e">node</span> <span style="color:#ae81ff">192.168</span>.<span style="color:#ae81ff">0.212</span> <span style="color:#960050;background-color:#1e0010">#</span><span style="color:#a6e22e">可以跟Node</span> <span style="color:#a6e22e">IP或者主机名</span>
</span></span></code></pre></div><h2 id="显示-pod-的详细信息-特别是查看-pod-无法创建的时候的日志"><strong>显示</strong> <strong>Pod</strong> <strong>的详细信息,</strong> <strong>特别是查看</strong> <strong>pod</strong> <strong>无法创建的时候的日志</strong><a hidden class="anchor" aria-hidden="true" href="#显示-pod-的详细信息-特别是查看-pod-无法创建的时候的日志">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#a6e22e">kubectl</span> <span style="color:#a6e22e">describe</span> <span style="color:#a6e22e">pod</span> <span style="color:#f92672">&lt;</span><span style="color:#a6e22e">pod</span><span style="color:#f92672">-</span><span style="color:#a6e22e">name</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">eg</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">kubectl</span> <span style="color:#a6e22e">describe</span> <span style="color:#a6e22e">pod</span> <span style="color:#a6e22e">redis</span><span style="color:#f92672">-</span><span style="color:#a6e22e">master</span><span style="color:#f92672">-</span><span style="color:#a6e22e">tqds9</span>
</span></span></code></pre></div><h2 id="根据-yaml-创建资源-apply-可以重复执行create-不行"><strong>根据</strong> <strong>yaml</strong> <strong>创建资源, apply</strong> <strong>可以重复执行，create</strong> <strong>不行</strong><a hidden class="anchor" aria-hidden="true" href="#根据-yaml-创建资源-apply-可以重复执行create-不行">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#a6e22e">kubectl</span> <span style="color:#a6e22e">create</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">f</span> <span style="color:#a6e22e">pod</span>.<span style="color:#a6e22e">yaml</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">kubectl</span> <span style="color:#a6e22e">apply</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">f</span> <span style="color:#a6e22e">pod</span>.<span style="color:#a6e22e">yaml</span>
</span></span></code></pre></div><h2 id="基于-podyaml-定义的名称删除指定资源"><strong>基于 pod.yaml</strong> <strong>定义的名称删除指定资源</strong><a hidden class="anchor" aria-hidden="true" href="#基于-podyaml-定义的名称删除指定资源">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#a6e22e">kubectl</span> <span style="color:#66d9ef">delete</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">f</span> <span style="color:#a6e22e">pod</span>.<span style="color:#a6e22e">yaml</span> 
</span></span></code></pre></div><h2 id="删除所有包含某个-label-的pod-和-service"><strong>删除所有包含某个</strong> <strong>label</strong> <strong>的pod</strong> <strong>和</strong> <strong>service</strong><a hidden class="anchor" aria-hidden="true" href="#删除所有包含某个-label-的pod-和-service">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#a6e22e">kubectl</span> <span style="color:#66d9ef">delete</span> <span style="color:#a6e22e">pod</span>,<span style="color:#a6e22e">svc</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">l</span> <span style="color:#a6e22e">name</span><span style="color:#f92672">=&lt;</span><span style="color:#a6e22e">label</span><span style="color:#f92672">-</span><span style="color:#a6e22e">name</span><span style="color:#f92672">&gt;</span>
</span></span></code></pre></div><h2 id="删除默认命名空间下的所有-pod"><strong>删除默认命名空间下的所有</strong> <strong>Pod</strong><a hidden class="anchor" aria-hidden="true" href="#删除默认命名空间下的所有-pod">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#a6e22e">kubectl</span> <span style="color:#66d9ef">delete</span> <span style="color:#a6e22e">pod</span> <span style="color:#f92672">--</span><span style="color:#a6e22e">all</span>
</span></span></code></pre></div><h2 id="执行-pod-命令"><strong>执行</strong> <strong>pod</strong> <strong>命令</strong><a hidden class="anchor" aria-hidden="true" href="#执行-pod-命令">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#a6e22e">kubectl</span> <span style="color:#a6e22e">exec</span> <span style="color:#f92672">&lt;</span><span style="color:#a6e22e">pod</span><span style="color:#f92672">-</span><span style="color:#a6e22e">name</span><span style="color:#f92672">&gt;</span> <span style="color:#f92672">--</span> <span style="color:#a6e22e">date</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">kubectl</span> <span style="color:#a6e22e">exec</span> <span style="color:#f92672">&lt;</span><span style="color:#a6e22e">pod</span><span style="color:#f92672">-</span><span style="color:#a6e22e">name</span><span style="color:#f92672">&gt;</span> <span style="color:#f92672">--</span> <span style="color:#a6e22e">bash</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">kubectl</span> <span style="color:#a6e22e">exec</span> <span style="color:#f92672">&lt;</span><span style="color:#a6e22e">pod</span><span style="color:#f92672">-</span><span style="color:#a6e22e">name</span><span style="color:#f92672">&gt;</span> <span style="color:#f92672">--</span> <span style="color:#a6e22e">ping</span> <span style="color:#ae81ff">10.24</span>.<span style="color:#ae81ff">51.9</span>
</span></span></code></pre></div><h2 id="通过bash获得-pod-中某个容器httpscloudtencentcomproducttkefrom10680的tty相当于登录容器"><strong>通过bash获得</strong> <strong>pod</strong> <strong>中某个</strong><a href="https://cloud.tencent.com/product/tke?from=10680"><strong>容器</strong></a><strong>的TTY，相当于登录容器</strong><a hidden class="anchor" aria-hidden="true" href="#通过bash获得-pod-中某个容器httpscloudtencentcomproducttkefrom10680的tty相当于登录容器">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#a6e22e">kubectl</span> <span style="color:#a6e22e">exec</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">it</span> <span style="color:#f92672">&lt;</span><span style="color:#a6e22e">pod</span><span style="color:#f92672">-</span><span style="color:#a6e22e">name</span><span style="color:#f92672">&gt;</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">c</span> <span style="color:#f92672">&lt;</span><span style="color:#a6e22e">container</span><span style="color:#f92672">-</span><span style="color:#a6e22e">name</span><span style="color:#f92672">&gt;</span> <span style="color:#f92672">--</span> <span style="color:#a6e22e">bash</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">eg</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">kubectl</span> <span style="color:#a6e22e">exec</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">it</span> <span style="color:#a6e22e">redis</span><span style="color:#f92672">-</span><span style="color:#a6e22e">master</span><span style="color:#f92672">-</span><span style="color:#a6e22e">cln81</span> <span style="color:#f92672">--</span> <span style="color:#a6e22e">bash</span>
</span></span></code></pre></div><h2 id="查看容器的日志"><strong>查看容器的日志</strong><a hidden class="anchor" aria-hidden="true" href="#查看容器的日志">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#a6e22e">kubectl</span> <span style="color:#a6e22e">logs</span> <span style="color:#f92672">&lt;</span><span style="color:#a6e22e">pod</span><span style="color:#f92672">-</span><span style="color:#a6e22e">name</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">kubectl</span> <span style="color:#a6e22e">logs</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">f</span> <span style="color:#f92672">&lt;</span><span style="color:#a6e22e">pod</span><span style="color:#f92672">-</span><span style="color:#a6e22e">name</span><span style="color:#f92672">&gt;</span> <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">实时查看日志</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">kubectl</span> <span style="color:#a6e22e">log</span>  <span style="color:#f92672">&lt;</span><span style="color:#a6e22e">pod</span><span style="color:#f92672">-</span><span style="color:#a6e22e">name</span><span style="color:#f92672">&gt;</span>  <span style="color:#f92672">-</span><span style="color:#a6e22e">c</span> <span style="color:#f92672">&lt;</span><span style="color:#a6e22e">container_name</span><span style="color:#f92672">&gt;</span> <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">若</span> <span style="color:#a6e22e">pod</span> <span style="color:#a6e22e">只有一个容器</span><span style="color:#960050;background-color:#1e0010">，</span><span style="color:#a6e22e">可以不加</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">c</span> 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">kubectl</span> <span style="color:#a6e22e">logs</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">l</span> <span style="color:#a6e22e">app</span><span style="color:#f92672">=</span><span style="color:#a6e22e">frontend</span> <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">返回所有标记为</span> <span style="color:#a6e22e">app</span><span style="color:#f92672">=</span><span style="color:#a6e22e">frontend</span> <span style="color:#a6e22e">的</span> <span style="color:#a6e22e">pod</span> <span style="color:#a6e22e">的合并日志</span><span style="color:#960050;background-color:#1e0010">。</span>
</span></span></code></pre></div><h2 id="查看节点-labels"><strong>查看节点</strong> <strong>labels</strong><a hidden class="anchor" aria-hidden="true" href="#查看节点-labels">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#a6e22e">kubectl</span> <span style="color:#a6e22e">get</span> <span style="color:#a6e22e">node</span> <span style="color:#f92672">--</span><span style="color:#a6e22e">show</span><span style="color:#f92672">-</span><span style="color:#a6e22e">labels</span>
</span></span></code></pre></div><h2 id="重启-pod"><strong>重启</strong> <strong>pod</strong><a hidden class="anchor" aria-hidden="true" href="#重启-pod">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#a6e22e">kubectl</span> <span style="color:#a6e22e">get</span> <span style="color:#a6e22e">pod</span> <span style="color:#f92672">&lt;</span><span style="color:#a6e22e">POD名称</span><span style="color:#f92672">&gt;</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">n</span> <span style="color:#f92672">&lt;</span><span style="color:#a6e22e">NAMESPACE名称</span><span style="color:#f92672">&gt;</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">o</span> <span style="color:#a6e22e">yaml</span> <span style="color:#f92672">|</span> <span style="color:#a6e22e">kubectl</span> <span style="color:#a6e22e">replace</span> <span style="color:#f92672">--</span><span style="color:#a6e22e">force</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">f</span> <span style="color:#f92672">-</span>
</span></span></code></pre></div><h2 id="创建命令"><strong>创建命令</strong><a hidden class="anchor" aria-hidden="true" href="#创建命令">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#a6e22e">kubectl</span> <span style="color:#a6e22e">apply</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">f</span> .<span style="color:#f92672">/</span><span style="color:#a6e22e">my</span><span style="color:#f92672">-</span><span style="color:#a6e22e">manifest</span>.<span style="color:#a6e22e">yaml</span>           <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">创建资源</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">kubectl</span> <span style="color:#a6e22e">apply</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">f</span> .<span style="color:#f92672">/</span><span style="color:#a6e22e">my1</span>.<span style="color:#a6e22e">yaml</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">f</span> .<span style="color:#f92672">/</span><span style="color:#a6e22e">my2</span>.<span style="color:#a6e22e">yaml</span>     <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">使用多个文件创建</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">kubectl</span> <span style="color:#a6e22e">apply</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">f</span> .<span style="color:#f92672">/</span><span style="color:#a6e22e">dir</span>                        <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">基于目录下的所有清单文件创建资源</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">kubectl</span> <span style="color:#a6e22e">apply</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">f</span> <span style="color:#a6e22e">https</span><span style="color:#f92672">:</span><span style="color:#75715e">//git.io/vPieo         # 从 URL 中创建资源
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">kubectl</span> <span style="color:#a6e22e">create</span> <span style="color:#a6e22e">deployment</span> <span style="color:#a6e22e">nginx</span> <span style="color:#f92672">--</span><span style="color:#a6e22e">image</span><span style="color:#f92672">=</span><span style="color:#a6e22e">nginx</span> <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">启动单实例</span> <span style="color:#a6e22e">nginx</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">kubectl</span> <span style="color:#a6e22e">explain</span> <span style="color:#a6e22e">pods</span>,<span style="color:#a6e22e">svc</span>                      <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">获取</span> <span style="color:#a6e22e">pod</span> <span style="color:#a6e22e">清单的文档说明</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">从标准输入创建多个</span> <span style="color:#a6e22e">YAML</span> <span style="color:#a6e22e">对象</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">cat</span> <span style="color:#f92672">&lt;&lt;</span><span style="color:#a6e22e">EOF</span> <span style="color:#f92672">|</span> <span style="color:#a6e22e">kubectl</span> <span style="color:#a6e22e">apply</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">f</span> <span style="color:#f92672">-</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">apiVersion</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">kind</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">Pod</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">metadata</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">name</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">busybox</span><span style="color:#f92672">-</span><span style="color:#a6e22e">sleep</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">spec</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">containers</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">-</span> <span style="color:#a6e22e">name</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">busybox</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">image</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">busybox</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">args</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">-</span> <span style="color:#a6e22e">sleep</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">-</span> <span style="color:#e6db74">&#34;1000000&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">---</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">apiVersion</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">kind</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">Pod</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">metadata</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">name</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">busybox</span><span style="color:#f92672">-</span><span style="color:#a6e22e">sleep</span><span style="color:#f92672">-</span><span style="color:#a6e22e">less</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">spec</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">containers</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">-</span> <span style="color:#a6e22e">name</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">busybox</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">image</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">busybox</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">args</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">-</span> <span style="color:#a6e22e">sleep</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">-</span> <span style="color:#e6db74">&#34;1000&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">创建有多个</span> <span style="color:#a6e22e">key</span> <span style="color:#a6e22e">的</span> <span style="color:#a6e22e">Secret</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">cat</span> <span style="color:#f92672">&lt;&lt;</span><span style="color:#a6e22e">EOF</span> <span style="color:#f92672">|</span> <span style="color:#a6e22e">kubectl</span> <span style="color:#a6e22e">apply</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">f</span> <span style="color:#f92672">-</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">apiVersion</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">kind</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">Secret</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">metadata</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">name</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">mysecret</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">type</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">Opaque</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">data</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">password</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">$</span>(<span style="color:#a6e22e">echo</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">n</span> <span style="color:#e6db74">&#34;s33msi4&#34;</span> <span style="color:#f92672">|</span> <span style="color:#a6e22e">base64</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">w0</span>)
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">username</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">$</span>(<span style="color:#a6e22e">echo</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">n</span> <span style="color:#e6db74">&#34;jane&#34;</span> <span style="color:#f92672">|</span> <span style="color:#a6e22e">base64</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">w0</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">EOF</span>
</span></span></code></pre></div><h2 id="查看和查找资源"><strong>查看和查找资源</strong><a hidden class="anchor" aria-hidden="true" href="#查看和查找资源">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">get</span> <span style="color:#a6e22e">命令的基本输出</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">kubectl</span> <span style="color:#a6e22e">get</span> <span style="color:#a6e22e">services</span>                          <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">列出当前命名空间下的所有</span> <span style="color:#a6e22e">services</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">kubectl</span> <span style="color:#a6e22e">get</span> <span style="color:#a6e22e">pods</span> <span style="color:#f92672">--</span><span style="color:#a6e22e">all</span><span style="color:#f92672">-</span><span style="color:#a6e22e">namespaces</span>             <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">列出所有命名空间下的全部的</span> <span style="color:#a6e22e">Pods</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">kubectl</span> <span style="color:#a6e22e">get</span> <span style="color:#a6e22e">pods</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">o</span> <span style="color:#a6e22e">wide</span>                      <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">列出当前命名空间下的全部</span> <span style="color:#a6e22e">Pods</span><span style="color:#960050;background-color:#1e0010">，</span><span style="color:#a6e22e">并显示更详细的信息</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">kubectl</span> <span style="color:#a6e22e">get</span> <span style="color:#a6e22e">deployment</span> <span style="color:#a6e22e">my</span><span style="color:#f92672">-</span><span style="color:#a6e22e">dep</span>                 <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">列出某个特定的</span> <span style="color:#a6e22e">Deployment</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">kubectl</span> <span style="color:#a6e22e">get</span> <span style="color:#a6e22e">pods</span>                              <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">列出当前命名空间下的全部</span> <span style="color:#a6e22e">Pods</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">kubectl</span> <span style="color:#a6e22e">get</span> <span style="color:#a6e22e">pod</span> <span style="color:#a6e22e">my</span><span style="color:#f92672">-</span><span style="color:#a6e22e">pod</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">o</span> <span style="color:#a6e22e">yaml</span>                <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">获取一个</span> <span style="color:#a6e22e">pod</span> <span style="color:#a6e22e">的</span> <span style="color:#a6e22e">YAML</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">describe</span> <span style="color:#a6e22e">命令的详细输出</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">kubectl</span> <span style="color:#a6e22e">describe</span> <span style="color:#a6e22e">nodes</span> <span style="color:#a6e22e">my</span><span style="color:#f92672">-</span><span style="color:#a6e22e">node</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">kubectl</span> <span style="color:#a6e22e">describe</span> <span style="color:#a6e22e">pods</span> <span style="color:#a6e22e">my</span><span style="color:#f92672">-</span><span style="color:#a6e22e">pod</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">列出当前名字空间下所有</span> <span style="color:#a6e22e">Services</span><span style="color:#960050;background-color:#1e0010">，</span><span style="color:#a6e22e">按名称排序</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">kubectl</span> <span style="color:#a6e22e">get</span> <span style="color:#a6e22e">services</span> <span style="color:#f92672">--</span><span style="color:#a6e22e">sort</span><span style="color:#f92672">-</span><span style="color:#a6e22e">by</span><span style="color:#f92672">=</span>.<span style="color:#a6e22e">metadata</span>.<span style="color:#a6e22e">name</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">列出</span> <span style="color:#a6e22e">Pods</span><span style="color:#960050;background-color:#1e0010">，</span><span style="color:#a6e22e">按重启次数排序</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">kubectl</span> <span style="color:#a6e22e">get</span> <span style="color:#a6e22e">pods</span> <span style="color:#f92672">--</span><span style="color:#a6e22e">sort</span><span style="color:#f92672">-</span><span style="color:#a6e22e">by</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#39;.status.containerStatuses[0].restartCount&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">列举所有</span> <span style="color:#a6e22e">PV</span> <span style="color:#a6e22e">持久卷</span><span style="color:#960050;background-color:#1e0010">，</span><span style="color:#a6e22e">按容量排序</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">kubectl</span> <span style="color:#a6e22e">get</span> <span style="color:#a6e22e">pv</span> <span style="color:#f92672">--</span><span style="color:#a6e22e">sort</span><span style="color:#f92672">-</span><span style="color:#a6e22e">by</span><span style="color:#f92672">=</span>.<span style="color:#a6e22e">spec</span>.<span style="color:#a6e22e">capacity</span>.<span style="color:#a6e22e">storage</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">获取包含</span> <span style="color:#a6e22e">app</span><span style="color:#f92672">=</span><span style="color:#a6e22e">cassandra</span> <span style="color:#a6e22e">标签的所有</span> <span style="color:#a6e22e">Pods</span> <span style="color:#a6e22e">的</span> <span style="color:#a6e22e">version</span> <span style="color:#a6e22e">标签</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">kubectl</span> <span style="color:#a6e22e">get</span> <span style="color:#a6e22e">pods</span> <span style="color:#f92672">--</span><span style="color:#a6e22e">selector</span><span style="color:#f92672">=</span><span style="color:#a6e22e">app</span><span style="color:#f92672">=</span><span style="color:#a6e22e">cassandra</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">o</span> <span style="color:#f92672">\</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">jsonpath</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#39;{.items[*].metadata.labels.version}&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">获取所有工作节点</span><span style="color:#960050;background-color:#1e0010">（</span><span style="color:#a6e22e">使用选择器以排除标签名称为</span> <span style="color:#e6db74">&#39;node-role.kubernetes.io/master&#39;</span> <span style="color:#a6e22e">的结果</span><span style="color:#960050;background-color:#1e0010">）</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">kubectl</span> <span style="color:#a6e22e">get</span> <span style="color:#a6e22e">node</span> <span style="color:#f92672">--</span><span style="color:#a6e22e">selector</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#39;!node-role.kubernetes.io/master&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">获取当前命名空间中正在运行的</span> <span style="color:#a6e22e">Pods</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">kubectl</span> <span style="color:#a6e22e">get</span> <span style="color:#a6e22e">pods</span> <span style="color:#f92672">--</span><span style="color:#a6e22e">field</span><span style="color:#f92672">-</span><span style="color:#a6e22e">selector</span><span style="color:#f92672">=</span><span style="color:#a6e22e">status</span>.<span style="color:#a6e22e">phase</span><span style="color:#f92672">=</span><span style="color:#a6e22e">Running</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">获取全部节点的</span> <span style="color:#a6e22e">ExternalIP</span> <span style="color:#a6e22e">地址</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">kubectl</span> <span style="color:#a6e22e">get</span> <span style="color:#a6e22e">nodes</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">o</span> <span style="color:#a6e22e">jsonpath</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#39;{.items[*].status.addresses[?(@.type==&#34;ExternalIP&#34;)].address}&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">列出属于某个特定</span> <span style="color:#a6e22e">RC</span> <span style="color:#a6e22e">的</span> <span style="color:#a6e22e">Pods</span> <span style="color:#a6e22e">的名称</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">在转换对于</span> <span style="color:#a6e22e">jsonpath</span> <span style="color:#a6e22e">过于复杂的场合</span><span style="color:#960050;background-color:#1e0010">，</span><span style="color:#e6db74">&#34;jq&#34;</span> <span style="color:#a6e22e">命令很有用</span><span style="color:#960050;background-color:#1e0010">；</span><span style="color:#a6e22e">可以在</span> <span style="color:#a6e22e">https</span><span style="color:#f92672">:</span><span style="color:#75715e">//stedolan.github.io/jq/ 找到它。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">sel</span><span style="color:#f92672">=</span><span style="color:#a6e22e">$</span>{<span style="color:#a6e22e">$</span>(<span style="color:#a6e22e">kubectl</span> <span style="color:#a6e22e">get</span> <span style="color:#a6e22e">rc</span> <span style="color:#a6e22e">my</span><span style="color:#f92672">-</span><span style="color:#a6e22e">rc</span> <span style="color:#f92672">--</span><span style="color:#a6e22e">output</span><span style="color:#f92672">=</span><span style="color:#a6e22e">json</span> <span style="color:#f92672">|</span> <span style="color:#a6e22e">jq</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">j</span> <span style="color:#e6db74">&#39;.spec.selector | to_entries | .[] | &#34;\(.key)=\(.value),&#34;&#39;</span>)<span style="color:#f92672">%?</span>}
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">echo</span> <span style="color:#a6e22e">$</span>(<span style="color:#a6e22e">kubectl</span> <span style="color:#a6e22e">get</span> <span style="color:#a6e22e">pods</span> <span style="color:#f92672">--</span><span style="color:#a6e22e">selector</span><span style="color:#f92672">=</span><span style="color:#a6e22e">$sel</span> <span style="color:#f92672">--</span><span style="color:#a6e22e">output</span><span style="color:#f92672">=</span><span style="color:#a6e22e">jsonpath</span><span style="color:#f92672">=</span>{.<span style="color:#a6e22e">items</span>..<span style="color:#a6e22e">metadata</span>.<span style="color:#a6e22e">name</span>})
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">显示所有</span> <span style="color:#a6e22e">Pods</span> <span style="color:#a6e22e">的标签</span><span style="color:#960050;background-color:#1e0010">（</span><span style="color:#a6e22e">或任何其他支持标签的</span> <span style="color:#a6e22e">Kubernetes</span> <span style="color:#a6e22e">对象</span><span style="color:#960050;background-color:#1e0010">）</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">kubectl</span> <span style="color:#a6e22e">get</span> <span style="color:#a6e22e">pods</span> <span style="color:#f92672">--</span><span style="color:#a6e22e">show</span><span style="color:#f92672">-</span><span style="color:#a6e22e">labels</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">检查哪些节点处于就绪状态</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">JSONPATH</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#39;{range .items[*]}{@.metadata.name}:{range @.status.conditions[*]}{@.type}={@.status};{end}{end}&#39;</span> <span style="color:#f92672">\</span>
</span></span><span style="display:flex;"><span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">kubectl</span> <span style="color:#a6e22e">get</span> <span style="color:#a6e22e">nodes</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">o</span> <span style="color:#a6e22e">jsonpath</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;$JSONPATH&#34;</span> <span style="color:#f92672">|</span> <span style="color:#a6e22e">grep</span> <span style="color:#e6db74">&#34;Ready=True&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">列出被一个</span> <span style="color:#a6e22e">Pod</span> <span style="color:#a6e22e">使用的全部</span> <span style="color:#a6e22e">Secret</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">kubectl</span> <span style="color:#a6e22e">get</span> <span style="color:#a6e22e">pods</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">o</span> <span style="color:#a6e22e">json</span> <span style="color:#f92672">|</span> <span style="color:#a6e22e">jq</span> <span style="color:#e6db74">&#39;.items[].spec.containers[].env[]?.valueFrom.secretKeyRef.name&#39;</span> <span style="color:#f92672">|</span> <span style="color:#a6e22e">grep</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">v</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">|</span> <span style="color:#a6e22e">sort</span> <span style="color:#f92672">|</span> <span style="color:#a6e22e">uniq</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">列举所有</span> <span style="color:#a6e22e">Pods</span> <span style="color:#a6e22e">中初始化容器的容器</span> <span style="color:#a6e22e">ID</span><span style="color:#960050;background-color:#1e0010">（</span><span style="color:#a6e22e">containerID</span><span style="color:#960050;background-color:#1e0010">）</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">Helpful</span> <span style="color:#a6e22e">when</span> <span style="color:#a6e22e">cleaning</span> <span style="color:#a6e22e">up</span> <span style="color:#a6e22e">stopped</span> <span style="color:#a6e22e">containers</span>, <span style="color:#66d9ef">while</span> <span style="color:#a6e22e">avoiding</span> <span style="color:#a6e22e">removal</span> <span style="color:#66d9ef">of</span> <span style="color:#a6e22e">initContainers</span>.
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">kubectl</span> <span style="color:#a6e22e">get</span> <span style="color:#a6e22e">pods</span> <span style="color:#f92672">--</span><span style="color:#a6e22e">all</span><span style="color:#f92672">-</span><span style="color:#a6e22e">namespaces</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">o</span> <span style="color:#a6e22e">jsonpath</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#39;{range .items[*].status.initContainerStatuses[*]}{.containerID}{&#34;\n&#34;}{end}&#39;</span> <span style="color:#f92672">|</span> <span style="color:#a6e22e">cut</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">d</span><span style="color:#f92672">/</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">f3</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">列出事件</span><span style="color:#960050;background-color:#1e0010">（</span><span style="color:#a6e22e">Events</span><span style="color:#960050;background-color:#1e0010">），</span><span style="color:#a6e22e">按时间戳排序</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">kubectl</span> <span style="color:#a6e22e">get</span> <span style="color:#a6e22e">events</span> <span style="color:#f92672">--</span><span style="color:#a6e22e">sort</span><span style="color:#f92672">-</span><span style="color:#a6e22e">by</span><span style="color:#f92672">=</span>.<span style="color:#a6e22e">metadata</span>.<span style="color:#a6e22e">creationTimestamp</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">比较当前的集群状态和假定某清单被应用之后的集群状态</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">kubectl</span> <span style="color:#a6e22e">diff</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">f</span> .<span style="color:#f92672">/</span><span style="color:#a6e22e">my</span><span style="color:#f92672">-</span><span style="color:#a6e22e">manifest</span>.<span style="color:#a6e22e">yaml</span>
</span></span></code></pre></div><h2 id="更新资源"><strong>更新资源</strong><a hidden class="anchor" aria-hidden="true" href="#更新资源">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#a6e22e">kubectl</span> <span style="color:#a6e22e">set</span> <span style="color:#a6e22e">image</span> <span style="color:#a6e22e">deployment</span><span style="color:#f92672">/</span><span style="color:#a6e22e">frontend</span> <span style="color:#a6e22e">www</span><span style="color:#f92672">=</span><span style="color:#a6e22e">image</span><span style="color:#f92672">:</span><span style="color:#a6e22e">v2</span>               <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">滚动更新</span> <span style="color:#e6db74">&#34;frontend&#34;</span> <span style="color:#a6e22e">Deployment</span> <span style="color:#a6e22e">的</span> <span style="color:#e6db74">&#34;www&#34;</span> <span style="color:#a6e22e">容器镜像</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">kubectl</span> <span style="color:#a6e22e">rollout</span> <span style="color:#a6e22e">history</span> <span style="color:#a6e22e">deployment</span><span style="color:#f92672">/</span><span style="color:#a6e22e">frontend</span>                      <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">检查</span> <span style="color:#a6e22e">Deployment</span> <span style="color:#a6e22e">的历史记录</span><span style="color:#960050;background-color:#1e0010">，</span><span style="color:#a6e22e">包括版本</span> 
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">kubectl</span> <span style="color:#a6e22e">rollout</span> <span style="color:#a6e22e">undo</span> <span style="color:#a6e22e">deployment</span><span style="color:#f92672">/</span><span style="color:#a6e22e">frontend</span>                         <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">回滚到上次部署版本</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">kubectl</span> <span style="color:#a6e22e">rollout</span> <span style="color:#a6e22e">undo</span> <span style="color:#a6e22e">deployment</span><span style="color:#f92672">/</span><span style="color:#a6e22e">frontend</span> <span style="color:#f92672">--</span><span style="color:#a6e22e">to</span><span style="color:#f92672">-</span><span style="color:#a6e22e">revision</span><span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>         <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">回滚到特定部署版本</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">kubectl</span> <span style="color:#a6e22e">rollout</span> <span style="color:#a6e22e">status</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">w</span> <span style="color:#a6e22e">deployment</span><span style="color:#f92672">/</span><span style="color:#a6e22e">frontend</span>                    <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">监视</span> <span style="color:#e6db74">&#34;frontend&#34;</span> <span style="color:#a6e22e">Deployment</span> <span style="color:#a6e22e">的滚动升级状态直到完成</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">kubectl</span> <span style="color:#a6e22e">rollout</span> <span style="color:#a6e22e">restart</span> <span style="color:#a6e22e">deployment</span><span style="color:#f92672">/</span><span style="color:#a6e22e">frontend</span>                      <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">轮替重启</span> <span style="color:#e6db74">&#34;frontend&#34;</span> <span style="color:#a6e22e">Deployment</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">cat</span> <span style="color:#a6e22e">pod</span>.<span style="color:#a6e22e">json</span> <span style="color:#f92672">|</span> <span style="color:#a6e22e">kubectl</span> <span style="color:#a6e22e">replace</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">f</span> <span style="color:#f92672">-</span>                              <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">通过传入到标准输入的</span> <span style="color:#a6e22e">JSON</span> <span style="color:#a6e22e">来替换</span> <span style="color:#a6e22e">Pod</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">强制替换</span><span style="color:#960050;background-color:#1e0010">，</span><span style="color:#a6e22e">删除后重建资源</span><span style="color:#960050;background-color:#1e0010">。</span><span style="color:#a6e22e">会导致服务不可用</span><span style="color:#960050;background-color:#1e0010">。</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">kubectl</span> <span style="color:#a6e22e">replace</span> <span style="color:#f92672">--</span><span style="color:#a6e22e">force</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">f</span> .<span style="color:#f92672">/</span><span style="color:#a6e22e">pod</span>.<span style="color:#a6e22e">json</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">为多副本的</span> <span style="color:#a6e22e">nginx</span> <span style="color:#a6e22e">创建服务</span><span style="color:#960050;background-color:#1e0010">，</span><span style="color:#a6e22e">使用</span> <span style="color:#ae81ff">80</span> <span style="color:#a6e22e">端口提供服务</span><span style="color:#960050;background-color:#1e0010">，</span><span style="color:#a6e22e">连接到容器的</span> <span style="color:#ae81ff">8000</span> <span style="color:#a6e22e">端口</span><span style="color:#960050;background-color:#1e0010">。</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">kubectl</span> <span style="color:#a6e22e">expose</span> <span style="color:#a6e22e">rc</span> <span style="color:#a6e22e">nginx</span> <span style="color:#f92672">--</span><span style="color:#a6e22e">port</span><span style="color:#f92672">=</span><span style="color:#ae81ff">80</span> <span style="color:#f92672">--</span><span style="color:#a6e22e">target</span><span style="color:#f92672">-</span><span style="color:#a6e22e">port</span><span style="color:#f92672">=</span><span style="color:#ae81ff">8000</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">将某单容器</span> <span style="color:#a6e22e">Pod</span> <span style="color:#a6e22e">的镜像版本</span><span style="color:#960050;background-color:#1e0010">（</span><span style="color:#a6e22e">标签</span><span style="color:#960050;background-color:#1e0010">）</span><span style="color:#a6e22e">更新到</span> <span style="color:#a6e22e">v4</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">kubectl</span> <span style="color:#a6e22e">get</span> <span style="color:#a6e22e">pod</span> <span style="color:#a6e22e">mypod</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">o</span> <span style="color:#a6e22e">yaml</span> <span style="color:#f92672">|</span> <span style="color:#a6e22e">sed</span> <span style="color:#e6db74">&#39;s/\(image: myimage\):.*$/\1:v4/&#39;</span> <span style="color:#f92672">|</span> <span style="color:#a6e22e">kubectl</span> <span style="color:#a6e22e">replace</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">f</span> <span style="color:#f92672">-</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">kubectl</span> <span style="color:#a6e22e">label</span> <span style="color:#a6e22e">pods</span> <span style="color:#a6e22e">my</span><span style="color:#f92672">-</span><span style="color:#a6e22e">pod</span> <span style="color:#66d9ef">new</span><span style="color:#f92672">-</span><span style="color:#a6e22e">label</span><span style="color:#f92672">=</span><span style="color:#a6e22e">awesome</span>                      <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">添加标签</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">kubectl</span> <span style="color:#a6e22e">annotate</span> <span style="color:#a6e22e">pods</span> <span style="color:#a6e22e">my</span><span style="color:#f92672">-</span><span style="color:#a6e22e">pod</span> <span style="color:#a6e22e">icon</span><span style="color:#f92672">-</span><span style="color:#a6e22e">url</span><span style="color:#f92672">=</span><span style="color:#a6e22e">http</span><span style="color:#f92672">:</span><span style="color:#75715e">//goo.gl/XXBTWq       # 添加注解
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">kubectl</span> <span style="color:#a6e22e">autoscale</span> <span style="color:#a6e22e">deployment</span> <span style="color:#a6e22e">foo</span> <span style="color:#f92672">--</span><span style="color:#a6e22e">min</span><span style="color:#f92672">=</span><span style="color:#ae81ff">2</span> <span style="color:#f92672">--</span><span style="color:#a6e22e">max</span><span style="color:#f92672">=</span><span style="color:#ae81ff">10</span>                <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">对</span> <span style="color:#e6db74">&#34;foo&#34;</span> <span style="color:#a6e22e">Deployment</span> <span style="color:#a6e22e">自动伸缩容</span>
</span></span></code></pre></div><h2 id="部分更新资源"><strong>部分更新资源</strong><a hidden class="anchor" aria-hidden="true" href="#部分更新资源">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">部分更新某节点</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">kubectl</span> <span style="color:#a6e22e">patch</span> <span style="color:#a6e22e">node</span> <span style="color:#a6e22e">k8s</span><span style="color:#f92672">-</span><span style="color:#a6e22e">node</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">p</span> <span style="color:#e6db74">&#39;{&#34;spec&#34;:{&#34;unschedulable&#34;:true}}&#39;</span> 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">更新容器的镜像</span><span style="color:#960050;background-color:#1e0010">；</span><span style="color:#a6e22e">spec</span>.<span style="color:#a6e22e">containers</span>[<span style="color:#f92672">*</span>].<span style="color:#a6e22e">name</span> <span style="color:#a6e22e">是必须的</span><span style="color:#960050;background-color:#1e0010">。</span><span style="color:#a6e22e">因为它是一个合并性质的主键</span><span style="color:#960050;background-color:#1e0010">。</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">kubectl</span> <span style="color:#a6e22e">patch</span> <span style="color:#a6e22e">pod</span> <span style="color:#a6e22e">valid</span><span style="color:#f92672">-</span><span style="color:#a6e22e">pod</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">p</span> <span style="color:#e6db74">&#39;{&#34;spec&#34;:{&#34;containers&#34;:[{&#34;name&#34;:&#34;kubernetes-serve-hostname&#34;,&#34;image&#34;:&#34;new image&#34;}]}}&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">使用带位置数组的</span> <span style="color:#a6e22e">JSON</span> <span style="color:#a6e22e">patch</span> <span style="color:#a6e22e">更新容器的镜像</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">kubectl</span> <span style="color:#a6e22e">patch</span> <span style="color:#a6e22e">pod</span> <span style="color:#a6e22e">valid</span><span style="color:#f92672">-</span><span style="color:#a6e22e">pod</span> <span style="color:#f92672">--</span><span style="color:#a6e22e">type</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#39;json&#39;</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">p</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#39;[{&#34;op&#34;: &#34;replace&#34;, &#34;path&#34;: &#34;/spec/containers/0/image&#34;, &#34;value&#34;:&#34;new image&#34;}]&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">使用带位置数组的</span> <span style="color:#a6e22e">JSON</span> <span style="color:#a6e22e">patch</span> <span style="color:#a6e22e">禁用某</span> <span style="color:#a6e22e">Deployment</span> <span style="color:#a6e22e">的</span> <span style="color:#a6e22e">livenessProbe</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">kubectl</span> <span style="color:#a6e22e">patch</span> <span style="color:#a6e22e">deployment</span> <span style="color:#a6e22e">valid</span><span style="color:#f92672">-</span><span style="color:#a6e22e">deployment</span>  <span style="color:#f92672">--</span><span style="color:#a6e22e">type</span> <span style="color:#a6e22e">json</span>   <span style="color:#f92672">-</span><span style="color:#a6e22e">p</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#39;[{&#34;op&#34;: &#34;remove&#34;, &#34;path&#34;: &#34;/spec/template/spec/containers/0/livenessProbe&#34;}]&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">在带位置数组中添加元素</span> 
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">kubectl</span> <span style="color:#a6e22e">patch</span> <span style="color:#a6e22e">sa</span> <span style="color:#66d9ef">default</span> <span style="color:#f92672">--</span><span style="color:#a6e22e">type</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#39;json&#39;</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">p</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#39;[{&#34;op&#34;: &#34;add&#34;, &#34;path&#34;: &#34;/secrets/1&#34;, &#34;value&#34;: {&#34;name&#34;: &#34;whatever&#34; } }]&#39;</span>
</span></span></code></pre></div><h2 id="删除资源"><strong>删除资源</strong><a hidden class="anchor" aria-hidden="true" href="#删除资源">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#a6e22e">kubectl</span> <span style="color:#66d9ef">delete</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">f</span> .<span style="color:#f92672">/</span><span style="color:#a6e22e">pod</span>.<span style="color:#a6e22e">json</span>                                              <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">删除在</span> <span style="color:#a6e22e">pod</span>.<span style="color:#a6e22e">json</span> <span style="color:#a6e22e">中指定的类型和名称的</span> <span style="color:#a6e22e">Pod</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">kubectl</span> <span style="color:#66d9ef">delete</span> <span style="color:#a6e22e">pod</span>,<span style="color:#a6e22e">service</span> <span style="color:#a6e22e">baz</span> <span style="color:#a6e22e">foo</span>                                        <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">删除名称为</span> <span style="color:#e6db74">&#34;baz&#34;</span> <span style="color:#a6e22e">和</span> <span style="color:#e6db74">&#34;foo&#34;</span> <span style="color:#a6e22e">的</span> <span style="color:#a6e22e">Pod</span> <span style="color:#a6e22e">和服务</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">kubectl</span> <span style="color:#66d9ef">delete</span> <span style="color:#a6e22e">pods</span>,<span style="color:#a6e22e">services</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">l</span> <span style="color:#a6e22e">name</span><span style="color:#f92672">=</span><span style="color:#a6e22e">myLabel</span>                              <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">删除包含</span> <span style="color:#a6e22e">name</span><span style="color:#f92672">=</span><span style="color:#a6e22e">myLabel</span> <span style="color:#a6e22e">标签的</span> <span style="color:#a6e22e">pods</span> <span style="color:#a6e22e">和服务</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">kubectl</span> <span style="color:#66d9ef">delete</span> <span style="color:#a6e22e">pods</span>,<span style="color:#a6e22e">services</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">l</span> <span style="color:#a6e22e">name</span><span style="color:#f92672">=</span><span style="color:#a6e22e">myLabel</span> <span style="color:#f92672">--</span><span style="color:#a6e22e">include</span><span style="color:#f92672">-</span><span style="color:#a6e22e">uninitialized</span>      <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">删除包含</span> <span style="color:#a6e22e">label</span> <span style="color:#a6e22e">name</span><span style="color:#f92672">=</span><span style="color:#a6e22e">myLabel</span> <span style="color:#a6e22e">标签的</span> <span style="color:#a6e22e">Pods</span> <span style="color:#a6e22e">和服务</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">kubectl</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">n</span> <span style="color:#a6e22e">my</span><span style="color:#f92672">-</span><span style="color:#a6e22e">ns</span> <span style="color:#66d9ef">delete</span> <span style="color:#a6e22e">po</span>,<span style="color:#a6e22e">svc</span> <span style="color:#f92672">--</span><span style="color:#a6e22e">all</span>                                      <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">删除在</span> <span style="color:#a6e22e">my</span><span style="color:#f92672">-</span><span style="color:#a6e22e">ns</span> <span style="color:#a6e22e">名字空间中全部的</span> <span style="color:#a6e22e">Pods</span> <span style="color:#a6e22e">和服务</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">删除所有与</span> <span style="color:#a6e22e">pattern1</span> <span style="color:#a6e22e">或</span> <span style="color:#a6e22e">pattern2</span> <span style="color:#a6e22e">awk</span> <span style="color:#a6e22e">模式匹配的</span> <span style="color:#a6e22e">Pods</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">kubectl</span> <span style="color:#a6e22e">get</span> <span style="color:#a6e22e">pods</span>  <span style="color:#f92672">-</span><span style="color:#a6e22e">n</span> <span style="color:#a6e22e">mynamespace</span> <span style="color:#f92672">--</span><span style="color:#a6e22e">no</span><span style="color:#f92672">-</span><span style="color:#a6e22e">headers</span><span style="color:#f92672">=</span><span style="color:#66d9ef">true</span> <span style="color:#f92672">|</span> <span style="color:#a6e22e">awk</span> <span style="color:#e6db74">&#39;/pattern1|pattern2/{print $1}&#39;</span> <span style="color:#f92672">|</span> <span style="color:#a6e22e">xargs</span>  <span style="color:#a6e22e">kubectl</span> <span style="color:#66d9ef">delete</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">n</span> <span style="color:#a6e22e">mynamespace</span> <span style="color:#a6e22e">pod</span>
</span></span></code></pre></div><h2 id="pod常用操作"><strong>Pod常用操作</strong><a hidden class="anchor" aria-hidden="true" href="#pod常用操作">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#a6e22e">kubectl</span> <span style="color:#a6e22e">logs</span> <span style="color:#a6e22e">my</span><span style="color:#f92672">-</span><span style="color:#a6e22e">pod</span>                                 <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">获取</span> <span style="color:#a6e22e">pod</span> <span style="color:#a6e22e">日志</span><span style="color:#960050;background-color:#1e0010">（</span><span style="color:#a6e22e">标准输出</span><span style="color:#960050;background-color:#1e0010">）</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">kubectl</span> <span style="color:#a6e22e">logs</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">l</span> <span style="color:#a6e22e">name</span><span style="color:#f92672">=</span><span style="color:#a6e22e">myLabel</span>                        <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">获取含</span> <span style="color:#a6e22e">name</span><span style="color:#f92672">=</span><span style="color:#a6e22e">myLabel</span> <span style="color:#a6e22e">标签的</span> <span style="color:#a6e22e">Pods</span> <span style="color:#a6e22e">的日志</span><span style="color:#960050;background-color:#1e0010">（</span><span style="color:#a6e22e">标准输出</span><span style="color:#960050;background-color:#1e0010">）</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">kubectl</span> <span style="color:#a6e22e">logs</span> <span style="color:#a6e22e">my</span><span style="color:#f92672">-</span><span style="color:#a6e22e">pod</span> <span style="color:#f92672">--</span><span style="color:#a6e22e">previous</span>                      <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">获取上个容器实例的</span> <span style="color:#a6e22e">pod</span> <span style="color:#a6e22e">日志</span><span style="color:#960050;background-color:#1e0010">（</span><span style="color:#a6e22e">标准输出</span><span style="color:#960050;background-color:#1e0010">）</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">kubectl</span> <span style="color:#a6e22e">logs</span> <span style="color:#a6e22e">my</span><span style="color:#f92672">-</span><span style="color:#a6e22e">pod</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">c</span> <span style="color:#a6e22e">my</span><span style="color:#f92672">-</span><span style="color:#a6e22e">container</span>                 <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">获取</span> <span style="color:#a6e22e">Pod</span> <span style="color:#a6e22e">容器的日志</span><span style="color:#960050;background-color:#1e0010">（</span><span style="color:#a6e22e">标准输出</span>, <span style="color:#a6e22e">多容器场景</span><span style="color:#960050;background-color:#1e0010">）</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">kubectl</span> <span style="color:#a6e22e">logs</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">l</span> <span style="color:#a6e22e">name</span><span style="color:#f92672">=</span><span style="color:#a6e22e">myLabel</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">c</span> <span style="color:#a6e22e">my</span><span style="color:#f92672">-</span><span style="color:#a6e22e">container</span>        <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">获取含</span> <span style="color:#a6e22e">name</span><span style="color:#f92672">=</span><span style="color:#a6e22e">myLabel</span> <span style="color:#a6e22e">标签的</span> <span style="color:#a6e22e">Pod</span> <span style="color:#a6e22e">容器日志</span><span style="color:#960050;background-color:#1e0010">（</span><span style="color:#a6e22e">标准输出</span>, <span style="color:#a6e22e">多容器场景</span><span style="color:#960050;background-color:#1e0010">）</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">kubectl</span> <span style="color:#a6e22e">logs</span> <span style="color:#a6e22e">my</span><span style="color:#f92672">-</span><span style="color:#a6e22e">pod</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">c</span> <span style="color:#a6e22e">my</span><span style="color:#f92672">-</span><span style="color:#a6e22e">container</span> <span style="color:#f92672">--</span><span style="color:#a6e22e">previous</span>      <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">获取</span> <span style="color:#a6e22e">Pod</span> <span style="color:#a6e22e">中某容器的上个实例的日志</span><span style="color:#960050;background-color:#1e0010">（</span><span style="color:#a6e22e">标准输出</span>, <span style="color:#a6e22e">多容器场景</span><span style="color:#960050;background-color:#1e0010">）</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">kubectl</span> <span style="color:#a6e22e">logs</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">f</span> <span style="color:#a6e22e">my</span><span style="color:#f92672">-</span><span style="color:#a6e22e">pod</span>                              <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">流式输出</span> <span style="color:#a6e22e">Pod</span> <span style="color:#a6e22e">的日志</span><span style="color:#960050;background-color:#1e0010">（</span><span style="color:#a6e22e">标准输出</span><span style="color:#960050;background-color:#1e0010">）</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">kubectl</span> <span style="color:#a6e22e">logs</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">f</span> <span style="color:#a6e22e">my</span><span style="color:#f92672">-</span><span style="color:#a6e22e">pod</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">c</span> <span style="color:#a6e22e">my</span><span style="color:#f92672">-</span><span style="color:#a6e22e">container</span>              <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">流式输出</span> <span style="color:#a6e22e">Pod</span> <span style="color:#a6e22e">容器的日志</span><span style="color:#960050;background-color:#1e0010">（</span><span style="color:#a6e22e">标准输出</span>, <span style="color:#a6e22e">多容器场景</span><span style="color:#960050;background-color:#1e0010">）</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">kubectl</span> <span style="color:#a6e22e">logs</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">f</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">l</span> <span style="color:#a6e22e">name</span><span style="color:#f92672">=</span><span style="color:#a6e22e">myLabel</span> <span style="color:#f92672">--</span><span style="color:#a6e22e">all</span><span style="color:#f92672">-</span><span style="color:#a6e22e">containers</span>    <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">流式输出含</span> <span style="color:#a6e22e">name</span><span style="color:#f92672">=</span><span style="color:#a6e22e">myLabel</span> <span style="color:#a6e22e">标签的</span> <span style="color:#a6e22e">Pod</span> <span style="color:#a6e22e">的所有日志</span><span style="color:#960050;background-color:#1e0010">（</span><span style="color:#a6e22e">标准输出</span><span style="color:#960050;background-color:#1e0010">）</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">kubectl</span> <span style="color:#a6e22e">run</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">i</span> <span style="color:#f92672">--</span><span style="color:#a6e22e">tty</span> <span style="color:#a6e22e">busybox</span> <span style="color:#f92672">--</span><span style="color:#a6e22e">image</span><span style="color:#f92672">=</span><span style="color:#a6e22e">busybox</span> <span style="color:#f92672">--</span> <span style="color:#a6e22e">sh</span>  <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">以交互式</span> <span style="color:#a6e22e">Shell</span> <span style="color:#a6e22e">运行</span> <span style="color:#a6e22e">Pod</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">kubectl</span> <span style="color:#a6e22e">run</span> <span style="color:#a6e22e">nginx</span> <span style="color:#f92672">--</span><span style="color:#a6e22e">image</span><span style="color:#f92672">=</span><span style="color:#a6e22e">nginx</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">n</span> <span style="color:#a6e22e">mynamespace</span>      <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">在指定名字空间中运行</span> <span style="color:#a6e22e">nginx</span> <span style="color:#a6e22e">Pod</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">kubectl</span> <span style="color:#a6e22e">run</span> <span style="color:#a6e22e">nginx</span> <span style="color:#f92672">--</span><span style="color:#a6e22e">image</span><span style="color:#f92672">=</span><span style="color:#a6e22e">nginx</span>                     <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">运行</span> <span style="color:#a6e22e">ngins</span> <span style="color:#a6e22e">Pod</span> <span style="color:#a6e22e">并将其规约写入到名为</span> <span style="color:#a6e22e">pod</span>.<span style="color:#a6e22e">yaml</span> <span style="color:#a6e22e">的文件</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">--</span><span style="color:#a6e22e">dry</span><span style="color:#f92672">-</span><span style="color:#a6e22e">run</span><span style="color:#f92672">=</span><span style="color:#a6e22e">client</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">o</span> <span style="color:#a6e22e">yaml</span> <span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">pod</span>.<span style="color:#a6e22e">yaml</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">kubectl</span> <span style="color:#a6e22e">attach</span> <span style="color:#a6e22e">my</span><span style="color:#f92672">-</span><span style="color:#a6e22e">pod</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">i</span>                            <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">挂接到一个运行的容器中</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">kubectl</span> <span style="color:#a6e22e">port</span><span style="color:#f92672">-</span><span style="color:#a6e22e">forward</span> <span style="color:#a6e22e">my</span><span style="color:#f92672">-</span><span style="color:#a6e22e">pod</span> <span style="color:#ae81ff">5000</span><span style="color:#f92672">:</span><span style="color:#ae81ff">6000</span>               <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">在本地计算机上侦听端口</span> <span style="color:#ae81ff">5000</span> <span style="color:#a6e22e">并转发到</span> <span style="color:#a6e22e">my</span><span style="color:#f92672">-</span><span style="color:#a6e22e">pod</span> <span style="color:#a6e22e">上的端口</span> <span style="color:#ae81ff">6000</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">kubectl</span> <span style="color:#a6e22e">exec</span> <span style="color:#a6e22e">my</span><span style="color:#f92672">-</span><span style="color:#a6e22e">pod</span> <span style="color:#f92672">--</span> <span style="color:#a6e22e">ls</span> <span style="color:#f92672">/</span>                         <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">在已有的</span> <span style="color:#a6e22e">Pod</span> <span style="color:#a6e22e">中运行命令</span><span style="color:#960050;background-color:#1e0010">（</span><span style="color:#a6e22e">单容器场景</span><span style="color:#960050;background-color:#1e0010">）</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">kubectl</span> <span style="color:#a6e22e">exec</span> <span style="color:#a6e22e">my</span><span style="color:#f92672">-</span><span style="color:#a6e22e">pod</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">c</span> <span style="color:#a6e22e">my</span><span style="color:#f92672">-</span><span style="color:#a6e22e">container</span> <span style="color:#f92672">--</span> <span style="color:#a6e22e">ls</span> <span style="color:#f92672">/</span>         <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">在已有的</span> <span style="color:#a6e22e">Pod</span> <span style="color:#a6e22e">中运行命令</span><span style="color:#960050;background-color:#1e0010">（</span><span style="color:#a6e22e">多容器场景</span><span style="color:#960050;background-color:#1e0010">）</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">kubectl</span> <span style="color:#a6e22e">top</span> <span style="color:#a6e22e">pod</span> <span style="color:#a6e22e">POD_NAME</span> <span style="color:#f92672">--</span><span style="color:#a6e22e">containers</span>               <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">显示给定</span> <span style="color:#a6e22e">Pod</span> <span style="color:#a6e22e">和其中容器的监控数据</span>
</span></span></code></pre></div><h2 id="节点操作"><strong>节点操作</strong><a hidden class="anchor" aria-hidden="true" href="#节点操作">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#a6e22e">kubectl</span> <span style="color:#a6e22e">cordon</span> <span style="color:#a6e22e">my</span><span style="color:#f92672">-</span><span style="color:#a6e22e">node</span>                                                <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">标记</span> <span style="color:#a6e22e">my</span><span style="color:#f92672">-</span><span style="color:#a6e22e">node</span> <span style="color:#a6e22e">节点为不可调度</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">kubectl</span> <span style="color:#a6e22e">drain</span> <span style="color:#a6e22e">my</span><span style="color:#f92672">-</span><span style="color:#a6e22e">node</span>                                                 <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">对</span> <span style="color:#a6e22e">my</span><span style="color:#f92672">-</span><span style="color:#a6e22e">node</span> <span style="color:#a6e22e">节点进行清空操作</span><span style="color:#960050;background-color:#1e0010">，</span><span style="color:#a6e22e">为节点维护做准备</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">kubectl</span> <span style="color:#a6e22e">uncordon</span> <span style="color:#a6e22e">my</span><span style="color:#f92672">-</span><span style="color:#a6e22e">node</span>                                              <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">标记</span> <span style="color:#a6e22e">my</span><span style="color:#f92672">-</span><span style="color:#a6e22e">node</span> <span style="color:#a6e22e">节点为可以调度</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">kubectl</span> <span style="color:#a6e22e">top</span> <span style="color:#a6e22e">node</span> <span style="color:#a6e22e">my</span><span style="color:#f92672">-</span><span style="color:#a6e22e">node</span>                                              <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">显示给定节点的度量值</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">kubectl</span> <span style="color:#a6e22e">cluster</span><span style="color:#f92672">-</span><span style="color:#a6e22e">info</span>                                                  <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">显示主控节点和服务的地址</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">kubectl</span> <span style="color:#a6e22e">cluster</span><span style="color:#f92672">-</span><span style="color:#a6e22e">info</span> <span style="color:#a6e22e">dump</span>                                             <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">将当前集群状态转储到标准输出</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">kubectl</span> <span style="color:#a6e22e">cluster</span><span style="color:#f92672">-</span><span style="color:#a6e22e">info</span> <span style="color:#a6e22e">dump</span> <span style="color:#f92672">--</span><span style="color:#a6e22e">output</span><span style="color:#f92672">-</span><span style="color:#a6e22e">directory</span><span style="color:#f92672">=</span><span style="color:#960050;background-color:#1e0010">/path/to/cluster-state   # 将当前集群状态输出到 /path/to/cluster-state</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">如果已存在具有指定键和效果的污点</span><span style="color:#960050;background-color:#1e0010">，</span><span style="color:#a6e22e">则替换其值为指定值</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">kubectl</span> <span style="color:#a6e22e">taint</span> <span style="color:#a6e22e">nodes</span> <span style="color:#a6e22e">foo</span> <span style="color:#a6e22e">dedicated</span><span style="color:#f92672">=</span><span style="color:#a6e22e">special</span><span style="color:#f92672">-</span><span style="color:#a6e22e">user</span><span style="color:#f92672">:</span><span style="color:#a6e22e">NoSchedule</span>
</span></span></code></pre></div><p><strong>格式化输出</strong></p>
<p>要以特定格式将详细信息输出到终端窗口，可以将 -o 或 &ndash;output 参数添加到支持的 kubectl 命令</p>
<table>
<thead>
<tr>
<th style="text-align:left">输出格式</th>
<th style="text-align:left">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">-o=custom-columns=<!-- raw HTML omitted --></td>
<td style="text-align:left">使用逗号分隔的自定义列来打印表格</td>
</tr>
<tr>
<td style="text-align:left">-o=custom-columns-file=<!-- raw HTML omitted --></td>
<td style="text-align:left">使用 <!-- raw HTML omitted --> 文件中的自定义列模板打印表格</td>
</tr>
<tr>
<td style="text-align:left">-o=json</td>
<td style="text-align:left">输出 JSON 格式的 API 对象</td>
</tr>
<tr>
<td style="text-align:left">-o=jsonpath=<!-- raw HTML omitted --></td>
<td style="text-align:left">打印 jsonpath 表达式中定义的字段</td>
</tr>
<tr>
<td style="text-align:left">-o=jsonpath-file=<!-- raw HTML omitted --></td>
<td style="text-align:left">打印在 <!-- raw HTML omitted --> 文件中定义的 jsonpath 表达式所指定的字段。</td>
</tr>
<tr>
<td style="text-align:left">-o=name</td>
<td style="text-align:left">仅打印资源名称而不打印其他内容</td>
</tr>
<tr>
<td style="text-align:left">-o=wide</td>
<td style="text-align:left">以纯文本格式输出额外信息，对于 Pod 来说，输出中包含了节点名称</td>
</tr>
<tr>
<td style="text-align:left">-o=yaml</td>
<td style="text-align:left">输出 YAML 格式的 API 对象</td>
</tr>
</tbody>
</table>
<p>使用 -o=custom-columns 的示例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">集群中运行着的所有镜像</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">kubectl</span> <span style="color:#a6e22e">get</span> <span style="color:#a6e22e">pods</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">A</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">o</span><span style="color:#f92672">=</span><span style="color:#a6e22e">custom</span><span style="color:#f92672">-</span><span style="color:#a6e22e">columns</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#39;DATA:spec.containers[*].image&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">除</span> <span style="color:#e6db74">&#34;k8s.gcr.io/coredns:1.6.2&#34;</span> <span style="color:#a6e22e">之外的所有镜像</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">kubectl</span> <span style="color:#a6e22e">get</span> <span style="color:#a6e22e">pods</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">A</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">o</span><span style="color:#f92672">=</span><span style="color:#a6e22e">custom</span><span style="color:#f92672">-</span><span style="color:#a6e22e">columns</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#39;DATA:spec.containers[?(@.image!=&#34;k8s.gcr.io/coredns:1.6.2&#34;)].image&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">输出</span> <span style="color:#a6e22e">metadata</span> <span style="color:#a6e22e">下面的所有字段</span><span style="color:#960050;background-color:#1e0010">，</span><span style="color:#a6e22e">无论</span> <span style="color:#a6e22e">Pod</span> <span style="color:#a6e22e">名字为何</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">kubectl</span> <span style="color:#a6e22e">get</span> <span style="color:#a6e22e">pods</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">A</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">o</span><span style="color:#f92672">=</span><span style="color:#a6e22e">custom</span><span style="color:#f92672">-</span><span style="color:#a6e22e">columns</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#39;DATA:metadata.*&#39;</span>
</span></span></code></pre></div><h1 id="ndots-search域">ndots search域<a hidden class="anchor" aria-hidden="true" href="#ndots-search域">#</a></h1>
<pre tabindex="0"><code>[root@centos-76f4b54bb5-tph8f /]# cat /etc/resolv.conf    
search default.svc.cluster.local svc.cluster.local cluster.local
nameserver 10.96.0.10
options ndots:5
</code></pre><p>ndots修改</p>
<pre tabindex="0"><code>apiVersion: v1
kind: Pod
metadata:
  namespace: default
  name: dns-example
spec:
  containers:
    - name: test
      image: nginx
  dnsConfig:
    options:
      - name: ndots
        value: &#34;2&#34;
</code></pre><h1 id="附件">附件：<a hidden class="anchor" aria-hidden="true" href="#附件">#</a></h1>
<h3 id="ingress-nginx-serviceyaml">ingress-nginx-service.yaml<a hidden class="anchor" aria-hidden="true" href="#ingress-nginx-serviceyaml">#</a></h3>
<pre tabindex="0"><code>apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: ingress-nginx-service
  namespace: ns-test
  annotations:
    kubernetes.io/ingress.class: nginx
spec:
  tls:

   - hosts:
     - www.test.dev
     - test.dev
       secretName: tls-secret
       rules:

  - host: www.test.dev
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: nginx-service
            port:
              number: 80
  - host: test.dev
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: nginx-service
            port:
              number: 80
</code></pre><h3 id="ingress-grafana-prometheus-serviceyaml">ingress-grafana-prometheus-service.yaml<a hidden class="anchor" aria-hidden="true" href="#ingress-grafana-prometheus-serviceyaml">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">networking.k8s.io/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Ingress</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">ingress-monitoring-service</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">monitoring</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">annotations</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">kubernetes.io/ingress.class</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">tls</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">hosts</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">grafana.test.dev</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">alertmanager.test.dev</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">prometheus.test.dev</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">secretName</span>: <span style="color:#ae81ff">tls-secret</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">rules</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">host</span>: <span style="color:#ae81ff">foobar.com</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">http</span>: <span style="color:#75715e">&amp;http_rules</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">paths</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">backend</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">serviceName</span>: <span style="color:#ae81ff">foobar</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">servicePort</span>: <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">host</span>: <span style="color:#ae81ff">api.foobar.com</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">http</span>: <span style="color:#75715e">*http_rules</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">host</span>: <span style="color:#ae81ff">admin.foobar.com</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">http</span>: <span style="color:#75715e">*http_rules</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">host</span>: <span style="color:#ae81ff">status.foobar.com</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">http</span>: <span style="color:#75715e">*http_rules</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">host</span>: <span style="color:#ae81ff">prometheus.test.dev</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">http</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">paths</span>:
</span></span><span style="display:flex;"><span>          - <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">pathType</span>: <span style="color:#ae81ff">Prefix</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">backend</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">service</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">name</span>: <span style="color:#ae81ff">prometheus-k8s</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">port</span>:
</span></span><span style="display:flex;"><span>                   <span style="color:#f92672">number</span>: <span style="color:#ae81ff">9090</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">host</span>: <span style="color:#ae81ff">alertmanager.test.dev</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">http</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">paths</span>:
</span></span><span style="display:flex;"><span>          - <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">pathType</span>: <span style="color:#ae81ff">Prefix</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">backend</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">service</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">name</span>: <span style="color:#ae81ff">alertmanager-main</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">port</span>:
</span></span><span style="display:flex;"><span>                   <span style="color:#f92672">number</span>: <span style="color:#ae81ff">9093</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">host</span>: <span style="color:#ae81ff">grafana.test.dev</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">http</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">paths</span>:
</span></span><span style="display:flex;"><span>          - <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">pathType</span>: <span style="color:#ae81ff">Prefix</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">backend</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">service</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">name</span>: <span style="color:#ae81ff">grafana</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">port</span>:
</span></span><span style="display:flex;"><span>                   <span style="color:#f92672">number</span>: <span style="color:#ae81ff">3000</span>
</span></span></code></pre></div><h3 id="nginx-deploymentyaml">nginx-deployment.yaml<a hidden class="anchor" aria-hidden="true" href="#nginx-deploymentyaml">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apps/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Deployment</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">ns-test</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx-deployment</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">matchLabels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">app</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">replicas</span>: <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">template</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">app</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">image</span>: <span style="color:#ae81ff">nginx:alpine</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">80</span>
</span></span></code></pre></div><h3 id="nginx-serviceyaml">nginx-service.yaml<a hidden class="anchor" aria-hidden="true" href="#nginx-serviceyaml">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Service</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">ns-test</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx-service</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">protocol</span>: <span style="color:#ae81ff">TCP</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">port</span>: <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">targetPort</span>: <span style="color:#ae81ff">80</span>
</span></span></code></pre></div><h3 id="nginx-minioyaml">nginx-minio.yaml<a hidden class="anchor" aria-hidden="true" href="#nginx-minioyaml">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">networking.k8s.io/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Ingress</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">ingress-minio</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">tenant</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">annotations</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">kubernetes.io/ingress.class</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">nginx.ingress.kubernetes.io/auth-tls-verify-client</span>: <span style="color:#e6db74">&#34;on&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">nginx.ingress.kubernetes.io/auth-tls-pass-certificate-to-upstream</span>: <span style="color:#e6db74">&#34;true&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">nginx.ingress.kubernetes.io/backend-protocol</span>: <span style="color:#e6db74">&#34;HTTPS&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">nginx.ingress.kubernetes.io/proxy-body-size</span>: <span style="color:#ae81ff">1024m</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">nginx.ingress.kubernetes.io/proxy-connect-timeout</span>: <span style="color:#e6db74">&#34;300&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">nginx.ingress.kubernetes.io/proxy-send-timeout</span>: <span style="color:#e6db74">&#34;300&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">nginx.ingress.kubernetes.io/proxy-read-timeout</span>: <span style="color:#e6db74">&#34;300&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">tls</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">hosts</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">minio.test.dev</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">apiminio.test.dev</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">secretName</span>: <span style="color:#ae81ff">test.dev</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">hosts</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">web.minio.test.dev</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">api.minio.test.dev</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">secretName</span>: <span style="color:#ae81ff">minio.test.dev</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">rules</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">host</span>: <span style="color:#ae81ff">minio.test.dev</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">http</span>: <span style="color:#75715e">&amp;web_minio</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">paths</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">pathType</span>: <span style="color:#ae81ff">Prefix</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">backend</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">service</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">name</span>: <span style="color:#ae81ff">tenant1-console</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">port</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">number</span>: <span style="color:#ae81ff">9443</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">host</span>: <span style="color:#ae81ff">web.minio.test.dev</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">http</span>: <span style="color:#75715e">*web_minio</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">host</span>: <span style="color:#ae81ff">apiminio.test.dev</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">http</span>: <span style="color:#75715e">&amp;api_minio</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">paths</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">pathType</span>: <span style="color:#ae81ff">Prefix</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">backend</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">service</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">name</span>: <span style="color:#ae81ff">minio</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">port</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">number</span>: <span style="color:#ae81ff">443</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">host</span>: <span style="color:#ae81ff">api.minio.test.dev</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">http</span>: <span style="color:#75715e">*api_minio</span>
</span></span></code></pre></div><h3 id="redis---rbacyaml">redis - rbac.yaml<a hidden class="anchor" aria-hidden="true" href="#redis---rbacyaml">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">rbac.authorization.k8s.io/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">RoleBinding</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">prometheus-k8s</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">operator-redis-ibm</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">roleRef</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">apiGroup</span>: <span style="color:#ae81ff">rbac.authorization.k8s.io</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Role</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">prometheus-k8s</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">subjects</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ServiceAccount</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">prometheus-k8s</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">monitoring</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">rbac.authorization.k8s.io/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Role</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">prometheus-k8s</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">operator-redis-ibm</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">rules</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">apiGroups</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">resources</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">services</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">endpoints</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">pods</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">verbs</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">get</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">list</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">watch</span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">apiGroups</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">extensions</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">resources</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">ingresses</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">verbs</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">get</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">list</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">watch</span>
</span></span></code></pre></div><h3 id="ingress-nginx-deploy-daemonsetyaml">ingress-nginx-deploy-daemonset.yaml<a hidden class="anchor" aria-hidden="true" href="#ingress-nginx-deploy-daemonsetyaml">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Namespace</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app.kubernetes.io/instance</span>: <span style="color:#ae81ff">ingress-nginx</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app.kubernetes.io/name</span>: <span style="color:#ae81ff">ingress-nginx</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">ingress-nginx</span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">automountServiceAccountToken</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ServiceAccount</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app.kubernetes.io/component</span>: <span style="color:#ae81ff">controller</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app.kubernetes.io/instance</span>: <span style="color:#ae81ff">ingress-nginx</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app.kubernetes.io/name</span>: <span style="color:#ae81ff">ingress-nginx</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app.kubernetes.io/part-of</span>: <span style="color:#ae81ff">ingress-nginx</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app.kubernetes.io/version</span>: <span style="color:#ae81ff">1.3.0</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">ingress-nginx</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">ingress-nginx</span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ServiceAccount</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app.kubernetes.io/component</span>: <span style="color:#ae81ff">admission-webhook</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app.kubernetes.io/instance</span>: <span style="color:#ae81ff">ingress-nginx</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app.kubernetes.io/name</span>: <span style="color:#ae81ff">ingress-nginx</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app.kubernetes.io/part-of</span>: <span style="color:#ae81ff">ingress-nginx</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app.kubernetes.io/version</span>: <span style="color:#ae81ff">1.3.0</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">ingress-nginx-admission</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">ingress-nginx</span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">rbac.authorization.k8s.io/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Role</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app.kubernetes.io/component</span>: <span style="color:#ae81ff">controller</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app.kubernetes.io/instance</span>: <span style="color:#ae81ff">ingress-nginx</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app.kubernetes.io/name</span>: <span style="color:#ae81ff">ingress-nginx</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app.kubernetes.io/part-of</span>: <span style="color:#ae81ff">ingress-nginx</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app.kubernetes.io/version</span>: <span style="color:#ae81ff">1.3.0</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">ingress-nginx</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">ingress-nginx</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">rules</span>:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">apiGroups</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">resources</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">namespaces</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">verbs</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">get</span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">apiGroups</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">resources</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">configmaps</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">pods</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">secrets</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">endpoints</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">verbs</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">get</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">list</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">watch</span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">apiGroups</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">resources</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">services</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">verbs</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">get</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">list</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">watch</span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">apiGroups</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">networking.k8s.io</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">resources</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">ingresses</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">verbs</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">get</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">list</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">watch</span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">apiGroups</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">networking.k8s.io</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">resources</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">ingresses/status</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">verbs</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">update</span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">apiGroups</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">networking.k8s.io</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">resources</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">ingressclasses</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">verbs</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">get</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">list</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">watch</span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">apiGroups</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">resourceNames</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">ingress-controller-leader</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">resources</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">configmaps</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">verbs</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">get</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">update</span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">apiGroups</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">resources</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">configmaps</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">verbs</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">create</span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">apiGroups</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">coordination.k8s.io</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">resourceNames</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">ingress-controller-leader</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">resources</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">leases</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">verbs</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">get</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">update</span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">apiGroups</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">coordination.k8s.io</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">resources</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">leases</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">verbs</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">create</span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">apiGroups</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">resources</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">events</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">verbs</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">create</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">patch</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">rbac.authorization.k8s.io/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Role</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app.kubernetes.io/component</span>: <span style="color:#ae81ff">admission-webhook</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app.kubernetes.io/instance</span>: <span style="color:#ae81ff">ingress-nginx</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app.kubernetes.io/name</span>: <span style="color:#ae81ff">ingress-nginx</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app.kubernetes.io/part-of</span>: <span style="color:#ae81ff">ingress-nginx</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app.kubernetes.io/version</span>: <span style="color:#ae81ff">1.3.0</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">ingress-nginx-admission</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">ingress-nginx</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">rules</span>:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">apiGroups</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">resources</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">secrets</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">verbs</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">get</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">create</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">rbac.authorization.k8s.io/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ClusterRole</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app.kubernetes.io/instance</span>: <span style="color:#ae81ff">ingress-nginx</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app.kubernetes.io/name</span>: <span style="color:#ae81ff">ingress-nginx</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app.kubernetes.io/part-of</span>: <span style="color:#ae81ff">ingress-nginx</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app.kubernetes.io/version</span>: <span style="color:#ae81ff">1.3.0</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">ingress-nginx</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">rules</span>:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">apiGroups</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">resources</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">configmaps</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">endpoints</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">nodes</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">pods</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">secrets</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">namespaces</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">verbs</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">list</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">watch</span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">apiGroups</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">coordination.k8s.io</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">resources</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">leases</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">verbs</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">list</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">watch</span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">apiGroups</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">resources</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">nodes</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">verbs</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">get</span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">apiGroups</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">resources</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">services</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">verbs</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">get</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">list</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">watch</span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">apiGroups</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">networking.k8s.io</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">resources</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">ingresses</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">verbs</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">get</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">list</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">watch</span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">apiGroups</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">resources</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">events</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">verbs</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">create</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">patch</span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">apiGroups</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">networking.k8s.io</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">resources</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">ingresses/status</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">verbs</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">update</span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">apiGroups</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">networking.k8s.io</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">resources</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">ingressclasses</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">verbs</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">get</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">list</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">watch</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">rbac.authorization.k8s.io/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ClusterRole</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app.kubernetes.io/component</span>: <span style="color:#ae81ff">admission-webhook</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app.kubernetes.io/instance</span>: <span style="color:#ae81ff">ingress-nginx</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app.kubernetes.io/name</span>: <span style="color:#ae81ff">ingress-nginx</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app.kubernetes.io/part-of</span>: <span style="color:#ae81ff">ingress-nginx</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app.kubernetes.io/version</span>: <span style="color:#ae81ff">1.3.0</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">ingress-nginx-admission</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">rules</span>:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">apiGroups</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">admissionregistration.k8s.io</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">resources</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">validatingwebhookconfigurations</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">verbs</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">get</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">update</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">rbac.authorization.k8s.io/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">RoleBinding</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app.kubernetes.io/component</span>: <span style="color:#ae81ff">controller</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app.kubernetes.io/instance</span>: <span style="color:#ae81ff">ingress-nginx</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app.kubernetes.io/name</span>: <span style="color:#ae81ff">ingress-nginx</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app.kubernetes.io/part-of</span>: <span style="color:#ae81ff">ingress-nginx</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app.kubernetes.io/version</span>: <span style="color:#ae81ff">1.3.0</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">ingress-nginx</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">ingress-nginx</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">roleRef</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">apiGroup</span>: <span style="color:#ae81ff">rbac.authorization.k8s.io</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Role</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">ingress-nginx</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">subjects</span>:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ServiceAccount</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">ingress-nginx</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">ingress-nginx</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">rbac.authorization.k8s.io/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">RoleBinding</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app.kubernetes.io/component</span>: <span style="color:#ae81ff">admission-webhook</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app.kubernetes.io/instance</span>: <span style="color:#ae81ff">ingress-nginx</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app.kubernetes.io/name</span>: <span style="color:#ae81ff">ingress-nginx</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app.kubernetes.io/part-of</span>: <span style="color:#ae81ff">ingress-nginx</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app.kubernetes.io/version</span>: <span style="color:#ae81ff">1.3.0</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">ingress-nginx-admission</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">ingress-nginx</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">roleRef</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">apiGroup</span>: <span style="color:#ae81ff">rbac.authorization.k8s.io</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Role</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">ingress-nginx-admission</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">subjects</span>:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ServiceAccount</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">ingress-nginx-admission</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">ingress-nginx</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">rbac.authorization.k8s.io/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ClusterRoleBinding</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app.kubernetes.io/instance</span>: <span style="color:#ae81ff">ingress-nginx</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app.kubernetes.io/name</span>: <span style="color:#ae81ff">ingress-nginx</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app.kubernetes.io/part-of</span>: <span style="color:#ae81ff">ingress-nginx</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app.kubernetes.io/version</span>: <span style="color:#ae81ff">1.3.0</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">ingress-nginx</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">roleRef</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">apiGroup</span>: <span style="color:#ae81ff">rbac.authorization.k8s.io</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ClusterRole</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">ingress-nginx</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">subjects</span>:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ServiceAccount</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">ingress-nginx</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">ingress-nginx</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">rbac.authorization.k8s.io/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ClusterRoleBinding</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app.kubernetes.io/component</span>: <span style="color:#ae81ff">admission-webhook</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app.kubernetes.io/instance</span>: <span style="color:#ae81ff">ingress-nginx</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app.kubernetes.io/name</span>: <span style="color:#ae81ff">ingress-nginx</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app.kubernetes.io/part-of</span>: <span style="color:#ae81ff">ingress-nginx</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app.kubernetes.io/version</span>: <span style="color:#ae81ff">1.3.0</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">ingress-nginx-admission</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">roleRef</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">apiGroup</span>: <span style="color:#ae81ff">rbac.authorization.k8s.io</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ClusterRole</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">ingress-nginx-admission</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">subjects</span>:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ServiceAccount</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">ingress-nginx-admission</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">ingress-nginx</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">data</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">allow-snippet-annotations</span>: <span style="color:#e6db74">&#34;true&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ConfigMap</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app.kubernetes.io/component</span>: <span style="color:#ae81ff">controller</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app.kubernetes.io/instance</span>: <span style="color:#ae81ff">ingress-nginx</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app.kubernetes.io/name</span>: <span style="color:#ae81ff">ingress-nginx</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app.kubernetes.io/part-of</span>: <span style="color:#ae81ff">ingress-nginx</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app.kubernetes.io/version</span>: <span style="color:#ae81ff">1.3.0</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">ingress-nginx-controller</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">ingress-nginx</span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Service</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app.kubernetes.io/component</span>: <span style="color:#ae81ff">controller</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app.kubernetes.io/instance</span>: <span style="color:#ae81ff">ingress-nginx</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app.kubernetes.io/name</span>: <span style="color:#ae81ff">ingress-nginx</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app.kubernetes.io/part-of</span>: <span style="color:#ae81ff">ingress-nginx</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app.kubernetes.io/version</span>: <span style="color:#ae81ff">1.3.0</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">ingress-nginx-controller</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">ingress-nginx</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">externalTrafficPolicy</span>: <span style="color:#ae81ff">Local</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">appProtocol</span>: <span style="color:#ae81ff">http</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">http</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">port</span>: <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">protocol</span>: <span style="color:#ae81ff">TCP</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">targetPort</span>: <span style="color:#ae81ff">http</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">appProtocol</span>: <span style="color:#ae81ff">https</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">https</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">port</span>: <span style="color:#ae81ff">443</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">protocol</span>: <span style="color:#ae81ff">TCP</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">targetPort</span>: <span style="color:#ae81ff">https</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app.kubernetes.io/component</span>: <span style="color:#ae81ff">controller</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app.kubernetes.io/instance</span>: <span style="color:#ae81ff">ingress-nginx</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app.kubernetes.io/name</span>: <span style="color:#ae81ff">ingress-nginx</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">type</span>: <span style="color:#ae81ff">LoadBalancer</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Service</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app.kubernetes.io/component</span>: <span style="color:#ae81ff">controller</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app.kubernetes.io/instance</span>: <span style="color:#ae81ff">ingress-nginx</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app.kubernetes.io/name</span>: <span style="color:#ae81ff">ingress-nginx</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app.kubernetes.io/part-of</span>: <span style="color:#ae81ff">ingress-nginx</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app.kubernetes.io/version</span>: <span style="color:#ae81ff">1.3.0</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">ingress-nginx-controller-admission</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">ingress-nginx</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">appProtocol</span>: <span style="color:#ae81ff">https</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">https-webhook</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">port</span>: <span style="color:#ae81ff">443</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">targetPort</span>: <span style="color:#ae81ff">webhook</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app.kubernetes.io/component</span>: <span style="color:#ae81ff">controller</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app.kubernetes.io/instance</span>: <span style="color:#ae81ff">ingress-nginx</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app.kubernetes.io/name</span>: <span style="color:#ae81ff">ingress-nginx</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">type</span>: <span style="color:#ae81ff">ClusterIP</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apps/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">DaemonSet</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app.kubernetes.io/component</span>: <span style="color:#ae81ff">controller</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app.kubernetes.io/instance</span>: <span style="color:#ae81ff">ingress-nginx</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app.kubernetes.io/name</span>: <span style="color:#ae81ff">ingress-nginx</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app.kubernetes.io/part-of</span>: <span style="color:#ae81ff">ingress-nginx</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app.kubernetes.io/version</span>: <span style="color:#ae81ff">1.3.0</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">ingress-nginx-controller</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">ingress-nginx</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">minReadySeconds</span>: <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">revisionHistoryLimit</span>: <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">matchLabels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">app.kubernetes.io/component</span>: <span style="color:#ae81ff">controller</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">app.kubernetes.io/instance</span>: <span style="color:#ae81ff">ingress-nginx</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">app.kubernetes.io/name</span>: <span style="color:#ae81ff">ingress-nginx</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">template</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">app.kubernetes.io/component</span>: <span style="color:#ae81ff">controller</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">app.kubernetes.io/instance</span>: <span style="color:#ae81ff">ingress-nginx</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">app.kubernetes.io/name</span>: <span style="color:#ae81ff">ingress-nginx</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">annotations</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">prometheus.io/port</span>: <span style="color:#e6db74">&#39;10254&#39;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">prometheus.io/scrape</span>: <span style="color:#e6db74">&#39;true&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">args</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#ae81ff">/nginx-ingress-controller</span>
</span></span><span style="display:flex;"><span>        - --<span style="color:#ae81ff">publish-service=$(POD_NAMESPACE)/ingress-nginx-controller</span>
</span></span><span style="display:flex;"><span>        - --<span style="color:#ae81ff">election-id=ingress-controller-leader</span>
</span></span><span style="display:flex;"><span>        - --<span style="color:#ae81ff">controller-class=k8s.io/ingress-nginx</span>
</span></span><span style="display:flex;"><span>        - --<span style="color:#ae81ff">ingress-class=nginx</span>
</span></span><span style="display:flex;"><span>        - --<span style="color:#ae81ff">configmap=$(POD_NAMESPACE)/ingress-nginx-controller</span>
</span></span><span style="display:flex;"><span>        - --<span style="color:#ae81ff">validating-webhook=:8443</span>
</span></span><span style="display:flex;"><span>        - --<span style="color:#ae81ff">validating-webhook-certificate=/usr/local/certificates/cert</span>
</span></span><span style="display:flex;"><span>        - --<span style="color:#ae81ff">validating-webhook-key=/usr/local/certificates/key</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">env</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">POD_NAME</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">valueFrom</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">fieldRef</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">fieldPath</span>: <span style="color:#ae81ff">metadata.name</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">POD_NAMESPACE</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">valueFrom</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">fieldRef</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">fieldPath</span>: <span style="color:#ae81ff">metadata.namespace</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">LD_PRELOAD</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">value</span>: <span style="color:#ae81ff">/usr/local/lib/libmimalloc.so</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">image</span>: <span style="color:#ae81ff">anjia0532/google-containers.ingress-nginx.controller:v1.3.0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">imagePullPolicy</span>: <span style="color:#ae81ff">IfNotPresent</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">lifecycle</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">preStop</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">exec</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">command</span>:
</span></span><span style="display:flex;"><span>              - <span style="color:#ae81ff">/wait-shutdown</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">livenessProbe</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">failureThreshold</span>: <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">httpGet</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/healthz</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">port</span>: <span style="color:#ae81ff">10254</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">scheme</span>: <span style="color:#ae81ff">HTTP</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">initialDelaySeconds</span>: <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">periodSeconds</span>: <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">successThreshold</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">timeoutSeconds</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">name</span>: <span style="color:#ae81ff">controller</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">name</span>: <span style="color:#ae81ff">http</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">protocol</span>: <span style="color:#ae81ff">TCP</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">443</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">name</span>: <span style="color:#ae81ff">https</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">protocol</span>: <span style="color:#ae81ff">TCP</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">8443</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">name</span>: <span style="color:#ae81ff">webhook</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">protocol</span>: <span style="color:#ae81ff">TCP</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">readinessProbe</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">failureThreshold</span>: <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">httpGet</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/healthz</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">port</span>: <span style="color:#ae81ff">10254</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">scheme</span>: <span style="color:#ae81ff">HTTP</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">initialDelaySeconds</span>: <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">periodSeconds</span>: <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">successThreshold</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">timeoutSeconds</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">resources</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">requests</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">cpu</span>: <span style="color:#ae81ff">100m</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">memory</span>: <span style="color:#ae81ff">90Mi</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">securityContext</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">allowPrivilegeEscalation</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">capabilities</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">add</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#ae81ff">NET_BIND_SERVICE</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">drop</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#ae81ff">ALL</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">runAsUser</span>: <span style="color:#ae81ff">101</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">volumeMounts</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/usr/local/certificates/</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">name</span>: <span style="color:#ae81ff">webhook-cert</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">readOnly</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">hostNetwork</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">dnsPolicy</span>: <span style="color:#ae81ff">ClusterFirst</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">nodeSelector</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">edgenode</span>: <span style="color:#e6db74">&#39;true&#39;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">serviceAccountName</span>: <span style="color:#ae81ff">ingress-nginx</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">terminationGracePeriodSeconds</span>: <span style="color:#ae81ff">300</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">volumes</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">webhook-cert</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">secret</span>:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">secretName</span>: <span style="color:#ae81ff">ingress-nginx-admission</span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">batch/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Job</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app.kubernetes.io/component</span>: <span style="color:#ae81ff">admission-webhook</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app.kubernetes.io/instance</span>: <span style="color:#ae81ff">ingress-nginx</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app.kubernetes.io/name</span>: <span style="color:#ae81ff">ingress-nginx</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app.kubernetes.io/part-of</span>: <span style="color:#ae81ff">ingress-nginx</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app.kubernetes.io/version</span>: <span style="color:#ae81ff">1.3.0</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">ingress-nginx-admission-create</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">ingress-nginx</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">template</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">app.kubernetes.io/component</span>: <span style="color:#ae81ff">admission-webhook</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">app.kubernetes.io/instance</span>: <span style="color:#ae81ff">ingress-nginx</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">app.kubernetes.io/name</span>: <span style="color:#ae81ff">ingress-nginx</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">app.kubernetes.io/part-of</span>: <span style="color:#ae81ff">ingress-nginx</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">app.kubernetes.io/version</span>: <span style="color:#ae81ff">1.3.0</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">name</span>: <span style="color:#ae81ff">ingress-nginx-admission-create</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">args</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#ae81ff">create</span>
</span></span><span style="display:flex;"><span>        - --<span style="color:#ae81ff">host=ingress-nginx-controller-admission,ingress-nginx-controller-admission.$(POD_NAMESPACE).svc</span>
</span></span><span style="display:flex;"><span>        - --<span style="color:#ae81ff">namespace=$(POD_NAMESPACE)</span>
</span></span><span style="display:flex;"><span>        - --<span style="color:#ae81ff">secret-name=ingress-nginx-admission</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">env</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">POD_NAMESPACE</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">valueFrom</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">fieldRef</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">fieldPath</span>: <span style="color:#ae81ff">metadata.namespace</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">image</span>: <span style="color:#ae81ff">anjia0532/google-containers.ingress-nginx.kube-webhook-certgen:v1.1.1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">imagePullPolicy</span>: <span style="color:#ae81ff">IfNotPresent</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">name</span>: <span style="color:#ae81ff">create</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">securityContext</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">allowPrivilegeEscalation</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">nodeSelector</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">kubernetes.io/os</span>: <span style="color:#ae81ff">linux</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">restartPolicy</span>: <span style="color:#ae81ff">OnFailure</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">securityContext</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">fsGroup</span>: <span style="color:#ae81ff">2000</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">runAsNonRoot</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">runAsUser</span>: <span style="color:#ae81ff">2000</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">serviceAccountName</span>: <span style="color:#ae81ff">ingress-nginx-admission</span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">batch/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Job</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app.kubernetes.io/component</span>: <span style="color:#ae81ff">admission-webhook</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app.kubernetes.io/instance</span>: <span style="color:#ae81ff">ingress-nginx</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app.kubernetes.io/name</span>: <span style="color:#ae81ff">ingress-nginx</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app.kubernetes.io/part-of</span>: <span style="color:#ae81ff">ingress-nginx</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app.kubernetes.io/version</span>: <span style="color:#ae81ff">1.3.0</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">ingress-nginx-admission-patch</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">ingress-nginx</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">template</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">app.kubernetes.io/component</span>: <span style="color:#ae81ff">admission-webhook</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">app.kubernetes.io/instance</span>: <span style="color:#ae81ff">ingress-nginx</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">app.kubernetes.io/name</span>: <span style="color:#ae81ff">ingress-nginx</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">app.kubernetes.io/part-of</span>: <span style="color:#ae81ff">ingress-nginx</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">app.kubernetes.io/version</span>: <span style="color:#ae81ff">1.3.0</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">name</span>: <span style="color:#ae81ff">ingress-nginx-admission-patch</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">args</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#ae81ff">patch</span>
</span></span><span style="display:flex;"><span>        - --<span style="color:#ae81ff">webhook-name=ingress-nginx-admission</span>
</span></span><span style="display:flex;"><span>        - --<span style="color:#ae81ff">namespace=$(POD_NAMESPACE)</span>
</span></span><span style="display:flex;"><span>        - --<span style="color:#ae81ff">patch-mutating=false</span>
</span></span><span style="display:flex;"><span>        - --<span style="color:#ae81ff">secret-name=ingress-nginx-admission</span>
</span></span><span style="display:flex;"><span>        - --<span style="color:#ae81ff">patch-failure-policy=Fail</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">env</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">POD_NAMESPACE</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">valueFrom</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">fieldRef</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">fieldPath</span>: <span style="color:#ae81ff">metadata.namespace</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">image</span>: <span style="color:#ae81ff">anjia0532/google-containers.ingress-nginx.kube-webhook-certgen:v1.1.1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">imagePullPolicy</span>: <span style="color:#ae81ff">IfNotPresent</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">name</span>: <span style="color:#ae81ff">patch</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">securityContext</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">allowPrivilegeEscalation</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">nodeSelector</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">kubernetes.io/os</span>: <span style="color:#ae81ff">linux</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">restartPolicy</span>: <span style="color:#ae81ff">OnFailure</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">securityContext</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">fsGroup</span>: <span style="color:#ae81ff">2000</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">runAsNonRoot</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">runAsUser</span>: <span style="color:#ae81ff">2000</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">serviceAccountName</span>: <span style="color:#ae81ff">ingress-nginx-admission</span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">networking.k8s.io/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">IngressClass</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app.kubernetes.io/component</span>: <span style="color:#ae81ff">controller</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app.kubernetes.io/instance</span>: <span style="color:#ae81ff">ingress-nginx</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app.kubernetes.io/name</span>: <span style="color:#ae81ff">ingress-nginx</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app.kubernetes.io/part-of</span>: <span style="color:#ae81ff">ingress-nginx</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app.kubernetes.io/version</span>: <span style="color:#ae81ff">1.3.0</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">controller</span>: <span style="color:#ae81ff">k8s.io/ingress-nginx</span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">admissionregistration.k8s.io/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ValidatingWebhookConfiguration</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app.kubernetes.io/component</span>: <span style="color:#ae81ff">admission-webhook</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app.kubernetes.io/instance</span>: <span style="color:#ae81ff">ingress-nginx</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app.kubernetes.io/name</span>: <span style="color:#ae81ff">ingress-nginx</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app.kubernetes.io/part-of</span>: <span style="color:#ae81ff">ingress-nginx</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app.kubernetes.io/version</span>: <span style="color:#ae81ff">1.3.0</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">ingress-nginx-admission</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">webhooks</span>:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">admissionReviewVersions</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">clientConfig</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">service</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">name</span>: <span style="color:#ae81ff">ingress-nginx-controller-admission</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">ingress-nginx</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/networking/v1/ingresses</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">failurePolicy</span>: <span style="color:#ae81ff">Fail</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">matchPolicy</span>: <span style="color:#ae81ff">Equivalent</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">validate.nginx.ingress.kubernetes.io</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">rules</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">apiGroups</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">networking.k8s.io</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">apiVersions</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">operations</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">CREATE</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">UPDATE</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">resources</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">ingresses</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">sideEffects</span>: <span style="color:#ae81ff">None</span>
</span></span></code></pre></div>

  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2023 <a href="https://cyberzz.dev/">cyberzz.dev</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
